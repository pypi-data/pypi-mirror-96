
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta charset="utf-8" />
    <title>spike.plugins.Peaks &#8212; spike 0.99.21-490 documentation</title>
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for spike.plugins.Peaks</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python </span>
<span class="c1"># encoding: utf-8</span>

<span class="sd">&quot;&quot;&quot;set of function for Peak detections and display - 1D and 2D</span>

<span class="sd">Very First functionnal - Not finished !</span>


<span class="sd">Peak1D and Peak2D are simple objects</span>
<span class="sd">    with attributes like Id, label, intens(ity), pos(ition), or width</span>
<span class="sd">    the only added method is report() (returns a string)</span>

<span class="sd">Peak1DList and Peak2DList are python list, with a few added methods</span>
<span class="sd">    - report (to stdio or to a file)</span>
<span class="sd">    - largest sort in decreasing order of intensity</span>
<span class="sd">        other sorts can simply done by peaklist.sort(key = lambda p: p.XXX)</span>
<span class="sd">            where XXX is any peak attribute  (see largest code)</span>

<span class="sd">Example of usage:</span>

<span class="sd"># assuming d is a 2D NPKData / 1D will be just as simple</span>
<span class="sd">d.pp()          # computes a peak picking over the whole spectrum using 3 x standard_deviation(d)</span>
<span class="sd">                # This is just a detection of all local maxima</span>

<span class="sd"># We can be more specific:</span>
<span class="sd">d.pp(threshold=5E5, zoom=((700,1050),(300,350)) )     # zoom is always in the currently active unit, defined with d.unit</span>

<span class="sd"># this attached the peak list to the dataset as d.peaks,</span>
<span class="sd"># it is a list of Peaks2D objects, with some added properties</span>
<span class="sd">print( &quot;number of detected peaks: %d&quot; % len(d.peaks))</span>

<span class="sd">p0 = d.peaks[0]     # peaks have label, intensity and positions attributes</span>

<span class="sd">print( p0.report() )        # and a report method</span>
<span class="sd">                            # report has an additional format parameter which enables control on the output</span>

<span class="sd"># we can call centroid to improve the accuracy and move the position to center of a fitted (2D) parabola</span>
<span class="sd">d.centroid()     </span>


<span class="sd"># The peak list can be displayed on screen as simple crosses</span>
<span class="sd">d.display_peaks()</span>

<span class="sd"># The label can be modififed for specific purposes:</span>
<span class="sd">for p in d.peaks:</span>
<span class="sd">    if 150 &lt; p.posF2 &lt; 1500 :</span>
<span class="sd">        p.label = &quot;%.2f x %.f&quot;%(p.posF1,p.posF2)    # for instance changing to the coordinates for a certain zone</span>
<span class="sd">    else:</span>
<span class="sd">        p.label = &quot;&quot;                                # and removing elsewhere</span>

<span class="sd">d.display_peaks(peak_label=True)</span>

<span class="sd"># peak lists can also be reported</span>
<span class="sd">d.report_peak()</span>

<span class="sd"># but also as a formatted stream, and redirected to a file:</span>
<span class="sd">output = open(&quot;my_peak_list.csv&quot;,&quot;w&quot;)      # open the file</span>
<span class="sd">output.write(&quot;# LABEL, INTENSITY, F1, Width, F2, width&quot;)</span>
<span class="sd">d.report_peak(file=output, format=&quot;{1}, {4:.2f}, {2:.7f}, {5:.2f}, {3:.7f}, {6:.2f}&quot;)</span>
<span class="sd">        # arguments order order is   id, label, posF1, posF2, intensity, widthF1, widthF2</span>
<span class="sd">output.close()</span>


<span class="sd">Sept 2015 M-A Delsuc</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">print_function</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">unittest</span>
<span class="c1">###</span>
<span class="kn">from</span> <span class="nn">spike</span> <span class="k">import</span> <span class="n">NPKError</span>
<span class="kn">from</span> <span class="nn">spike.NPKData</span> <span class="k">import</span> <span class="n">NPKData_plugin</span><span class="p">,</span> <span class="n">_NPKData</span><span class="p">,</span> <span class="n">flatten</span><span class="p">,</span> <span class="n">parsezoom</span>
<span class="kn">from</span> <span class="nn">spike.util.counter</span> <span class="k">import</span> <span class="n">timeit</span>
<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="k">import</span> <span class="n">curve_fit</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="c1">#from spike.util.signal_tools import findnoiselevel, findnoiselevel_2D</span>

<span class="n">debug</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">NbMaxDisplayPeaks</span> <span class="o">=</span> <span class="mi">1000</span>      <span class="c1"># maximum number of peaks to display at once</span>
<span class="k">def</span> <span class="nf">_identity</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="s2">&quot;the null function - used as default function argument&quot;</span>
    <span class="k">return</span> <span class="n">x</span>
<div class="viewcode-block" id="Peak"><a class="viewcode-back" href="../../../spike.plugins.html#spike.plugins.Peaks.Peak">[docs]</a><span class="k">class</span> <span class="nc">Peak</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; a generic class to store peaks</span>
<span class="sd">    defines :</span>
<span class="sd">    Id          a unique integer</span>
<span class="sd">    intens      The intensity (the height of the largest point)</span>
<span class="sd">    area        The area/volume of the peak</span>
<span class="sd">    label       a string </span>
<span class="sd">    intens_err  The uncertainty of the previous values</span>
<span class="sd">    area_err    ..</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">intens</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Id</span> <span class="o">=</span> <span class="n">Id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="n">label</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">intens</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">intens</span><span class="p">)</span>    <span class="c1"># intensity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">area</span> <span class="o">=</span> <span class="mf">0.0</span>         <span class="c1"># area under the curve</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">intens_err</span> <span class="o">=</span> <span class="mf">0.0</span>      <span class="c1"># uncertainty on intensity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">area_err</span> <span class="o">=</span> <span class="mf">0.0</span>     <span class="c1"># uncertainty on area</span></div>
        
<div class="viewcode-block" id="Peak1D"><a class="viewcode-back" href="../../../spike.plugins.html#spike.plugins.Peaks.Peak1D">[docs]</a><span class="k">class</span> <span class="nc">Peak1D</span><span class="p">(</span><span class="n">Peak</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;a class to store a single 1D peak</span>
<span class="sd">    defines in addition to Peak</span>
<span class="sd">    pos         position of the peak in index relative to the typed (real/complex) buffer</span>
<span class="sd">    width       width of the peak in index</span>
<span class="sd">    pos_err     uncertainty of the previous values</span>
<span class="sd">    width_err   ...</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">report_format</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">, </span><span class="si">{:.2f}</span><span class="s2">, </span><span class="si">{:.2f}</span><span class="s2">&quot;</span>
    <span class="n">full_format</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">, &quot;</span><span class="o">*</span><span class="mi">8</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">intens</span><span class="p">,</span> <span class="n">pos</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Peak1D</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">Id</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">intens</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pos_err</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">width_err</span> <span class="o">=</span> <span class="mf">0.0</span>
<div class="viewcode-block" id="Peak1D.report"><a class="viewcode-back" href="../../../spike.plugins.html#spike.plugins.Peaks.Peak1D.report">[docs]</a>    <span class="k">def</span> <span class="nf">report</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="o">=</span><span class="n">_identity</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        print the peak list</span>
<span class="sd">        f is a function used to transform the coordinate</span>
<span class="sd">        indentity function is default,</span>
<span class="sd">        for instance you can use something like</span>
<span class="sd">        peaks.report(f=s.axis1.itop)    to get ppm values on a NMR dataset</span>
<span class="sd">        order is &quot;id, label, position, intensity&quot;</span>

<span class="sd">        parameters are : </span>
<span class="sd">        Id label positions intens width intens_err pos_err width_err </span>
<span class="sd">        in that order.</span>

<span class="sd">        By default returns only the 4 first fields with 2 digits, but the format keyword can change that.</span>
<span class="sd">        format values:</span>
<span class="sd">        - None or &quot;report&quot;, the standard value is used:  &quot;{}, {}, {:.2f}, {:.2f}&quot; </span>
<span class="sd">                  (so only the four first parameters are shown)</span>
<span class="sd">        - &quot;full&quot; is all parrameters at full resolution  ( &quot;{}; &quot;*8 )</span>
<span class="sd">        - any othe string following the format syta will do.</span>
<span class="sd">            you can use any formating syntax. So for instance the following format</span>
<span class="sd">            &quot;{1} :   {3:.2f}  F1: {2:.7f} +/- {4:.2f}&quot;</span>
<span class="sd">            will remove the Id, show position with 7 digits after the comma, and will show width</span>

<span class="sd">        you can change the report and full default values by setting</span>
<span class="sd">        pk.__class__.report_format   and   pk.__class__.full_format  which class attributes</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">format</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">format</span> <span class="o">==</span> <span class="s2">&quot;report&quot;</span><span class="p">:</span>
            <span class="nb">format</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">report_format</span>
        <span class="k">elif</span> <span class="nb">format</span> <span class="o">==</span> <span class="s2">&quot;full&quot;</span><span class="p">:</span>
            <span class="nb">format</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_format</span>
        <span class="k">return</span> <span class="nb">format</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">,</span> <span class="n">f</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">intens</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="p">,</span>  <span class="bp">self</span><span class="o">.</span><span class="n">pos_err</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">intens_err</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">width_err</span><span class="p">)</span></div>
    <span class="k">def</span> <span class="nf">_report</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="o">=</span><span class="n">_identity</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        full report for 1D Peaks</span>
<span class="sd">        list is : Id, label, pos intens, widthF1, width, pos_err, intens_err, width_err</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="n">f</span><span class="o">=</span><span class="n">f</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">full_format</span><span class="p">)</span></div>
        
<div class="viewcode-block" id="Peak2D"><a class="viewcode-back" href="../../../spike.plugins.html#spike.plugins.Peaks.Peak2D">[docs]</a><span class="k">class</span> <span class="nc">Peak2D</span><span class="p">(</span><span class="n">Peak</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;a class to store a single 2D peak</span>
<span class="sd">    defines in addition to Peak</span>
<span class="sd">    posF1 posF2         positions in F1 and F2 of the peak in index relative to the typed (real/complex) axis</span>
<span class="sd">    widthF1 ...F2       widthes of the peak in index</span>
<span class="sd">    posF1_err ...       uncertainty of the previous values</span>
<span class="sd">    widthF1_err   ...</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">report_format</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">, </span><span class="si">{:.2f}</span><span class="s2">, </span><span class="si">{:.2f}</span><span class="s2">, </span><span class="si">{:.2f}</span><span class="s2">&quot;</span>
    <span class="n">full_format</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">, &quot;</span><span class="o">*</span><span class="mi">12</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">intens</span><span class="p">,</span> <span class="n">posF1</span><span class="p">,</span> <span class="n">posF2</span> <span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Peak2D</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">Id</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">intens</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">posF1</span> <span class="o">=</span> <span class="n">posF1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">posF2</span> <span class="o">=</span> <span class="n">posF2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">widthF1</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">widthF2</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">posF1_err</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">posF2_err</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">widthF1_err</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">widthF2_err</span> <span class="o">=</span> <span class="mf">0.0</span>
<div class="viewcode-block" id="Peak2D.report"><a class="viewcode-back" href="../../../spike.plugins.html#spike.plugins.Peaks.Peak2D.report">[docs]</a>    <span class="k">def</span> <span class="nf">report</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f1</span><span class="o">=</span><span class="n">_identity</span><span class="p">,</span> <span class="n">f2</span><span class="o">=</span><span class="n">_identity</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        print the peak list</span>
<span class="sd">        f1, f2 are two functions used to transform respectively the coordinates in F1 and F2</span>
<span class="sd">        indentity function is default,</span>
<span class="sd">        for instance you can use something like</span>
<span class="sd">        peaks.report(f1=s.axis1.itop, f2=s.axis2.itop)    to get ppm values on a NMR dataset</span>
<span class="sd">        order is &quot;id, label, posF1, posF2, intensity, widthF1, widthF2&quot;</span>

<span class="sd">        printed parameters are : </span>
<span class="sd">        Id label posF1 posF2 intens widthF1 widthF2 posF1_err posF2_err intens_err widthF1_err widthF2_err </span>

<span class="sd">        By default returns only the 5 first fields with 2 digits, but the format keyword can change that.</span>
<span class="sd">        format values:</span>
<span class="sd">        - None or &quot;report&quot;, the standard value is used:  &quot;{}, {}, {:.2f}, {:.2f}, {:.2f}&quot; </span>
<span class="sd">                  (so only the four first parameters are shown)</span>
<span class="sd">        - &quot;full&quot; is all parrameters at full resolution  ( &quot;{}; &quot;*12 )</span>
<span class="sd">        - any othe string following the format syntxa will do.</span>
<span class="sd">            you can use any formating syntax. So for instance the following format</span>
<span class="sd">            &quot;{1} :   {4:.2f}  F1: {2:.7f} +/- {5:.2f}  X  F2: {3:.7f} +/- {6:.2f}&quot;</span>
<span class="sd">            will remove the Id, show position with 7 digits after the comma, and will show widthes    </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">format</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">format</span> <span class="o">==</span> <span class="s2">&quot;report&quot;</span><span class="p">:</span>
            <span class="nb">format</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">report_format</span>
        <span class="k">elif</span> <span class="nb">format</span> <span class="o">==</span> <span class="s2">&quot;full&quot;</span><span class="p">:</span>
            <span class="nb">format</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_format</span>
        <span class="k">return</span> <span class="nb">format</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">,</span> <span class="n">f1</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">posF1</span><span class="p">),</span> <span class="n">f2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">posF2</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">intens</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">widthF1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">widthF2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">posF1_err</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">posF2_err</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">intens_err</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">widthF1_err</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">widthF2_err</span> <span class="p">)</span></div>
    <span class="k">def</span> <span class="nf">_report</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f1</span><span class="o">=</span><span class="n">_identity</span><span class="p">,</span> <span class="n">f2</span><span class="o">=</span><span class="n">_identity</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        full report for 2D Peaks</span>
<span class="sd">        list is : Id, label, posF1, posF2, intens, widthF1, widthF2, posF1_err, posF2_err, intens_err, widthF1_err, widthF2_err</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="n">f1</span><span class="o">=</span><span class="n">f1</span><span class="p">,</span> <span class="n">f2</span><span class="o">=</span><span class="n">f2</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">full_format</span><span class="p">)</span></div>

<div class="viewcode-block" id="PeakList"><a class="viewcode-back" href="../../../spike.plugins.html#spike.plugins.Peaks.PeakList">[docs]</a><span class="k">class</span> <span class="nc">PeakList</span><span class="p">(</span><span class="nb">list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    the class generic to all peak lists</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span> <span class="c1">#threshold=None, source=None):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">PeakList</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">arg</span><span class="p">)</span>
        <span class="c1"># I can&#39;t figure out how to explictly specify a keyword arg with *args:</span>
        <span class="c1">#   def __init__(self, *arg, threshold=None, source=None): ...</span>
        <span class="c1"># so I use **kwds and sqauwk if something unexpected is passed in.</span>
        <span class="c1"># code taken from   lib/python2.7/pstats.py</span>
        <span class="c1">#</span>
        <span class="c1"># additional kw are source: the originating dataset, threshold: actual value</span>
        <span class="k">if</span> <span class="s2">&quot;threshold&quot;</span> <span class="ow">in</span> <span class="n">kwds</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="o">=</span> <span class="n">kwds</span><span class="p">[</span><span class="s2">&quot;threshold&quot;</span><span class="p">]</span>
            <span class="k">del</span> <span class="n">kwds</span><span class="p">[</span><span class="s2">&quot;threshold&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="s2">&quot;source&quot;</span> <span class="ow">in</span> <span class="n">kwds</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="n">kwds</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">]</span>
            <span class="k">del</span> <span class="n">kwds</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">kwds</span><span class="p">:</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="n">kwds</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="n">keys</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
            <span class="n">extras</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">kwds</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">])</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;unrecognized keyword args: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">extras</span><span class="p">)</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">intens</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;returns a numpy array of the intensities&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span> <span class="p">[</span><span class="n">pk</span><span class="o">.</span><span class="n">intens</span> <span class="k">for</span> <span class="n">pk</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span> <span class="p">)</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">label</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;returns an array of the labels&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">pk</span><span class="o">.</span><span class="n">label</span> <span class="k">for</span> <span class="n">pk</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>
<div class="viewcode-block" id="PeakList.len"><a class="viewcode-back" href="../../../spike.plugins.html#spike.plugins.Peaks.PeakList.len">[docs]</a>    <span class="k">def</span> <span class="nf">len</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>
<div class="viewcode-block" id="PeakList.largest"><a class="viewcode-back" href="../../../spike.plugins.html#spike.plugins.Peaks.PeakList.largest">[docs]</a>    <span class="k">def</span> <span class="nf">largest</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;sort the peaklist in decresing order of intensities&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">reverse</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">p</span><span class="p">:</span><span class="n">p</span><span class="o">.</span><span class="n">intens</span><span class="p">)</span></div></div>
    <span class="c1"># def __getitem__(self,i):</span>
    <span class="c1">#     #print(&#39;getitem&#39;)</span>
    <span class="c1">#     return type(self)(list.__getitem__(self,i))</span>
<div class="viewcode-block" id="peak_aggreg"><a class="viewcode-back" href="../../../spike.plugins.html#spike.plugins.Peaks.peak_aggreg">[docs]</a><span class="k">def</span> <span class="nf">peak_aggreg</span><span class="p">(</span><span class="n">pklist</span><span class="p">,</span> <span class="n">distance</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    aggregates peaks in peaklist if peaks are closer than a given distance in pixel</span>
<span class="sd">    distance : if two peaks are less than distance (in points),  they are aggregated</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pkl</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">pklist</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>   <span class="c1"># first, sort the list in position</span>
    <span class="n">newlist</span> <span class="o">=</span> <span class="n">Peak1DList</span><span class="p">()</span>
    <span class="n">prev</span> <span class="o">=</span> <span class="n">pkl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">ipk</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">maxgrp</span> <span class="o">=</span> <span class="p">(</span><span class="n">prev</span><span class="o">.</span><span class="n">intens</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># maintain maxval and index of max peak</span>
    <span class="n">newgrp</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,]</span>
    <span class="k">while</span> <span class="n">ipk</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">pkl</span><span class="p">):</span>
        <span class="n">current</span> <span class="o">=</span> <span class="n">pkl</span><span class="p">[</span><span class="n">ipk</span><span class="p">]</span>
        <span class="c1">#print (current.pos, int(current.pos-prev.pos), distance)</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">current</span><span class="o">.</span><span class="n">pos</span><span class="o">-</span><span class="n">prev</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">distance</span><span class="p">:</span>  <span class="c1"># start aggregating</span>
            <span class="c1">#print(ipk, current.pos)</span>
            <span class="n">newgrp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ipk</span><span class="p">)</span>                     <span class="c1"># add to list</span>
            <span class="k">if</span> <span class="n">current</span><span class="o">.</span><span class="n">intens</span><span class="o">&gt;</span><span class="n">maxgrp</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>           <span class="c1"># check summit</span>
                <span class="n">maxgrp</span> <span class="o">=</span> <span class="p">(</span><span class="n">current</span><span class="o">.</span><span class="n">intens</span><span class="p">,</span> <span class="n">ipk</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>       <span class="c1"># stop aggregating</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">newgrp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">inewpk</span> <span class="o">=</span> <span class="n">newgrp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>   <span class="c1"># isolated peak</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">inewpk</span> <span class="o">=</span>  <span class="n">maxgrp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># larger peak of the aggregate</span>
            <span class="n">newlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">pkl</span><span class="p">[</span><span class="n">inewpk</span><span class="p">]</span> <span class="p">)</span>
            <span class="n">newgrp</span> <span class="o">=</span> <span class="p">[</span><span class="n">ipk</span><span class="p">]</span>
            <span class="n">maxgrp</span> <span class="o">=</span> <span class="p">(</span><span class="n">current</span><span class="o">.</span><span class="n">intens</span><span class="p">,</span> <span class="n">ipk</span><span class="p">)</span>
        <span class="n">ipk</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">prev</span> <span class="o">=</span> <span class="n">current</span>

    <span class="c1"># finished - left-overs</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">newgrp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">inewpk</span> <span class="o">=</span> <span class="n">newgrp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>   <span class="c1"># isolated peak</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">inewpk</span> <span class="o">=</span>  <span class="n">maxgrp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># larger peak of the aggregate</span>
    <span class="n">newlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">pklist</span><span class="p">[</span><span class="n">inewpk</span><span class="p">]</span> <span class="p">)</span>
    <span class="k">return</span> <span class="n">newlist</span> </div>
<div class="viewcode-block" id="Peak1DList"><a class="viewcode-back" href="../../../spike.plugins.html#spike.plugins.Peaks.Peak1DList">[docs]</a><span class="k">class</span> <span class="nc">Peak1DList</span><span class="p">(</span><span class="n">PeakList</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    store a list of 1D peaks</span>
<span class="sd">    contains the array version of the Peak1D object :</span>
<span class="sd">    self.pos is the numpy array of the position of all the peaks</span>
<span class="sd">    and self[k] is the kth Peak1D object of the list</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pos</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;returns a numpy array of the positions in index&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span> <span class="p">[</span><span class="n">pk</span><span class="o">.</span><span class="n">pos</span> <span class="k">for</span> <span class="n">pk</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span> <span class="p">)</span>
<div class="viewcode-block" id="Peak1DList.report"><a class="viewcode-back" href="../../../spike.plugins.html#spike.plugins.Peaks.Peak1DList.report">[docs]</a>    <span class="k">def</span> <span class="nf">report</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="o">=</span><span class="n">_identity</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">NbMaxPeaks</span><span class="o">=</span><span class="n">NbMaxDisplayPeaks</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        print the peak list</span>
<span class="sd">        f is a function used to transform respectively the coordinates</span>
<span class="sd">        indentity function is default,</span>
<span class="sd">        for instance you can use something like</span>
<span class="sd">        d.peaks.report(f=d.axis1.itop)    to get ppm values on a NMR dataset</span>

<span class="sd">        check documentation for Peak1D.report() for details on output format</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">NbMaxPeaks</span><span class="o">&lt;</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;# </span><span class="si">%d</span><span class="s2"> in Peak list - reporting the </span><span class="si">%d</span><span class="s2"> largest&quot;</span><span class="o">%</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="n">NbMaxPeaks</span><span class="p">),</span> <span class="n">file</span><span class="o">=</span><span class="n">file</span><span class="p">)</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argpartition</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">intens</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">-</span><span class="n">NbMaxPeaks</span><span class="p">)[</span><span class="o">-</span><span class="n">NbMaxPeaks</span><span class="p">:])</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">pk</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">pk</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="n">f</span><span class="o">=</span><span class="n">f</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="nb">format</span><span class="p">),</span> <span class="n">file</span><span class="o">=</span><span class="n">file</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;# </span><span class="si">%d</span><span class="s2"> in Peak list&quot;</span><span class="o">%</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="n">file</span><span class="o">=</span><span class="n">file</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">pk</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">pk</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="n">f</span><span class="o">=</span><span class="n">f</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="nb">format</span><span class="p">),</span> <span class="n">file</span><span class="o">=</span><span class="n">file</span><span class="p">)</span></div>
    <span class="k">def</span> <span class="nf">_report</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="o">=</span><span class="n">_identity</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;return full report for 1D peak list</span>
<span class="sd">        list is : Id, label, pos, intens, width,  pos_err, intens_err, width_err</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lst</span> <span class="o">=</span> <span class="p">[</span><span class="n">pk</span><span class="o">.</span><span class="n">_report</span><span class="p">(</span><span class="n">f</span><span class="o">=</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">pk</span> <span class="ow">in</span> <span class="bp">self</span> <span class="p">]</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lst</span><span class="p">)</span>
<div class="viewcode-block" id="Peak1DList.display"><a class="viewcode-back" href="../../../spike.plugins.html#spike.plugins.Peaks.Peak1DList.display">[docs]</a>    <span class="k">def</span> <span class="nf">display</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">peak_label</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">peak_mode</span><span class="o">=</span><span class="s2">&quot;marker&quot;</span><span class="p">,</span> <span class="n">zoom</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">f</span><span class="o">=</span><span class="n">_identity</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">figure</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">NbMaxPeaks</span><span class="o">=</span><span class="n">NbMaxDisplayPeaks</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        displays 1D peaks</span>
<span class="sd">        zoom is in index</span>
<span class="sd">        peak_mode is either &quot;marker&quot; or &quot;bar&quot;</span>
<span class="sd">        NbMaxPeaks is the maximum number of peaks to displayin the zoom window (show only the largest)</span>
<span class="sd">        f() should be a function which converts from points to current display scale - typically npk.axis1.itoc</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span>  <span class="c1"># nothing to display</span>
        <span class="kn">from</span> <span class="nn">spike.Display</span> <span class="k">import</span> <span class="n">testplot</span>
        <span class="n">plot</span> <span class="o">=</span> <span class="n">testplot</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">figure</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plot</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">figure</span>
        <span class="c1"># create and filter list</span>
        <span class="k">if</span> <span class="n">zoom</span><span class="p">:</span>
            <span class="n">z0</span><span class="o">=</span><span class="n">zoom</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">z1</span><span class="o">=</span><span class="n">zoom</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">pkl</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">pos</span><span class="o">&gt;=</span><span class="n">z0</span> <span class="ow">and</span> <span class="n">p</span><span class="o">.</span><span class="n">pos</span><span class="o">&lt;=</span><span class="n">z1</span><span class="p">]</span>  <span class="c1"># index of peaks on zoom window</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pkl</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">peak_mode</span> <span class="o">==</span> <span class="s2">&quot;marker&quot;</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>   <span class="c1"># in marker mode, removes peaks too high</span>
            <span class="n">mmax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">intens</span><span class="p">)</span><span class="o">/</span><span class="n">scale</span>
            <span class="n">pkl</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">intens</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">&lt;=</span><span class="n">mmax</span><span class="p">,</span> <span class="n">pkl</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pkl</span><span class="p">)</span><span class="o">&gt;</span><span class="n">NbMaxPeaks</span><span class="p">:</span>     <span class="c1"># too many to display</span>
            <span class="n">pkl</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="bp">self</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">intens</span><span class="p">)</span>
            <span class="n">pkl</span> <span class="o">=</span> <span class="n">pkl</span><span class="p">[:</span><span class="n">NbMaxPeaks</span><span class="p">]</span>
        <span class="c1"># now display</span>
        <span class="k">if</span> <span class="n">peak_mode</span> <span class="o">==</span> <span class="s2">&quot;marker&quot;</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">f</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="n">pkl</span><span class="p">]),</span> <span class="bp">self</span><span class="o">.</span><span class="n">intens</span><span class="p">[</span><span class="n">pkl</span><span class="p">],</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">peak_mode</span> <span class="o">==</span> <span class="s2">&quot;bar&quot;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">pkl</span><span class="p">:</span>
                <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span> <span class="p">[</span><span class="n">f</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">pos</span><span class="p">),</span><span class="n">f</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">pos</span><span class="p">)],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">p</span><span class="o">.</span><span class="n">intens</span><span class="p">],</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;wrong peak_mode&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">peak_label</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">pkl</span><span class="p">:</span>
                <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">label</span><span class="p">,(</span><span class="n">f</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">pos</span><span class="p">),</span> <span class="n">p</span><span class="o">.</span><span class="n">intens</span><span class="p">),</span>
                    <span class="n">xycoords</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">textcoords</span><span class="o">=</span><span class="s1">&#39;offset points&#39;</span><span class="p">,</span>
                    <span class="n">rotation</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span>
                    <span class="n">arrowprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">arrowstyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">),</span> <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">show</span><span class="p">:</span> <span class="n">plot</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>
    <span class="c1"># def merge(self, pklist, tolerance=1.0):</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     merge self and additional pklist by removing redundant peaks (closer than tolerance - in points)</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     self = peak_aggreg(self+pklist, distance=tolerance)  # that simple !</span>
<div class="viewcode-block" id="Peak1DList.pos2label"><a class="viewcode-back" href="../../../spike.plugins.html#spike.plugins.Peaks.Peak1DList.pos2label">[docs]</a>    <span class="k">def</span> <span class="nf">pos2label</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;use pos in current unit, using converion f and set it as label for each peak&quot;</span>
        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">axis1</span><span class="o">.</span><span class="n">itoc</span>
        <span class="k">for</span> <span class="n">pk</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">pk</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%.4f</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">f</span><span class="p">(</span><span class="n">pk</span><span class="o">.</span><span class="n">pos</span><span class="p">),)</span></div></div>

<div class="viewcode-block" id="Peak2DList"><a class="viewcode-back" href="../../../spike.plugins.html#spike.plugins.Peaks.Peak2DList">[docs]</a><span class="k">class</span> <span class="nc">Peak2DList</span><span class="p">(</span><span class="n">PeakList</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    store a list of 2D peaks</span>
<span class="sd">    contains the array version of the Peak2D object :</span>
<span class="sd">    self.posF1 is the numpy array of the position of all the peaks</span>
<span class="sd">    and self[k] is the kth Peak2D object of the list</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">posF1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;returns a numpy array of the F1 positions in index&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span> <span class="p">[</span><span class="n">pk</span><span class="o">.</span><span class="n">posF1</span> <span class="k">for</span> <span class="n">pk</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span> <span class="p">)</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">posF2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;returns a numpy array of the F2 positions in index&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span> <span class="p">[</span><span class="n">pk</span><span class="o">.</span><span class="n">posF2</span> <span class="k">for</span> <span class="n">pk</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span> <span class="p">)</span>
<div class="viewcode-block" id="Peak2DList.report"><a class="viewcode-back" href="../../../spike.plugins.html#spike.plugins.Peaks.Peak2DList.report">[docs]</a>    <span class="k">def</span> <span class="nf">report</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f1</span><span class="o">=</span><span class="n">_identity</span><span class="p">,</span> <span class="n">f2</span><span class="o">=</span><span class="n">_identity</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">NbMaxPeaks</span><span class="o">=</span><span class="n">NbMaxDisplayPeaks</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        print the peak list</span>
<span class="sd">        f1, f2 are two functions used to transform respectively the coordinates in F1 and F2</span>
<span class="sd">        indentity function is default,</span>
<span class="sd">        for instance you can use something like</span>
<span class="sd">        d.peaks.export(f1=s.axis1.itop, f2=s.axis2.itop)    to get ppm values on a NMR dataset</span>
<span class="sd">        the file keyword allows to redirect the output to a file object </span>
<span class="sd">        </span>
<span class="sd">        check documentation for Peak2D.report() for details on output format</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">NbMaxPeaks</span><span class="o">&lt;</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;# </span><span class="si">%d</span><span class="s2"> in Peak list - reporting the </span><span class="si">%d</span><span class="s2"> largest&quot;</span><span class="o">%</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="n">NbMaxPeaks</span><span class="p">),</span> <span class="n">file</span><span class="o">=</span><span class="n">file</span><span class="p">)</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argpartition</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">intens</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">-</span><span class="n">NbMaxPeaks</span><span class="p">)[</span><span class="o">-</span><span class="n">NbMaxPeaks</span><span class="p">:])</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">pk</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">pk</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="n">f1</span><span class="o">=</span><span class="n">f1</span><span class="p">,</span> <span class="n">f2</span><span class="o">=</span><span class="n">f2</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="nb">format</span><span class="p">),</span> <span class="n">file</span><span class="o">=</span><span class="n">file</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;# </span><span class="si">%d</span><span class="s2"> in Peak list&quot;</span><span class="o">%</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="n">file</span><span class="o">=</span><span class="n">file</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">pk</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">pk</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="n">f1</span><span class="o">=</span><span class="n">f1</span><span class="p">,</span> <span class="n">f2</span><span class="o">=</span><span class="n">f2</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="nb">format</span><span class="p">),</span> <span class="n">file</span><span class="o">=</span><span class="n">file</span><span class="p">)</span></div>
    <span class="k">def</span> <span class="nf">_report</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f1</span><span class="o">=</span><span class="n">_identity</span><span class="p">,</span> <span class="n">f2</span><span class="o">=</span><span class="n">_identity</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;return full report for 2D peak list</span>
<span class="sd">        list is : Id, label, posF1, posF2, intens, widthF1, widthF2, posF1_err, posF2_err, intens_err, widthF1_err, widthF2_err</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lst</span> <span class="o">=</span> <span class="p">[</span><span class="n">pk</span><span class="o">.</span><span class="n">_report</span><span class="p">(</span><span class="n">f1</span><span class="o">=</span><span class="n">f1</span><span class="p">,</span> <span class="n">f2</span><span class="o">=</span><span class="n">f2</span><span class="p">)</span> <span class="k">for</span> <span class="n">pk</span> <span class="ow">in</span> <span class="bp">self</span> <span class="p">]</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lst</span><span class="p">)</span>
<div class="viewcode-block" id="Peak2DList.display"><a class="viewcode-back" href="../../../spike.plugins.html#spike.plugins.Peaks.Peak2DList.display">[docs]</a>    <span class="k">def</span> <span class="nf">display</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">peak_label</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">zoom</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">f1</span><span class="o">=</span><span class="n">_identity</span><span class="p">,</span> <span class="n">f2</span><span class="o">=</span><span class="n">_identity</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">figure</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">NbMaxPeaks</span><span class="o">=</span><span class="n">NbMaxDisplayPeaks</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        displays 2D peak list</span>
<span class="sd">        zoom is in index</span>
<span class="sd">        f1 and f2 should be functions which convert from points to current display scale - typically npk.axis1.itoc npk.axis2.itoc</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">spike.Display.testplot</span> <span class="k">as</span> <span class="nn">testplot</span>
        <span class="n">plot</span> <span class="o">=</span> <span class="n">testplot</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">figure</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plot</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">figure</span>
        <span class="k">if</span> <span class="n">zoom</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="p">(</span><span class="n">z1lo</span><span class="p">,</span> <span class="n">z1up</span><span class="p">,</span> <span class="n">z2lo</span><span class="p">,</span> <span class="n">z2up</span><span class="p">)</span> <span class="o">=</span> <span class="n">flatten</span><span class="p">(</span><span class="n">zoom</span><span class="p">)</span>
            <span class="n">pk</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)):</span>
                <span class="n">plp</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">p</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">plp</span><span class="o">.</span><span class="n">posF1</span><span class="o">&gt;=</span><span class="n">z1lo</span> <span class="ow">and</span> <span class="n">plp</span><span class="o">.</span><span class="n">posF1</span><span class="o">&lt;=</span><span class="n">z1up</span> <span class="ow">and</span> <span class="n">plp</span><span class="o">.</span><span class="n">posF2</span><span class="o">&gt;=</span><span class="n">z2lo</span> <span class="ow">and</span> <span class="n">plp</span><span class="o">.</span><span class="n">posF2</span><span class="o">&lt;=</span><span class="n">z2up</span><span class="p">:</span>
                    <span class="n">pk</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pk</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">debug</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;plotting </span><span class="si">%d</span><span class="s2"> peaks&quot;</span><span class="o">%</span><span class="nb">len</span><span class="p">(</span><span class="n">pk</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">axis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">plF1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">posF1</span> <span class="c1"># these are ndarray !</span>
            <span class="n">plF2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">posF2</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">f2</span><span class="p">(</span><span class="n">plF2</span><span class="p">[</span><span class="n">pk</span><span class="p">]),</span> <span class="n">f1</span><span class="p">(</span><span class="n">plF1</span><span class="p">[</span><span class="n">pk</span><span class="p">]),</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="n">markersize</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">peak_label</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pk</span><span class="p">:</span>
                    <span class="n">plp</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">p</span><span class="p">]</span>
                    <span class="n">fig</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">1.01</span><span class="o">*</span><span class="n">plp</span><span class="o">.</span><span class="n">posF2</span><span class="p">,</span> <span class="mf">1.01</span><span class="o">*</span><span class="n">plp</span><span class="o">.</span><span class="n">posF1</span><span class="p">,</span> <span class="n">plp</span><span class="o">.</span><span class="n">label</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="n">markersize</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;to be done&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">show</span><span class="p">:</span> <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div></div>

<span class="k">def</span> <span class="nf">_peaks2d</span><span class="p">(</span><span class="n">npkd</span><span class="p">,</span> <span class="n">threshold</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span> <span class="n">zoom</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">zones</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Extract peaks from 2d Array dataset</span>
<span class="sd">    if value is True, return the magnitude at position (x,y)</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">zones</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">_peaks2d</span><span class="p">(</span><span class="n">npkd</span><span class="p">,</span> <span class="n">threshold</span> <span class="o">=</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">zoom</span> <span class="o">=</span> <span class="n">zoom</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;** assuming no zoom predefined **&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">zones</span><span class="p">):</span>
            <span class="nb">print</span> <span class="p">(</span><span class="n">z</span><span class="p">)</span>

<span class="c1">#----------------------------------------------------------</span>
<div class="viewcode-block" id="peakpick"><a class="viewcode-back" href="../../../spike.plugins.html#spike.plugins.Peaks.peakpick">[docs]</a><span class="k">def</span> <span class="nf">peakpick</span><span class="p">(</span><span class="n">npkd</span><span class="p">,</span> <span class="n">threshold</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">zoom</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">autothresh</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    performs a peak picking of the current experiment</span>
<span class="sd">    threshold is the level above which peaks are picked</span>
<span class="sd">        None (default) means that autothresh*(noise level of dataset) will be used - using d.robust_stats() as proxy for noise-level</span>
<span class="sd">    zoom defines the region on which detection is made</span>
<span class="sd">        zoom is in currentunit (same syntax as in display)</span>
<span class="sd">        None means the whole data</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">threshold</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span> <span class="o">=</span> <span class="n">npkd</span><span class="o">.</span><span class="n">robust_stats</span><span class="p">()</span>
        <span class="n">threshold</span> <span class="o">=</span> <span class="n">autothresh</span><span class="o">*</span><span class="n">sigma</span>
        <span class="k">if</span> <span class="n">mu</span> <span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">threshold</span> <span class="o">+=</span> <span class="n">mu</span>
    <span class="k">if</span> <span class="n">npkd</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">listpkF1</span><span class="p">,</span> <span class="n">listint</span> <span class="o">=</span> <span class="n">peaks1d</span><span class="p">(</span><span class="n">npkd</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="n">threshold</span><span class="p">,</span> <span class="n">zoom</span><span class="o">=</span><span class="n">zoom</span><span class="p">)</span>
                            <span class="c1">#     Id, label, intens, pos</span>
        <span class="n">pkl</span> <span class="o">=</span> <span class="n">Peak1DList</span><span class="p">(</span> <span class="p">(</span> <span class="n">Peak1D</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">intens</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span> \
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">intens</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">listint</span><span class="p">)),</span> <span class="nb">list</span><span class="p">(</span><span class="n">listpkF1</span><span class="p">),</span> <span class="nb">list</span><span class="p">(</span><span class="n">listint</span><span class="p">)</span> <span class="p">)</span> <span class="p">),</span> \
                    <span class="n">threshold</span><span class="o">=</span><span class="n">threshold</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">npkd</span> <span class="p">)</span>
        <span class="c1"># use pos as labels - </span>
        <span class="n">pkl</span><span class="o">.</span><span class="n">pos2label</span><span class="p">()</span>
        <span class="n">npkd</span><span class="o">.</span><span class="n">peaks</span> <span class="o">=</span> <span class="n">pkl</span>
    <span class="k">elif</span> <span class="n">npkd</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">listpkF1</span><span class="p">,</span> <span class="n">listpkF2</span><span class="p">,</span> <span class="n">listint</span> <span class="o">=</span> <span class="n">peaks2d</span><span class="p">(</span><span class="n">npkd</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="n">threshold</span><span class="p">,</span> <span class="n">zoom</span><span class="o">=</span><span class="n">zoom</span><span class="p">)</span>
                            <span class="c1">#     Id, label, intens, posF1, posF2 </span>
        <span class="n">pkl</span> <span class="o">=</span> <span class="n">Peak2DList</span><span class="p">(</span> <span class="p">(</span> <span class="n">Peak2D</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">intens</span><span class="p">,</span> <span class="n">posF1</span><span class="p">,</span> <span class="n">posF2</span><span class="p">)</span> \
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">posF1</span><span class="p">,</span> <span class="n">posF2</span><span class="p">,</span> <span class="n">intens</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">listpkF1</span><span class="p">)),</span> <span class="n">listpkF1</span><span class="p">,</span> <span class="n">listpkF2</span><span class="p">,</span> <span class="n">listint</span> <span class="p">)</span> <span class="p">),</span> \
                                    <span class="n">threshold</span><span class="o">=</span><span class="n">threshold</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">npkd</span> <span class="p">)</span>
        <span class="n">npkd</span><span class="o">.</span><span class="n">peaks</span> <span class="o">=</span> <span class="n">pkl</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">NPKError</span><span class="p">(</span><span class="s2">&quot;Not implemented of </span><span class="si">%s</span><span class="s2">D experiment&quot;</span><span class="o">%</span><span class="n">npkd</span><span class="o">.</span><span class="n">dim</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">npkd</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">threshold</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;PP Threshold:&#39;</span><span class="p">,</span><span class="n">threshold</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;PP: </span><span class="si">%d</span><span class="s1"> detected&#39;</span><span class="o">%</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">npkd</span><span class="o">.</span><span class="n">peaks</span><span class="p">),))</span>
    <span class="k">return</span> <span class="n">npkd</span></div>

<div class="viewcode-block" id="peaks2d"><a class="viewcode-back" href="../../../spike.plugins.html#spike.plugins.Peaks.peaks2d">[docs]</a><span class="k">def</span> <span class="nf">peaks2d</span><span class="p">(</span><span class="n">npkd</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">zoom</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    math code for NPKData 2D peak picker</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">npkd</span><span class="o">.</span><span class="n">check2D</span><span class="p">()</span>
    <span class="c1">#print threshold</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;########## in peaks2d &quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;zoom &quot;</span><span class="p">,</span> <span class="n">zoom</span><span class="p">)</span>
    <span class="n">z1lo</span><span class="p">,</span> <span class="n">z1up</span><span class="p">,</span> <span class="n">z2lo</span><span class="p">,</span> <span class="n">z2up</span> <span class="o">=</span> <span class="n">parsezoom</span><span class="p">(</span><span class="n">npkd</span><span class="p">,</span> <span class="n">zoom</span><span class="p">)</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;z1lo, z1up, z2lo, z2up &quot;</span><span class="p">,</span> <span class="n">z1lo</span><span class="p">,</span> <span class="n">z1up</span><span class="p">,</span> <span class="n">z2lo</span><span class="p">,</span> <span class="n">z2up</span><span class="p">)</span>
    <span class="n">buff</span> <span class="o">=</span> <span class="n">npkd</span><span class="o">.</span><span class="n">get_buffer</span><span class="p">()[</span><span class="n">z1lo</span><span class="p">:</span><span class="n">z1up</span><span class="p">,</span> <span class="n">z2lo</span><span class="p">:</span><span class="n">z2up</span><span class="p">]</span>            <span class="c1"># take the zoom window</span>
    <span class="k">if</span> <span class="n">npkd</span><span class="o">.</span><span class="n">itype</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">buff</span> <span class="o">=</span> <span class="n">buff</span><span class="o">.</span><span class="n">real</span>
    
    <span class="c1"># listpk=np.where(((buff &gt; gold*np.ones(buff.shape))&amp;            # thresholding</span>
    <span class="c1">#                 (buff &gt; np.roll(buff,  1, 0)) &amp;         # laplacian - kind of</span>
    <span class="c1">#                 (buff &gt; np.roll(buff, -1, 0)) &amp;</span>
    <span class="c1">#                 (buff &gt; np.roll(buff,  1, 1)) &amp;</span>
    <span class="c1">#                 (buff &gt; np.roll(buff, -1, 1))))</span>
    <span class="c1"># listpkF1 = int(z1lo) + listpk[0]</span>
    <span class="c1"># listpkF2 = int(z2lo) + listpk[1]        # absolute coordinates</span>

    <span class="c1"># this second version is about 2x faster on my machine</span>
    <span class="n">tbuff</span> <span class="o">=</span> <span class="n">buff</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># truncated version for shifting</span>
    <span class="n">listpk</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(((</span><span class="n">tbuff</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">tbuff</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span><span class="o">&amp;</span>            <span class="c1"># thresholding</span>
                    <span class="p">(</span><span class="n">tbuff</span> <span class="o">&gt;</span> <span class="n">buff</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span> <span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">&amp;</span>         <span class="c1"># laplacian - kind of</span>
                    <span class="p">(</span><span class="n">tbuff</span> <span class="o">&gt;</span> <span class="n">buff</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span> <span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">&amp;</span>
                    <span class="p">(</span><span class="n">tbuff</span> <span class="o">&gt;</span> <span class="n">buff</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span> <span class="p">,</span> <span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span> <span class="o">&amp;</span>
                    <span class="p">(</span><span class="n">tbuff</span> <span class="o">&gt;</span> <span class="n">buff</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span> <span class="p">,</span> <span class="mi">2</span><span class="p">:])))</span>
    <span class="n">listpkF1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">z1lo</span><span class="p">)</span> <span class="o">+</span> <span class="n">listpk</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span><span class="mi">1</span>
    <span class="n">listpkF2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">z2lo</span><span class="p">)</span> <span class="o">+</span> <span class="n">listpk</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span><span class="mi">1</span>        <span class="c1"># absolute coordinates</span>

    <span class="n">listint</span> <span class="o">=</span> <span class="n">npkd</span><span class="o">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">listpkF1</span><span class="p">,</span> <span class="n">listpkF2</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">listpkF1</span><span class="p">,</span> <span class="n">listpkF2</span><span class="p">,</span> <span class="n">listint</span></div>
<div class="viewcode-block" id="peaks1d"><a class="viewcode-back" href="../../../spike.plugins.html#spike.plugins.Peaks.peaks1d">[docs]</a><span class="k">def</span> <span class="nf">peaks1d</span><span class="p">(</span><span class="n">npkd</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">zoom</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    math code for NPKData 1D peak picker</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">npkd</span><span class="o">.</span><span class="n">check1D</span><span class="p">()</span>
    <span class="n">z1</span><span class="p">,</span> <span class="n">z2</span> <span class="o">=</span> <span class="n">parsezoom</span><span class="p">(</span><span class="n">npkd</span><span class="p">,</span> <span class="n">zoom</span><span class="p">)</span>
    <span class="n">buff</span> <span class="o">=</span> <span class="n">npkd</span><span class="o">.</span><span class="n">get_buffer</span><span class="p">()[</span><span class="n">z1</span><span class="p">:</span><span class="n">z2</span><span class="p">]</span>            <span class="c1"># take the zoom window</span>
    <span class="k">if</span> <span class="n">npkd</span><span class="o">.</span><span class="n">itype</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">buff</span> <span class="o">=</span> <span class="n">buff</span><span class="o">.</span><span class="n">real</span>
    <span class="n">tbuff</span> <span class="o">=</span> <span class="n">buff</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">listpk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(((</span><span class="n">tbuff</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">tbuff</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span><span class="o">&amp;</span><span class="c1"># thresholding</span>
                    <span class="p">(</span><span class="n">tbuff</span> <span class="o">&gt;</span> <span class="n">buff</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span> <span class="o">&amp;</span>     
                    <span class="p">(</span><span class="n">tbuff</span> <span class="o">&gt;</span> <span class="n">buff</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span> <span class="p">))</span> <span class="c1"># roll 1 and -1 on axis 0</span>
<span class="c1">#    return listpk[0]</span>
    <span class="n">listpkF1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">z1</span><span class="p">)</span> <span class="o">+</span> <span class="n">listpk</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span><span class="mi">1</span>
    <span class="n">listint</span> <span class="o">=</span> <span class="n">npkd</span><span class="o">.</span><span class="n">get_buffer</span><span class="p">()[</span><span class="n">listpkF1</span><span class="p">]</span><span class="o">.</span><span class="n">real</span>
    <span class="k">return</span> <span class="n">listpkF1</span><span class="p">,</span> <span class="n">listint</span></div>

<span class="c1">#-------------------------------------------------------</span>
<span class="c1"># centroid measure</span>
<div class="viewcode-block" id="center"><a class="viewcode-back" href="../../../spike.plugins.html#spike.plugins.Peaks.center">[docs]</a><span class="k">def</span> <span class="nf">center</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">xo</span><span class="p">,</span> <span class="n">intens</span><span class="p">,</span> <span class="n">width</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    the centroid definition, used to fit the spectrum</span>
<span class="sd">    x can be a nparray</span>
<span class="sd">    FWMH is   sqrt(2) x width.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">intens</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">((</span><span class="n">x</span><span class="o">-</span><span class="n">xo</span><span class="p">)</span><span class="o">/</span><span class="n">width</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span></div>
<div class="viewcode-block" id="center2d"><a class="viewcode-back" href="../../../spike.plugins.html#spike.plugins.Peaks.center2d">[docs]</a><span class="k">def</span> <span class="nf">center2d</span><span class="p">(</span><span class="n">yx</span><span class="p">,</span> <span class="n">yo</span><span class="p">,</span> <span class="n">xo</span><span class="p">,</span> <span class="n">intens</span><span class="p">,</span> <span class="n">widthy</span><span class="p">,</span> <span class="n">widthx</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    the 2D centroid, used to fit 2D spectra - si center()</span>
<span class="sd">    xy is [x0, y_0, x_1, y_1, ..., x_n-1, y_n-1] - is 2*n long for n points,</span>
<span class="sd">    returns [z_0, z_1, ... z_n-1]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">yx</span><span class="p">[::</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">yx</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">intens</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">((</span><span class="n">x</span><span class="o">-</span><span class="n">xo</span><span class="p">)</span><span class="o">/</span><span class="n">widthx</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">((</span><span class="n">y</span><span class="o">-</span><span class="n">yo</span><span class="p">)</span><span class="o">/</span><span class="n">widthy</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span></div>
<div class="viewcode-block" id="centroid1d"><a class="viewcode-back" href="../../../spike.plugins.html#spike.plugins.Peaks.centroid1d">[docs]</a><span class="k">def</span> <span class="nf">centroid1d</span><span class="p">(</span><span class="n">npkd</span><span class="p">,</span> <span class="n">npoints</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">reset_label</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    from peak lists determined with peak()</span>
<span class="sd">    realize a centroid fit of the peak summit and width,</span>
<span class="sd">    will use npoints values around center  (npoints has to be odd)</span>
<span class="sd">    computes Full width at half maximum</span>
<span class="sd">    updates in data peak list</span>
<span class="sd">    reset_label when True (default) reset the labels of FTMS datasets</span>
<span class="sd">    TODO : update uncertainties</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">scipy</span> <span class="k">import</span> <span class="n">polyfit</span>
    <span class="n">npkd</span><span class="o">.</span><span class="n">check1D</span><span class="p">()</span>
    <span class="n">noff</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">npoints</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
    <span class="k">if</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">noff</span><span class="o">+</span><span class="mi">1</span> <span class="o">!=</span> <span class="n">npoints</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">npoints</span><span class="o">&lt;</span><span class="mi">3</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">NPKError</span><span class="p">(</span><span class="s2">&quot;npoints must odd and &gt;2 &quot;</span><span class="p">,</span><span class="n">data</span><span class="o">=</span><span class="n">npkd</span><span class="p">)</span>
    <span class="n">buff</span> <span class="o">=</span> <span class="n">npkd</span><span class="o">.</span><span class="n">get_buffer</span><span class="p">()</span><span class="o">.</span><span class="n">real</span>
    <span class="k">for</span> <span class="n">pk</span> <span class="ow">in</span> <span class="n">npkd</span><span class="o">.</span><span class="n">peaks</span><span class="p">:</span>
        <span class="n">xdata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">pk</span><span class="o">.</span><span class="n">pos</span><span class="o">-</span><span class="n">noff</span><span class="p">)),</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">pk</span><span class="o">.</span><span class="n">pos</span><span class="o">+</span><span class="n">noff</span><span class="o">+</span><span class="mi">1</span><span class="p">)))</span>
        <span class="n">ydata</span> <span class="o">=</span> <span class="n">buff</span><span class="p">[</span><span class="n">xdata</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">popt</span><span class="p">,</span> <span class="n">pcov</span> <span class="o">=</span> <span class="n">curve_fit</span><span class="p">(</span><span class="n">center</span><span class="p">,</span> <span class="n">xdata</span><span class="p">,</span> <span class="n">ydata</span><span class="p">,</span> <span class="n">p0</span><span class="o">=</span><span class="p">[</span><span class="n">pk</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">pk</span><span class="o">.</span><span class="n">intens</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]</span> <span class="p">)</span> <span class="c1"># fit</span>
        <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
            <span class="nb">print</span> <span class="p">(</span> <span class="s2">&quot;peak </span><span class="si">%d</span><span class="s2"> (id </span><span class="si">%s</span><span class="s2">) centroid could not be fitted&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">pk</span><span class="o">.</span><span class="n">Id</span><span class="p">,</span> <span class="n">pk</span><span class="o">.</span><span class="n">label</span><span class="p">)</span> <span class="p">)</span>
        <span class="n">pk</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">popt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">pk</span><span class="o">.</span><span class="n">intens</span> <span class="o">=</span> <span class="n">popt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">pk</span><span class="o">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.0</span><span class="p">)</span><span class="o">*</span><span class="n">popt</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">pcov</span><span class="p">))</span>
        <span class="n">pk</span><span class="o">.</span><span class="n">pos_err</span> <span class="o">=</span> <span class="n">errors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">pk</span><span class="o">.</span><span class="n">intens_err</span> <span class="o">=</span> <span class="n">errors</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">pk</span><span class="o">.</span><span class="n">width_err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.0</span><span class="p">)</span><span class="o">*</span><span class="n">errors</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">reset_label</span><span class="p">:</span>
        <span class="n">npkd</span><span class="o">.</span><span class="n">peaks</span><span class="o">.</span><span class="n">pos2label</span><span class="p">()</span></div>

<div class="viewcode-block" id="centroid2d"><a class="viewcode-back" href="../../../spike.plugins.html#spike.plugins.Peaks.centroid2d">[docs]</a><span class="k">def</span> <span class="nf">centroid2d</span><span class="p">(</span><span class="n">npkd</span><span class="p">,</span> <span class="n">npoints_F1</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">npoints_F2</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    from peak lists determined with peak()</span>
<span class="sd">    realize a centroid fit of the peak summit and width,</span>
<span class="sd">    computes Full width at half maximum</span>
<span class="sd">    updates in data peak list</span>
<span class="sd">    </span>
<span class="sd">    TODO : update uncertainties</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">scipy</span> <span class="k">import</span> <span class="n">polyfit</span>
    <span class="n">npkd</span><span class="o">.</span><span class="n">check2D</span><span class="p">()</span>
    <span class="n">nF1</span> <span class="o">=</span> <span class="n">npoints_F1</span>
    <span class="n">nF2</span> <span class="o">=</span> <span class="n">npoints_F2</span>
    <span class="n">noff1</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">nF1</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
    <span class="n">noff2</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">nF2</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
    <span class="k">if</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">noff1</span><span class="o">+</span><span class="mi">1</span> <span class="o">!=</span> <span class="n">nF1</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">nF1</span><span class="o">&lt;</span><span class="mi">3</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">noff2</span><span class="o">+</span><span class="mi">1</span> <span class="o">!=</span> <span class="n">nF2</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">nF2</span><span class="o">&lt;</span><span class="mi">3</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">NPKError</span><span class="p">(</span><span class="s2">&quot;npoints must odd and &gt;2 &quot;</span><span class="p">,</span><span class="n">data</span><span class="o">=</span><span class="n">npkd</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">pk</span> <span class="ow">in</span> <span class="n">npkd</span><span class="o">.</span><span class="n">peaks</span><span class="p">:</span>
        <span class="n">st1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">pk</span><span class="o">.</span><span class="n">posF1</span><span class="o">-</span><span class="n">noff1</span><span class="p">))</span>
        <span class="n">end1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">pk</span><span class="o">.</span><span class="n">posF1</span><span class="o">+</span><span class="n">noff1</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">st2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">pk</span><span class="o">.</span><span class="n">posF2</span><span class="o">-</span><span class="n">noff2</span><span class="p">))</span>
        <span class="n">end2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">pk</span><span class="o">.</span><span class="n">posF2</span><span class="o">+</span><span class="n">noff2</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">yxdata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span> <span class="p">[(</span><span class="n">y</span><span class="p">,</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">st1</span><span class="p">,</span> <span class="n">end1</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">st2</span><span class="p">,</span> <span class="n">end2</span><span class="p">)]</span> <span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="c1"># yx = np.array([[y,x] for y in range(1,4) for x in range(10,12)]).ravel()</span>
        <span class="c1"># =&gt; array([ 1, 10,  1, 11,  2, 10,  2, 11,  3, 10,  3, 11])  will be decoded by center2d</span>
        <span class="n">zdata</span> <span class="o">=</span> <span class="n">npkd</span><span class="o">.</span><span class="n">get_buffer</span><span class="p">()[</span><span class="n">st1</span><span class="p">:</span><span class="n">end1</span><span class="p">,</span> <span class="n">st2</span><span class="p">:</span><span class="n">end2</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
                                            <span class="c1"># yx,           yo, xo, intens, widthy, widthx</span>
            <span class="n">popt</span><span class="p">,</span> <span class="n">pcov</span> <span class="o">=</span> <span class="n">curve_fit</span><span class="p">(</span><span class="n">center2d</span><span class="p">,</span> <span class="n">yxdata</span><span class="p">,</span> <span class="n">zdata</span><span class="p">,</span> <span class="n">p0</span><span class="o">=</span><span class="p">[</span><span class="n">pk</span><span class="o">.</span><span class="n">posF1</span><span class="p">,</span> <span class="n">pk</span><span class="o">.</span><span class="n">posF2</span><span class="p">,</span> <span class="n">pk</span><span class="o">.</span><span class="n">intens</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]</span> <span class="p">)</span> <span class="c1"># fit</span>
        <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
            <span class="nb">print</span> <span class="p">(</span> <span class="s2">&quot;peak </span><span class="si">%d</span><span class="s2"> (label </span><span class="si">%s</span><span class="s2">) centroid could not be fitted&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">pk</span><span class="o">.</span><span class="n">Id</span><span class="p">,</span> <span class="n">pk</span><span class="o">.</span><span class="n">label</span><span class="p">)</span> <span class="p">)</span>
        <span class="n">pk</span><span class="o">.</span><span class="n">posF1</span> <span class="o">=</span> <span class="n">popt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">pk</span><span class="o">.</span><span class="n">posF2</span> <span class="o">=</span> <span class="n">popt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">pk</span><span class="o">.</span><span class="n">intens</span> <span class="o">=</span> <span class="n">popt</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">pk</span><span class="o">.</span><span class="n">widthF1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.0</span><span class="p">)</span><span class="o">*</span><span class="n">popt</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">pk</span><span class="o">.</span><span class="n">widthF2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.0</span><span class="p">)</span><span class="o">*</span><span class="n">popt</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">pcov</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span>
        <span class="n">pk</span><span class="o">.</span><span class="n">posF1_err</span> <span class="o">=</span> <span class="n">errors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">pk</span><span class="o">.</span><span class="n">posF2_err</span> <span class="o">=</span> <span class="n">errors</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">pk</span><span class="o">.</span><span class="n">intens_err</span> <span class="o">=</span> <span class="n">errors</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">pk</span><span class="o">.</span><span class="n">widthF1_err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.0</span><span class="p">)</span><span class="o">*</span><span class="n">errors</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">pk</span><span class="o">.</span><span class="n">widthF2_err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.0</span><span class="p">)</span><span class="o">*</span><span class="n">errors</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span></div>
<span class="c1">#-------------------------------------------------------</span>
<div class="viewcode-block" id="centroid"><a class="viewcode-back" href="../../../spike.plugins.html#spike.plugins.Peaks.centroid">[docs]</a><span class="k">def</span> <span class="nf">centroid</span><span class="p">(</span><span class="n">npkd</span><span class="p">,</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="o">**</span><span class="n">kwarg</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">npkd</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s1">&#39;.*ovariance.*&#39;</span><span class="p">)</span>
            <span class="n">centroid1d</span><span class="p">(</span><span class="n">npkd</span><span class="p">,</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="o">**</span><span class="n">kwarg</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">npkd</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s1">&#39;.*ovariance.*&#39;</span><span class="p">)</span>
            <span class="n">centroid2d</span><span class="p">(</span><span class="n">npkd</span><span class="p">,</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="o">**</span><span class="n">kwarg</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Centroid yet to be done&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">npkd</span></div>
<span class="c1">#-------------------------------------------------------</span>
<div class="viewcode-block" id="display_peaks"><a class="viewcode-back" href="../../../spike.plugins.html#spike.plugins.Peaks.display_peaks">[docs]</a><span class="k">def</span> <span class="nf">display_peaks</span><span class="p">(</span><span class="n">npkd</span><span class="p">,</span> <span class="n">peak_label</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">peak_mode</span><span class="o">=</span><span class="s2">&quot;marker&quot;</span><span class="p">,</span> <span class="n">zoom</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">figure</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">NbMaxPeaks</span><span class="o">=</span><span class="n">NbMaxDisplayPeaks</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    display the content of the peak list, </span>
<span class="sd">    peak_mode is either &quot;marker&quot; (default) or &quot;bar&quot; (1D only)</span>
<span class="sd">    zoom is in current unit.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">npkd</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">z1</span><span class="p">,</span> <span class="n">z2</span> <span class="o">=</span> <span class="n">parsezoom</span><span class="p">(</span><span class="n">npkd</span><span class="p">,</span> <span class="n">zoom</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">npkd</span><span class="o">.</span><span class="n">axis1</span><span class="o">.</span><span class="n">itype</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># if real</span>
            <span class="n">ff1</span> <span class="o">=</span> <span class="n">npkd</span><span class="o">.</span><span class="n">axis1</span><span class="o">.</span><span class="n">itoc</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ff1</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span> <span class="p">:</span> <span class="n">npkd</span><span class="o">.</span><span class="n">axis1</span><span class="o">.</span><span class="n">itoc</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">npkd</span><span class="o">.</span><span class="n">peaks</span><span class="o">.</span><span class="n">display</span><span class="p">(</span> <span class="n">peak_label</span><span class="o">=</span><span class="n">peak_label</span><span class="p">,</span> <span class="n">peak_mode</span><span class="o">=</span><span class="n">peak_mode</span><span class="p">,</span> <span class="n">zoom</span><span class="o">=</span><span class="p">(</span><span class="n">z1</span><span class="p">,</span><span class="n">z2</span><span class="p">),</span> <span class="n">show</span><span class="o">=</span><span class="n">show</span><span class="p">,</span> <span class="n">f</span><span class="o">=</span><span class="n">ff1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="n">markersize</span><span class="p">,</span> <span class="n">figure</span><span class="o">=</span><span class="n">figure</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span> <span class="n">NbMaxPeaks</span><span class="o">=</span><span class="n">NbMaxPeaks</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">npkd</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">z1lo</span><span class="p">,</span> <span class="n">z1up</span><span class="p">,</span> <span class="n">z2lo</span><span class="p">,</span> <span class="n">z2up</span> <span class="o">=</span> <span class="n">parsezoom</span><span class="p">(</span><span class="n">npkd</span><span class="p">,</span> <span class="n">zoom</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">npkd</span><span class="o">.</span><span class="n">axis1</span><span class="o">.</span><span class="n">itype</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># if real</span>
            <span class="n">ff1</span> <span class="o">=</span> <span class="n">npkd</span><span class="o">.</span><span class="n">axis1</span><span class="o">.</span><span class="n">itoc</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ff1</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span> <span class="p">:</span> <span class="n">npkd</span><span class="o">.</span><span class="n">axis1</span><span class="o">.</span><span class="n">itoc</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">x</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">npkd</span><span class="o">.</span><span class="n">axis2</span><span class="o">.</span><span class="n">itype</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># if real</span>
            <span class="n">ff2</span> <span class="o">=</span> <span class="n">npkd</span><span class="o">.</span><span class="n">axis2</span><span class="o">.</span><span class="n">itoc</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ff2</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span> <span class="p">:</span> <span class="n">npkd</span><span class="o">.</span><span class="n">axis2</span><span class="o">.</span><span class="n">itoc</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">npkd</span><span class="o">.</span><span class="n">peaks</span><span class="o">.</span><span class="n">display</span><span class="p">(</span> <span class="n">peak_label</span><span class="o">=</span><span class="n">peak_label</span><span class="p">,</span> <span class="n">zoom</span><span class="o">=</span><span class="p">((</span><span class="n">z1lo</span><span class="p">,</span><span class="n">z1up</span><span class="p">),(</span><span class="n">z2lo</span><span class="p">,</span><span class="n">z2up</span><span class="p">)),</span> <span class="n">show</span><span class="o">=</span><span class="n">show</span><span class="p">,</span> <span class="n">f1</span><span class="o">=</span><span class="n">ff1</span><span class="p">,</span> <span class="n">f2</span><span class="o">=</span><span class="n">ff2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="n">markersize</span><span class="p">,</span> <span class="n">figure</span><span class="o">=</span><span class="n">figure</span><span class="p">,</span> <span class="n">NbMaxPeaks</span><span class="o">=</span><span class="n">NbMaxPeaks</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;to be done&quot;</span><span class="p">)</span></div>
<span class="c1">#-------------------------------------------------------</span>
<div class="viewcode-block" id="report_peaks"><a class="viewcode-back" href="../../../spike.plugins.html#spike.plugins.Peaks.report_peaks">[docs]</a><span class="k">def</span> <span class="nf">report_peaks</span><span class="p">(</span><span class="n">npkd</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">NbMaxPeaks</span><span class="o">=</span><span class="n">NbMaxDisplayPeaks</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    print the content of the peak list, using the current unit</span>
<span class="sd">    </span>
<span class="sd">    if file should be an already opened writable file stream. </span>
<span class="sd">    if None, output will go to stdout</span>
<span class="sd">    </span>
<span class="sd">    for documentation, check Peak1D.report() and Peak2D.report()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">npkd</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">npkd</span><span class="o">.</span><span class="n">axis1</span><span class="o">.</span><span class="n">itype</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># if real</span>
            <span class="n">ff1</span> <span class="o">=</span> <span class="n">npkd</span><span class="o">.</span><span class="n">axis1</span><span class="o">.</span><span class="n">itoc</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ff1</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span> <span class="p">:</span> <span class="n">npkd</span><span class="o">.</span><span class="n">axis1</span><span class="o">.</span><span class="n">itoc</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">npkd</span><span class="o">.</span><span class="n">peaks</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="n">f</span><span class="o">=</span><span class="n">ff1</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">file</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="nb">format</span><span class="p">,</span> <span class="n">NbMaxPeaks</span><span class="o">=</span><span class="n">NbMaxPeaks</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">npkd</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">npkd</span><span class="o">.</span><span class="n">axis1</span><span class="o">.</span><span class="n">itype</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># if real</span>
            <span class="n">ff1</span> <span class="o">=</span> <span class="n">npkd</span><span class="o">.</span><span class="n">axis1</span><span class="o">.</span><span class="n">itoc</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ff1</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span> <span class="p">:</span> <span class="n">npkd</span><span class="o">.</span><span class="n">axis1</span><span class="o">.</span><span class="n">itoc</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">x</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">npkd</span><span class="o">.</span><span class="n">axis2</span><span class="o">.</span><span class="n">itype</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># if real</span>
            <span class="n">ff2</span> <span class="o">=</span> <span class="n">npkd</span><span class="o">.</span><span class="n">axis2</span><span class="o">.</span><span class="n">itoc</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ff2</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span> <span class="p">:</span> <span class="n">npkd</span><span class="o">.</span><span class="n">axis2</span><span class="o">.</span><span class="n">itoc</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">npkd</span><span class="o">.</span><span class="n">peaks</span><span class="o">.</span><span class="n">report</span><span class="p">(</span> <span class="n">f1</span><span class="o">=</span><span class="n">ff1</span><span class="p">,</span> <span class="n">f2</span><span class="o">=</span><span class="n">ff2</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">file</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="nb">format</span><span class="p">,</span> <span class="n">NbMaxPeaks</span><span class="o">=</span><span class="n">NbMaxPeaks</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;to be done&quot;</span><span class="p">)</span></div>
<span class="c1">#-------------------------------------------------------</span>
<div class="viewcode-block" id="pk2pandas"><a class="viewcode-back" href="../../../spike.plugins.html#spike.plugins.Peaks.pk2pandas">[docs]</a><span class="k">def</span> <span class="nf">pk2pandas</span><span class="p">(</span><span class="n">npkd</span><span class="p">,</span> <span class="n">full</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;export extract of current peak list to pandas Dataframe - in current unit</span>
<span class="sd">    if full is False (default), the uncertainty are not listed</span>
<span class="sd">    uses nmr or ms version depending on data_type</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">spike.FTMS</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">npkd</span><span class="p">,</span> <span class="n">spike</span><span class="o">.</span><span class="n">FTMS</span><span class="o">.</span><span class="n">FTMSData</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">pk2pandas_ms</span><span class="p">(</span><span class="n">npkd</span><span class="p">,</span> <span class="n">full</span><span class="o">=</span><span class="n">full</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">pk2pandas_nmr</span><span class="p">(</span><span class="n">npkd</span><span class="p">,</span> <span class="n">full</span><span class="o">=</span><span class="n">full</span><span class="p">)</span></div>
<div class="viewcode-block" id="pk2pandas_ms"><a class="viewcode-back" href="../../../spike.plugins.html#spike.plugins.Peaks.pk2pandas_ms">[docs]</a><span class="k">def</span> <span class="nf">pk2pandas_ms</span><span class="p">(</span><span class="n">npkd</span><span class="p">,</span> <span class="n">full</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="s2">&quot;export extract of current peak list to pandas Dataframe for MS datasets&quot;</span>
    <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
    <span class="k">if</span> <span class="n">npkd</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">width</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">pk</span><span class="o">.</span><span class="n">width</span> <span class="k">for</span> <span class="n">pk</span> <span class="ow">in</span> <span class="n">npkd</span><span class="o">.</span><span class="n">peaks</span><span class="p">])</span>   <span class="c1"># width have to be computed in m/z</span>
        <span class="n">width_array</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="nb">abs</span><span class="p">(</span><span class="n">npkd</span><span class="o">.</span><span class="n">axis1</span><span class="o">.</span><span class="n">itoc</span><span class="p">(</span><span class="n">npkd</span><span class="o">.</span><span class="n">peaks</span><span class="o">.</span><span class="n">pos</span><span class="o">+</span><span class="n">width</span><span class="p">)</span> <span class="o">-</span> <span class="n">npkd</span><span class="o">.</span><span class="n">axis1</span><span class="o">.</span><span class="n">itoc</span><span class="p">(</span><span class="n">npkd</span><span class="o">.</span><span class="n">peaks</span><span class="o">.</span><span class="n">pos</span><span class="o">-</span><span class="n">width</span><span class="p">))</span>
        <span class="n">width_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">width_array</span><span class="o">==</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span><span class="p">,</span> <span class="n">width_array</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">full</span><span class="p">:</span>
            <span class="n">err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">pk</span><span class="o">.</span><span class="n">pos_err</span> <span class="k">for</span> <span class="n">pk</span> <span class="ow">in</span> <span class="n">npkd</span><span class="o">.</span><span class="n">peaks</span><span class="p">])</span>
            <span class="n">pos_err_array</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="nb">abs</span><span class="p">(</span><span class="n">npkd</span><span class="o">.</span><span class="n">axis1</span><span class="o">.</span><span class="n">itoc</span><span class="p">(</span><span class="n">npkd</span><span class="o">.</span><span class="n">peaks</span><span class="o">.</span><span class="n">pos</span><span class="o">+</span><span class="n">err</span><span class="p">)</span> <span class="o">-</span> <span class="n">npkd</span><span class="o">.</span><span class="n">axis1</span><span class="o">.</span><span class="n">itoc</span><span class="p">(</span><span class="n">npkd</span><span class="o">.</span><span class="n">peaks</span><span class="o">.</span><span class="n">pos</span><span class="o">-</span><span class="n">err</span><span class="p">))</span>
            <span class="n">P1</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
                <span class="s1">&#39;Id&#39;</span><span class="p">:[</span> <span class="n">pk</span><span class="o">.</span><span class="n">Id</span> <span class="k">for</span> <span class="n">pk</span> <span class="ow">in</span> <span class="n">npkd</span><span class="o">.</span><span class="n">peaks</span><span class="p">],</span>
                <span class="s1">&#39;Label&#39;</span><span class="p">:</span><span class="n">npkd</span><span class="o">.</span><span class="n">peaks</span><span class="o">.</span><span class="n">label</span><span class="p">,</span>
                <span class="s1">&#39;m/z&#39;</span><span class="p">:</span><span class="n">npkd</span><span class="o">.</span><span class="n">axis1</span><span class="o">.</span><span class="n">itoc</span><span class="p">(</span><span class="n">npkd</span><span class="o">.</span><span class="n">peaks</span><span class="o">.</span><span class="n">pos</span><span class="p">),</span>
                <span class="sa">u</span><span class="s1">&#39;Δm/z&#39;</span><span class="p">:</span><span class="n">width_array</span><span class="p">,</span>
                <span class="s1">&#39;R&#39;</span><span class="p">:</span>  <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">npkd</span><span class="o">.</span><span class="n">axis1</span><span class="o">.</span><span class="n">itoc</span><span class="p">(</span><span class="n">npkd</span><span class="o">.</span><span class="n">peaks</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span><span class="o">/</span><span class="n">width_array</span><span class="p">,</span><span class="o">-</span><span class="mi">3</span><span class="p">),</span>
                <span class="s1">&#39;Intensity&#39;</span><span class="p">:</span><span class="n">npkd</span><span class="o">.</span><span class="n">peaks</span><span class="o">.</span><span class="n">intens</span><span class="p">,</span>
                <span class="sa">u</span><span class="s1">&#39;ε_m/z&#39;</span><span class="p">:</span> <span class="n">pos_err_array</span><span class="p">,</span>
                <span class="sa">u</span><span class="s1">&#39;ε_Intensity&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">pk</span><span class="o">.</span><span class="n">intens_err</span> <span class="k">for</span> <span class="n">pk</span> <span class="ow">in</span> <span class="n">npkd</span><span class="o">.</span><span class="n">peaks</span><span class="p">]</span>
            <span class="p">})</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;Id&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">P1</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
                <span class="s1">&#39;Id&#39;</span><span class="p">:[</span> <span class="n">pk</span><span class="o">.</span><span class="n">Id</span> <span class="k">for</span> <span class="n">pk</span> <span class="ow">in</span> <span class="n">npkd</span><span class="o">.</span><span class="n">peaks</span><span class="p">],</span>
                <span class="s1">&#39;Label&#39;</span><span class="p">:</span><span class="n">npkd</span><span class="o">.</span><span class="n">peaks</span><span class="o">.</span><span class="n">label</span><span class="p">,</span>
                <span class="s1">&#39;m/z&#39;</span><span class="p">:</span><span class="n">npkd</span><span class="o">.</span><span class="n">axis1</span><span class="o">.</span><span class="n">itoc</span><span class="p">(</span><span class="n">npkd</span><span class="o">.</span><span class="n">peaks</span><span class="o">.</span><span class="n">pos</span><span class="p">),</span>
                <span class="sa">u</span><span class="s1">&#39;Δm/z&#39;</span><span class="p">:</span><span class="n">width_array</span><span class="p">,</span>
                <span class="s1">&#39;R&#39;</span><span class="p">:</span>  <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">npkd</span><span class="o">.</span><span class="n">axis1</span><span class="o">.</span><span class="n">itoc</span><span class="p">(</span><span class="n">npkd</span><span class="o">.</span><span class="n">peaks</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span><span class="o">/</span><span class="n">width_array</span><span class="p">,</span><span class="o">-</span><span class="mi">3</span><span class="p">),</span>
                <span class="s1">&#39;Intensity&#39;</span><span class="p">:</span><span class="n">npkd</span><span class="o">.</span><span class="n">peaks</span><span class="o">.</span><span class="n">intens</span>
            <span class="p">})</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;Id&#39;</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">npkd</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="c1"># width in m/z</span>
        <span class="n">width1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">pk</span><span class="o">.</span><span class="n">widthF1</span> <span class="k">for</span> <span class="n">pk</span> <span class="ow">in</span> <span class="n">npkd</span><span class="o">.</span><span class="n">peaks</span><span class="p">])</span>   <span class="c1"># width have to be computed in m/z</span>
        <span class="n">width1_array</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="nb">abs</span><span class="p">(</span><span class="n">npkd</span><span class="o">.</span><span class="n">axis1</span><span class="o">.</span><span class="n">itoc</span><span class="p">(</span><span class="n">npkd</span><span class="o">.</span><span class="n">peaks</span><span class="o">.</span><span class="n">pos</span><span class="o">+</span><span class="n">npkd</span><span class="o">.</span><span class="n">peaks</span><span class="o">.</span><span class="n">width1</span><span class="p">)</span> <span class="o">-</span> <span class="n">npkd</span><span class="o">.</span><span class="n">axis1</span><span class="o">.</span><span class="n">itoc</span><span class="p">(</span><span class="n">npkd</span><span class="o">.</span><span class="n">peaks</span><span class="o">.</span><span class="n">pos</span><span class="o">-</span><span class="n">npkd</span><span class="o">.</span><span class="n">peaks</span><span class="o">.</span><span class="n">width1</span><span class="p">))</span>
        <span class="n">width2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">pk</span><span class="o">.</span><span class="n">widthF2</span> <span class="k">for</span> <span class="n">pk</span> <span class="ow">in</span> <span class="n">npkd</span><span class="o">.</span><span class="n">peaks</span><span class="p">])</span>   <span class="c1"># width have to be computed in m/z</span>
        <span class="n">width2_array</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="nb">abs</span><span class="p">(</span><span class="n">npkd</span><span class="o">.</span><span class="n">axis2</span><span class="o">.</span><span class="n">itoc</span><span class="p">(</span><span class="n">npkd</span><span class="o">.</span><span class="n">peaks</span><span class="o">.</span><span class="n">pos</span><span class="o">+</span><span class="n">npkd</span><span class="o">.</span><span class="n">peaks</span><span class="o">.</span><span class="n">width2</span><span class="p">)</span> <span class="o">-</span> <span class="n">npkd</span><span class="o">.</span><span class="n">axis2</span><span class="o">.</span><span class="n">itoc</span><span class="p">(</span><span class="n">npkd</span><span class="o">.</span><span class="n">peaks</span><span class="o">.</span><span class="n">pos</span><span class="o">-</span><span class="n">npkd</span><span class="o">.</span><span class="n">peaks</span><span class="o">.</span><span class="n">width2</span><span class="p">))</span>

        <span class="c1"># then R</span>
        <span class="n">R1</span> <span class="o">=</span>  <span class="n">npkd</span><span class="o">.</span><span class="n">axis1</span><span class="o">.</span><span class="n">itoc</span><span class="p">(</span><span class="n">npkd</span><span class="o">.</span><span class="n">peaks</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span><span class="o">/</span><span class="n">width1_array</span>
        <span class="n">R2</span> <span class="o">=</span>  <span class="n">npkd</span><span class="o">.</span><span class="n">axis2</span><span class="o">.</span><span class="n">itoc</span><span class="p">(</span><span class="n">npkd</span><span class="o">.</span><span class="n">peaks</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span><span class="o">/</span><span class="n">width2_array</span>
        <span class="k">if</span> <span class="n">full</span><span class="p">:</span>
            <span class="c1"># then for position_error to current unit</span>
            <span class="n">err1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">pk</span><span class="o">.</span><span class="n">posF1_err</span> <span class="k">for</span> <span class="n">pk</span> <span class="ow">in</span> <span class="n">npkd</span><span class="o">.</span><span class="n">peaks</span><span class="p">])</span>
            <span class="n">err2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">pk</span><span class="o">.</span><span class="n">posF2_err</span> <span class="k">for</span> <span class="n">pk</span> <span class="ow">in</span> <span class="n">npkd</span><span class="o">.</span><span class="n">peaks</span><span class="p">])</span>
            <span class="n">pos1_err_array</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="nb">abs</span><span class="p">(</span><span class="n">npkd</span><span class="o">.</span><span class="n">axis1</span><span class="o">.</span><span class="n">itoc</span><span class="p">(</span><span class="n">npkd</span><span class="o">.</span><span class="n">peaks</span><span class="o">.</span><span class="n">posF1</span><span class="o">+</span><span class="n">err1</span><span class="p">)</span> <span class="o">-</span> <span class="n">npkd</span><span class="o">.</span><span class="n">axis1</span><span class="o">.</span><span class="n">itoc</span><span class="p">(</span><span class="n">npkd</span><span class="o">.</span><span class="n">peaks</span><span class="o">.</span><span class="n">posF1</span><span class="o">-</span><span class="n">err1</span><span class="p">))</span>
            <span class="n">pos2_err_array</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="nb">abs</span><span class="p">(</span><span class="n">npkd</span><span class="o">.</span><span class="n">axis2</span><span class="o">.</span><span class="n">itoc</span><span class="p">(</span><span class="n">npkd</span><span class="o">.</span><span class="n">peaks</span><span class="o">.</span><span class="n">posF2</span><span class="o">+</span><span class="n">err2</span><span class="p">)</span> <span class="o">-</span> <span class="n">npkd</span><span class="o">.</span><span class="n">axis2</span><span class="o">.</span><span class="n">itoc</span><span class="p">(</span><span class="n">npkd</span><span class="o">.</span><span class="n">peaks</span><span class="o">.</span><span class="n">posF2</span><span class="o">-</span><span class="n">err2</span><span class="p">))</span>
            <span class="n">P1</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
                <span class="s1">&#39;Id&#39;</span><span class="p">:[</span> <span class="n">pk</span><span class="o">.</span><span class="n">Id</span> <span class="k">for</span> <span class="n">pk</span> <span class="ow">in</span> <span class="n">npkd</span><span class="o">.</span><span class="n">peaks</span><span class="p">],</span>
                <span class="s1">&#39;Label&#39;</span><span class="p">:</span><span class="n">npkd</span><span class="o">.</span><span class="n">peaks</span><span class="o">.</span><span class="n">label</span><span class="p">,</span>
                <span class="s1">&#39;m/z F1&#39;</span><span class="p">:</span><span class="n">npkd</span><span class="o">.</span><span class="n">axis1</span><span class="o">.</span><span class="n">itoc</span><span class="p">(</span><span class="n">npkd</span><span class="o">.</span><span class="n">peaks</span><span class="o">.</span><span class="n">posF1</span><span class="p">),</span>
                <span class="s1">&#39;m/z F2&#39;</span><span class="p">:</span><span class="n">npkd</span><span class="o">.</span><span class="n">axis2</span><span class="o">.</span><span class="n">itoc</span><span class="p">(</span><span class="n">npkd</span><span class="o">.</span><span class="n">peaks</span><span class="o">.</span><span class="n">posF2</span><span class="p">),</span>
                <span class="s1">&#39;Intensity&#39;</span><span class="p">:</span><span class="n">npkd</span><span class="o">.</span><span class="n">peaks</span><span class="o">.</span><span class="n">intens</span><span class="p">,</span>
                <span class="sa">u</span><span class="s1">&#39;Δm/z F1&#39;</span><span class="p">:</span><span class="n">width1_array</span><span class="p">,</span>
                <span class="sa">u</span><span class="s1">&#39;Δm/z F2&#39;</span><span class="p">:</span><span class="n">width2_array</span><span class="p">,</span>
                <span class="s1">&#39;R1&#39;</span><span class="p">:</span>  <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">R1</span><span class="p">,</span><span class="o">-</span><span class="mi">3</span><span class="p">),</span>
                <span class="s1">&#39;R2&#39;</span><span class="p">:</span>  <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">R1</span><span class="p">,</span><span class="o">-</span><span class="mi">3</span><span class="p">),</span>
                <span class="s1">&#39;R *1E6&#39;</span><span class="p">:</span>  <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">R1</span><span class="o">*</span><span class="n">R2</span><span class="o">/</span><span class="mf">1E6</span><span class="p">,</span><span class="o">-</span><span class="mi">3</span><span class="p">),</span>
                <span class="sa">u</span><span class="s1">&#39;ε_m/z F1&#39;</span><span class="p">:</span> <span class="n">pos1_err_array</span><span class="p">,</span>
                <span class="sa">u</span><span class="s1">&#39;ε_m/z F2&#39;</span><span class="p">:</span> <span class="n">pos2_err_array</span><span class="p">,</span>
                <span class="sa">u</span><span class="s1">&#39;ε_Intensity&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">pk</span><span class="o">.</span><span class="n">intens_err</span> <span class="k">for</span> <span class="n">pk</span> <span class="ow">in</span> <span class="n">npkd</span><span class="o">.</span><span class="n">peaks</span><span class="p">]</span>
            <span class="p">})</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;Id&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">P1</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
                <span class="s1">&#39;Id&#39;</span><span class="p">:[</span> <span class="n">pk</span><span class="o">.</span><span class="n">Id</span> <span class="k">for</span> <span class="n">pk</span> <span class="ow">in</span> <span class="n">npkd</span><span class="o">.</span><span class="n">peaks</span><span class="p">],</span>
                <span class="s1">&#39;Label&#39;</span><span class="p">:</span><span class="n">npkd</span><span class="o">.</span><span class="n">peaks</span><span class="o">.</span><span class="n">label</span><span class="p">,</span>
                <span class="s1">&#39;m/z F1&#39;</span><span class="p">:</span><span class="n">npkd</span><span class="o">.</span><span class="n">axis1</span><span class="o">.</span><span class="n">itoc</span><span class="p">(</span><span class="n">npkd</span><span class="o">.</span><span class="n">peaks</span><span class="o">.</span><span class="n">posF1</span><span class="p">),</span>
                <span class="s1">&#39;m/z F2&#39;</span><span class="p">:</span><span class="n">npkd</span><span class="o">.</span><span class="n">axis2</span><span class="o">.</span><span class="n">itoc</span><span class="p">(</span><span class="n">npkd</span><span class="o">.</span><span class="n">peaks</span><span class="o">.</span><span class="n">posF2</span><span class="p">),</span>
                <span class="s1">&#39;Intensity&#39;</span><span class="p">:</span><span class="n">npkd</span><span class="o">.</span><span class="n">peaks</span><span class="o">.</span><span class="n">intens</span><span class="p">,</span>
                <span class="sa">u</span><span class="s1">&#39;Δm/z F1&#39;</span><span class="p">:</span><span class="n">width1_array</span><span class="p">,</span>
                <span class="sa">u</span><span class="s1">&#39;Δm/z F2&#39;</span><span class="p">:</span><span class="n">width2_array</span><span class="p">,</span>
                <span class="s1">&#39;R1&#39;</span><span class="p">:</span>  <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">R1</span><span class="p">,</span><span class="o">-</span><span class="mi">3</span><span class="p">),</span>
                <span class="s1">&#39;R2&#39;</span><span class="p">:</span>  <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">R1</span><span class="p">,</span><span class="o">-</span><span class="mi">3</span><span class="p">),</span>
                <span class="s1">&#39;R *1E6&#39;</span><span class="p">:</span>  <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">R1</span><span class="o">*</span><span class="n">R2</span><span class="o">/</span><span class="mf">1E6</span><span class="p">,</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span>
            <span class="p">})</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;Id&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Not implemented in 3D yet&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">P1</span></div>
<div class="viewcode-block" id="pk2pandas_nmr"><a class="viewcode-back" href="../../../spike.plugins.html#spike.plugins.Peaks.pk2pandas_nmr">[docs]</a><span class="k">def</span> <span class="nf">pk2pandas_nmr</span><span class="p">(</span><span class="n">npkd</span><span class="p">,</span> <span class="n">full</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="s2">&quot;export extract of current peak list to pandas Dataframe for NMR datasets&quot;</span>
    <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
    <span class="k">if</span> <span class="n">npkd</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">w_itohz</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">npkd</span><span class="o">.</span><span class="n">axis1</span><span class="o">.</span><span class="n">specwidth</span><span class="o">/</span><span class="n">npkd</span><span class="o">.</span><span class="n">cpxsize1</span>   <span class="c1"># for width: points to Hz</span>
        <span class="c1"># then for position_error to current unit</span>
        <span class="n">err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">pk</span><span class="o">.</span><span class="n">pos_err</span> <span class="k">for</span> <span class="n">pk</span> <span class="ow">in</span> <span class="n">npkd</span><span class="o">.</span><span class="n">peaks</span><span class="p">])</span>
        <span class="n">pos_err_array</span> <span class="o">=</span> <span class="n">npkd</span><span class="o">.</span><span class="n">axis1</span><span class="o">.</span><span class="n">itoc</span><span class="p">(</span><span class="n">npkd</span><span class="o">.</span><span class="n">peaks</span><span class="o">.</span><span class="n">pos</span><span class="o">+</span><span class="n">err</span><span class="p">)</span> <span class="o">-</span> <span class="n">npkd</span><span class="o">.</span><span class="n">axis1</span><span class="o">.</span><span class="n">itoc</span><span class="p">(</span><span class="n">npkd</span><span class="o">.</span><span class="n">peaks</span><span class="o">.</span><span class="n">pos</span><span class="o">-</span><span class="n">err</span><span class="p">)</span>
        <span class="n">pos_err_array</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">pos_err_array</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">full</span><span class="p">:</span>
            <span class="n">P1</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
                <span class="s1">&#39;Id&#39;</span><span class="p">:[</span> <span class="n">pk</span><span class="o">.</span><span class="n">Id</span> <span class="k">for</span> <span class="n">pk</span> <span class="ow">in</span> <span class="n">npkd</span><span class="o">.</span><span class="n">peaks</span><span class="p">],</span>
                <span class="s1">&#39;Label&#39;</span><span class="p">:</span><span class="n">npkd</span><span class="o">.</span><span class="n">peaks</span><span class="o">.</span><span class="n">label</span><span class="p">,</span>
                <span class="s1">&#39;Position&#39;</span><span class="p">:</span><span class="n">npkd</span><span class="o">.</span><span class="n">axis1</span><span class="o">.</span><span class="n">itoc</span><span class="p">(</span><span class="n">npkd</span><span class="o">.</span><span class="n">peaks</span><span class="o">.</span><span class="n">pos</span><span class="p">),</span>
                <span class="s1">&#39;Intensity&#39;</span><span class="p">:</span><span class="n">npkd</span><span class="o">.</span><span class="n">peaks</span><span class="o">.</span><span class="n">intens</span><span class="p">,</span>
                <span class="s1">&#39;Width&#39;</span><span class="p">:[</span> <span class="n">pk</span><span class="o">.</span><span class="n">width</span><span class="o">*</span><span class="n">w_itohz</span> <span class="k">for</span> <span class="n">pk</span> <span class="ow">in</span> <span class="n">npkd</span><span class="o">.</span><span class="n">peaks</span><span class="p">],</span>   <span class="c1"># width are in Hz</span>
                <span class="s1">&#39;Position_err&#39;</span><span class="p">:</span> <span class="n">pos_err_array</span><span class="p">,</span>
                <span class="s1">&#39;Intensity_err&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">pk</span><span class="o">.</span><span class="n">intens_err</span> <span class="k">for</span> <span class="n">pk</span> <span class="ow">in</span> <span class="n">npkd</span><span class="o">.</span><span class="n">peaks</span><span class="p">],</span>
                <span class="s1">&#39;Width_err&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">pk</span><span class="o">.</span><span class="n">width_err</span><span class="o">*</span><span class="n">w_itohz</span> <span class="k">for</span> <span class="n">pk</span> <span class="ow">in</span> <span class="n">npkd</span><span class="o">.</span><span class="n">peaks</span><span class="p">]</span>   <span class="c1"># width are in Hz</span>
            <span class="p">})</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;Id&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">P1</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
                <span class="s1">&#39;Id&#39;</span><span class="p">:[</span> <span class="n">pk</span><span class="o">.</span><span class="n">Id</span> <span class="k">for</span> <span class="n">pk</span> <span class="ow">in</span> <span class="n">npkd</span><span class="o">.</span><span class="n">peaks</span><span class="p">],</span>
                <span class="s1">&#39;Label&#39;</span><span class="p">:</span><span class="n">npkd</span><span class="o">.</span><span class="n">peaks</span><span class="o">.</span><span class="n">label</span><span class="p">,</span>
                <span class="s1">&#39;Position&#39;</span><span class="p">:</span><span class="n">npkd</span><span class="o">.</span><span class="n">axis1</span><span class="o">.</span><span class="n">itoc</span><span class="p">(</span><span class="n">npkd</span><span class="o">.</span><span class="n">peaks</span><span class="o">.</span><span class="n">pos</span><span class="p">),</span>
                <span class="s1">&#39;Intensity&#39;</span><span class="p">:</span><span class="n">npkd</span><span class="o">.</span><span class="n">peaks</span><span class="o">.</span><span class="n">intens</span><span class="p">,</span>
                <span class="s1">&#39;Width&#39;</span><span class="p">:[</span> <span class="n">pk</span><span class="o">.</span><span class="n">width</span><span class="o">*</span><span class="n">w_itohz</span> <span class="k">for</span> <span class="n">pk</span> <span class="ow">in</span> <span class="n">npkd</span><span class="o">.</span><span class="n">peaks</span><span class="p">]</span>   <span class="c1"># width are in Hz</span>
            <span class="p">})</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;Id&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">npkd</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">w_itohz1</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">npkd</span><span class="o">.</span><span class="n">axis1</span><span class="o">.</span><span class="n">specwidth</span><span class="o">/</span><span class="n">npkd</span><span class="o">.</span><span class="n">cpxsize1</span>   <span class="c1"># for width: points to Hz</span>
        <span class="n">w_itohz2</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">npkd</span><span class="o">.</span><span class="n">axis2</span><span class="o">.</span><span class="n">specwidth</span><span class="o">/</span><span class="n">npkd</span><span class="o">.</span><span class="n">cpxsize2</span>
        <span class="c1"># then for position_error to current unit</span>
        <span class="n">err1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">pk</span><span class="o">.</span><span class="n">posF1_err</span> <span class="k">for</span> <span class="n">pk</span> <span class="ow">in</span> <span class="n">npkd</span><span class="o">.</span><span class="n">peaks</span><span class="p">])</span>
        <span class="n">err2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">pk</span><span class="o">.</span><span class="n">posF2_err</span> <span class="k">for</span> <span class="n">pk</span> <span class="ow">in</span> <span class="n">npkd</span><span class="o">.</span><span class="n">peaks</span><span class="p">])</span>
        <span class="n">pos1_err_array</span> <span class="o">=</span> <span class="n">npkd</span><span class="o">.</span><span class="n">axis1</span><span class="o">.</span><span class="n">itoc</span><span class="p">(</span><span class="n">npkd</span><span class="o">.</span><span class="n">peaks</span><span class="o">.</span><span class="n">posF1</span><span class="o">+</span><span class="n">err1</span><span class="p">)</span> <span class="o">-</span> <span class="n">npkd</span><span class="o">.</span><span class="n">axis1</span><span class="o">.</span><span class="n">itoc</span><span class="p">(</span><span class="n">npkd</span><span class="o">.</span><span class="n">peaks</span><span class="o">.</span><span class="n">posF1</span><span class="o">-</span><span class="n">err1</span><span class="p">)</span>
        <span class="n">pos2_err_array</span> <span class="o">=</span> <span class="n">npkd</span><span class="o">.</span><span class="n">axis2</span><span class="o">.</span><span class="n">itoc</span><span class="p">(</span><span class="n">npkd</span><span class="o">.</span><span class="n">peaks</span><span class="o">.</span><span class="n">posF2</span><span class="o">+</span><span class="n">err2</span><span class="p">)</span> <span class="o">-</span> <span class="n">npkd</span><span class="o">.</span><span class="n">axis2</span><span class="o">.</span><span class="n">itoc</span><span class="p">(</span><span class="n">npkd</span><span class="o">.</span><span class="n">peaks</span><span class="o">.</span><span class="n">posF2</span><span class="o">-</span><span class="n">err2</span><span class="p">)</span>
        <span class="n">pos1_err_array</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">pos1_err_array</span><span class="p">)</span>
        <span class="n">pos2_err_array</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">pos2_err_array</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">full</span><span class="p">:</span>
            <span class="n">P1</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
                <span class="s1">&#39;Id&#39;</span><span class="p">:[</span> <span class="n">pk</span><span class="o">.</span><span class="n">Id</span> <span class="k">for</span> <span class="n">pk</span> <span class="ow">in</span> <span class="n">npkd</span><span class="o">.</span><span class="n">peaks</span><span class="p">],</span>
                <span class="s1">&#39;Label&#39;</span><span class="p">:</span><span class="n">npkd</span><span class="o">.</span><span class="n">peaks</span><span class="o">.</span><span class="n">label</span><span class="p">,</span>
                <span class="s1">&#39;Position F1&#39;</span><span class="p">:</span><span class="n">npkd</span><span class="o">.</span><span class="n">axis1</span><span class="o">.</span><span class="n">itoc</span><span class="p">(</span><span class="n">npkd</span><span class="o">.</span><span class="n">peaks</span><span class="o">.</span><span class="n">posF1</span><span class="p">),</span>
                <span class="s1">&#39;Position F2&#39;</span><span class="p">:</span><span class="n">npkd</span><span class="o">.</span><span class="n">axis2</span><span class="o">.</span><span class="n">itoc</span><span class="p">(</span><span class="n">npkd</span><span class="o">.</span><span class="n">peaks</span><span class="o">.</span><span class="n">posF2</span><span class="p">),</span>
                <span class="s1">&#39;Intensity&#39;</span><span class="p">:</span><span class="n">npkd</span><span class="o">.</span><span class="n">peaks</span><span class="o">.</span><span class="n">intens</span><span class="p">,</span>
                <span class="s1">&#39;Width F1&#39;</span><span class="p">:[</span> <span class="n">pk</span><span class="o">.</span><span class="n">widthF1</span><span class="o">*</span><span class="n">w_itohz1</span> <span class="k">for</span> <span class="n">pk</span> <span class="ow">in</span> <span class="n">npkd</span><span class="o">.</span><span class="n">peaks</span><span class="p">],</span>   <span class="c1"># width are in Hz</span>
                <span class="s1">&#39;Width F2&#39;</span><span class="p">:[</span> <span class="n">pk</span><span class="o">.</span><span class="n">widthF2</span><span class="o">*</span><span class="n">w_itohz2</span> <span class="k">for</span> <span class="n">pk</span> <span class="ow">in</span> <span class="n">npkd</span><span class="o">.</span><span class="n">peaks</span><span class="p">],</span>
                <span class="s1">&#39;Position_err F1&#39;</span><span class="p">:</span> <span class="n">pos1_err_array</span><span class="p">,</span>
                <span class="s1">&#39;Position_err F2&#39;</span><span class="p">:</span> <span class="n">pos2_err_array</span><span class="p">,</span>
                <span class="s1">&#39;Intensity_err&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">pk</span><span class="o">.</span><span class="n">intens_err</span> <span class="k">for</span> <span class="n">pk</span> <span class="ow">in</span> <span class="n">npkd</span><span class="o">.</span><span class="n">peaks</span><span class="p">],</span>
                <span class="s1">&#39;Width_err F1&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">pk</span><span class="o">.</span><span class="n">widthF1_err</span><span class="o">*</span><span class="n">w_itohz1</span> <span class="k">for</span> <span class="n">pk</span> <span class="ow">in</span> <span class="n">npkd</span><span class="o">.</span><span class="n">peaks</span><span class="p">],</span>   <span class="c1"># width are in Hz</span>
                <span class="s1">&#39;Width_err F2&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">pk</span><span class="o">.</span><span class="n">widthF2_err</span><span class="o">*</span><span class="n">w_itohz1</span> <span class="k">for</span> <span class="n">pk</span> <span class="ow">in</span> <span class="n">npkd</span><span class="o">.</span><span class="n">peaks</span><span class="p">]</span>
            <span class="p">})</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;Id&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">P1</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
                <span class="s1">&#39;Id&#39;</span><span class="p">:[</span> <span class="n">pk</span><span class="o">.</span><span class="n">Id</span> <span class="k">for</span> <span class="n">pk</span> <span class="ow">in</span> <span class="n">npkd</span><span class="o">.</span><span class="n">peaks</span><span class="p">],</span>
                <span class="s1">&#39;Label&#39;</span><span class="p">:</span><span class="n">npkd</span><span class="o">.</span><span class="n">peaks</span><span class="o">.</span><span class="n">label</span><span class="p">,</span>
                <span class="s1">&#39;Position F1&#39;</span><span class="p">:</span><span class="n">npkd</span><span class="o">.</span><span class="n">axis1</span><span class="o">.</span><span class="n">itoc</span><span class="p">(</span><span class="n">npkd</span><span class="o">.</span><span class="n">peaks</span><span class="o">.</span><span class="n">posF1</span><span class="p">),</span>
                <span class="s1">&#39;Position F2&#39;</span><span class="p">:</span><span class="n">npkd</span><span class="o">.</span><span class="n">axis2</span><span class="o">.</span><span class="n">itoc</span><span class="p">(</span><span class="n">npkd</span><span class="o">.</span><span class="n">peaks</span><span class="o">.</span><span class="n">posF2</span><span class="p">),</span>
                <span class="s1">&#39;Intensity&#39;</span><span class="p">:</span><span class="n">npkd</span><span class="o">.</span><span class="n">peaks</span><span class="o">.</span><span class="n">intens</span><span class="p">,</span>
                <span class="s1">&#39;Width F1&#39;</span><span class="p">:[</span> <span class="n">pk</span><span class="o">.</span><span class="n">widthF1</span><span class="o">*</span><span class="n">w_itohz1</span> <span class="k">for</span> <span class="n">pk</span> <span class="ow">in</span> <span class="n">npkd</span><span class="o">.</span><span class="n">peaks</span><span class="p">],</span>   <span class="c1"># width are in Hz</span>
                <span class="s1">&#39;Width F2&#39;</span><span class="p">:[</span> <span class="n">pk</span><span class="o">.</span><span class="n">widthF2</span><span class="o">*</span><span class="n">w_itohz2</span> <span class="k">for</span> <span class="n">pk</span> <span class="ow">in</span> <span class="n">npkd</span><span class="o">.</span><span class="n">peaks</span><span class="p">]</span>
            <span class="p">})</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;Id&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Not implemented in 3D yet&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">P1</span></div>

<div class="viewcode-block" id="PeakTests"><a class="viewcode-back" href="../../../spike.plugins.html#spike.plugins.Peaks.PeakTests">[docs]</a><span class="k">class</span> <span class="nc">PeakTests</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
<div class="viewcode-block" id="PeakTests.test_peaks2d"><a class="viewcode-back" href="../../../spike.plugins.html#spike.plugins.Peaks.PeakTests.test_peaks2d">[docs]</a>    <span class="k">def</span> <span class="nf">test_peaks2d</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;test 2D peak picker&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_peaks2d</span><span class="o">.</span><span class="vm">__doc__</span><span class="p">)</span>
        <span class="n">M</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">30</span><span class="p">,</span> <span class="mi">30</span><span class="p">))</span>
        <span class="n">M</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mi">20</span>
        <span class="n">M</span><span class="p">[</span><span class="mi">10</span><span class="p">,</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="mi">20</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">_NPKData</span><span class="p">(</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">M</span><span class="p">)</span>
        <span class="n">d</span><span class="o">.</span><span class="n">pp</span><span class="p">(</span><span class="n">threshold</span> <span class="o">=</span> <span class="mi">10</span><span class="p">)</span> <span class="c1"># 3*d.std was just right - but does not work anymore with robust_stats() !</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">peaks</span><span class="o">.</span><span class="n">posF1</span><span class="p">)</span> <span class="p">,</span> <span class="p">[</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">peaks</span><span class="o">.</span><span class="n">posF2</span><span class="p">)</span> <span class="p">,</span> <span class="p">[</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">12</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">peaks</span><span class="o">.</span><span class="n">intens</span><span class="p">)</span> <span class="p">,</span> <span class="p">[</span> <span class="mf">20.0</span><span class="p">,</span> <span class="mf">20.0</span><span class="p">])</span></div>
<div class="viewcode-block" id="PeakTests.test_peaks1d"><a class="viewcode-back" href="../../../spike.plugins.html#spike.plugins.Peaks.PeakTests.test_peaks1d">[docs]</a>    <span class="k">def</span> <span class="nf">test_peaks1d</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;test 1D peak picker&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_peaks1d</span><span class="o">.</span><span class="vm">__doc__</span><span class="p">)</span>
        <span class="n">M</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">30</span><span class="p">))</span>
        <span class="n">M</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">20</span>
        <span class="n">M</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mi">8</span>
        <span class="n">M</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="mi">11</span>
        <span class="n">M</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="mi">20</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">_NPKData</span><span class="p">(</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">M</span><span class="p">)</span>
        <span class="n">d</span><span class="o">.</span><span class="n">pp</span><span class="p">(</span><span class="n">threshold</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">peaks</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span> <span class="p">,</span> <span class="p">[</span> <span class="mf">5.0</span><span class="p">,</span> <span class="mf">7.0</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">,</span> <span class="mf">15.0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">peaks</span><span class="o">.</span><span class="n">intens</span><span class="p">)</span> <span class="p">,</span> <span class="p">[</span> <span class="mf">20.0</span><span class="p">,</span> <span class="mf">8.0</span><span class="p">,</span> <span class="mf">20.0</span><span class="p">,</span> <span class="mf">11.0</span><span class="p">])</span>
        <span class="n">d</span><span class="o">.</span><span class="n">peaks</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="n">NbMaxPeaks</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span></div>
<div class="viewcode-block" id="PeakTests.test_center1d"><a class="viewcode-back" href="../../../spike.plugins.html#spike.plugins.Peaks.PeakTests.test_center1d">[docs]</a>    <span class="k">def</span> <span class="nf">test_center1d</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">center</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mf">2.2</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">)</span>
        <span class="c1"># y == [ -2.36111111e+01  -4.44089210e-15   9.72222222e+00   5.55555556e+00 -1.25000000e+01]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mf">9.72222222</span><span class="p">)</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">_NPKData</span><span class="p">(</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="mf">0.0</span><span class="p">))</span>
        <span class="n">d</span><span class="o">.</span><span class="n">peaks</span> <span class="o">=</span> <span class="n">Peak1DList</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="n">d</span><span class="p">)</span>
        <span class="n">d</span><span class="o">.</span><span class="n">peaks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Peak1D</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="mf">9.7</span><span class="p">,</span> <span class="mi">2</span> <span class="p">))</span>
        <span class="n">d</span><span class="o">.</span><span class="n">peaks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">width</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">d</span><span class="o">.</span><span class="n">centroid</span><span class="p">(</span><span class="n">npoints</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">peaks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span><span class="mf">2.2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">peaks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">intens</span><span class="p">,</span><span class="mf">10.0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">peaks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">width</span><span class="p">,</span><span class="mf">1.2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">d</span><span class="o">.</span><span class="n">peaks</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="n">NbMaxPeaks</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span></div>
<div class="viewcode-block" id="PeakTests.test_center2d"><a class="viewcode-back" href="../../../spike.plugins.html#spike.plugins.Peaks.PeakTests.test_center2d">[docs]</a>    <span class="k">def</span> <span class="nf">test_center2d</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">M</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">))</span>
        <span class="c1"># add one peak at (F1,F2) 5.3, 7.9 with widthes (5.0,1.3) </span>
        <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">10</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">11</span><span class="p">):</span>
                <span class="c1">#                 yo, x0 intens, widthy, widthx</span>
                <span class="n">M</span><span class="p">[</span><span class="n">y</span><span class="p">,</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">center2d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">y</span><span class="p">,</span><span class="n">x</span><span class="p">]),</span> <span class="mf">5.3</span><span class="p">,</span> <span class="mf">7.9</span><span class="p">,</span> <span class="mf">20.0</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">,</span> <span class="mf">1.3</span><span class="p">)</span>
        <span class="c1">#print (M[1:10,6:11])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">M</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">7</span><span class="p">],</span><span class="mf">5.87777515</span><span class="p">)</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">_NPKData</span><span class="p">(</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">M</span><span class="p">,</span><span class="mf">0.0</span><span class="p">))</span>
        <span class="n">d</span><span class="o">.</span><span class="n">peaks</span> <span class="o">=</span> <span class="n">Peak2DList</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="n">d</span><span class="p">)</span>
        <span class="c1"># self, Id, label, intens, posF1, posF2 </span>
        <span class="n">d</span><span class="o">.</span><span class="n">peaks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Peak2D</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="mf">18.0</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">8</span> <span class="p">))</span>
        <span class="n">d</span><span class="o">.</span><span class="n">centroid</span><span class="p">(</span><span class="n">npoints_F1</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">peaks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">posF1</span><span class="p">,</span><span class="mf">5.3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">peaks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">posF2</span><span class="p">,</span><span class="mf">7.9</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">peaks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">intens</span><span class="p">,</span><span class="mf">20.0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">peaks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">widthF1</span><span class="p">,</span><span class="mf">5.0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">peaks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">widthF2</span><span class="p">,</span><span class="mf">1.3</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span></div></div>

<span class="n">NPKData_plugin</span><span class="p">(</span><span class="s2">&quot;pp&quot;</span><span class="p">,</span> <span class="n">peakpick</span><span class="p">)</span>
<span class="n">NPKData_plugin</span><span class="p">(</span><span class="s2">&quot;peakpick&quot;</span><span class="p">,</span> <span class="n">peakpick</span><span class="p">)</span>
<span class="n">NPKData_plugin</span><span class="p">(</span><span class="s2">&quot;centroid&quot;</span><span class="p">,</span> <span class="n">centroid</span><span class="p">)</span>
<span class="n">NPKData_plugin</span><span class="p">(</span><span class="s2">&quot;report_peaks&quot;</span><span class="p">,</span> <span class="n">report_peaks</span><span class="p">)</span>
<span class="n">NPKData_plugin</span><span class="p">(</span><span class="s2">&quot;display_peaks&quot;</span><span class="p">,</span> <span class="n">display_peaks</span><span class="p">)</span>
<span class="n">NPKData_plugin</span><span class="p">(</span><span class="s2">&quot;peaks2d&quot;</span><span class="p">,</span> <span class="n">peaks2d</span><span class="p">)</span>
<span class="n">NPKData_plugin</span><span class="p">(</span><span class="s2">&quot;pk2pandas&quot;</span><span class="p">,</span> <span class="n">pk2pandas</span><span class="p">)</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">spike</a></h1>








<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../Readme.html">What is SPIKE ?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Readme.html#usage">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Readme.html#how-do-i-get-spike">How do I get SPIKE ?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Readme.html#developing-for-spike">Developing for SPIKE</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Doc.html">First contact SPIKE</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../spike.html">spike package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../release_notes.html">SPIKE Relase Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../licenses.html">SPIKE License</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../licenses.html#secondary-licenses">Secondary Licenses</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  <li><a href="../plugins.html">spike.plugins</a><ul>
  </ul></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2010-2019, IGBMC and others.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 2.1.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>