var teramap=function(e){var t={};function i(a){if(t[a])return t[a].exports;var s=t[a]={i:a,l:!1,exports:{}};return e[a].call(s.exports,s,s.exports,i),s.l=!0,s.exports}return i.m=e,i.c=t,i.d=function(e,t,a){i.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:a})},i.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.t=function(e,t){if(1&t&&(e=i(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var a=Object.create(null);if(i.r(a),Object.defineProperty(a,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var s in e)i.d(a,s,function(t){return e[t]}.bind(null,s));return a},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="",i(i.s=6)}([function(e,t){e.exports=L},function(e,t,i){"use strict";i.d(t,"a",(function(){return n})),i.d(t,"b",(function(){return r}));var a=i(0),s=i.n(a),n=(i(3),s.a.NumberIcon=s.a.DivIcon.extend({options:{html:"",shadowUrl:null,iconSize:new s.a.Point(20,20),className:"leaflet-number-marker"}}),s.a.numberIcon=function(e){var t="object"==typeof e?e:{html:e};return new s.a.NumberIcon(t)}),r=s.a.numberMarker=function(e,t){return s.a.marker(e,{icon:s.a.numberIcon(t)})}},,function(e,t,i){},,,function(e,t,i){"use strict";i.r(t),i.d(t,"fieldwork",(function(){return g}));var a=i(1);function s(e){return"is_primary"in e&&e.is_primary}function n(e){var t=[],i=e.species;for(var a in i)(s(i[a])||i[a].is_active)&&t.push(i[a]);return function(e){e.sort((function(e,t){return s(e)&&!s(t)?-1:s(t)&&!s(e)?1:e.name<t.name?-1:1}))}(t),t.map((function(e){return e.pk}))}class r{constructor(e){var t=["subjects","groups"];if(t.forEach((function(t){if(0===Object.keys(e[t]).length)throw new Error("No "+t+" provided")})),0===Object.keys(e.species).length&&!e.species_url)throw new Error("Either species or species_url (or both) should be defined");var i=t.concat(["species","pinpoint_target","species_url"]),a=this;if(i.forEach((function(t){e[t]&&(a[t]=e[t])})),this.pinpoint_observation="observation"==e.pinpoint_target,this.sample_attrs=e.sample_attrs||{},this.active_species=n(e),this.eachGroup((function(e){e.species=[]})),this.species)for(var s in this.species){var r=this.species[s];this.groups[r.group].species.push(+s)}}activateSpecies(e,t){this.species[e]||(this.species[e]=t,this.groups[t.group].species.push(e)),this.species[e].is_active=!0,-1===this.active_species.indexOf(e)&&this.active_species.push(e)}eachSubject(e,t){(void 0!==t?this.groups[t].subjects:Object.keys(this.subjects)).forEach((function(t){e(this.subjects[t],t)}),this)}eachSubjectName(e){var t={};for(var i in this.eachSubject((function(e,i){e in t||(t[e]=[]),t[e].push(+i)})),t)e(i,t[i])}_eachSpecies(e,t,i){for(var a in this.species)t&&!t(this.species[a])||e.call(i,this.species[a],this.species[a].pk)}sortActiveSpecies(){this.active_species=n(this)}eachActiveSpecies(e,t){var i=this.active_species;if(void 0!==t){var a=this.groups[t].species;i=i.filter((function(e){return-1!==a.indexOf(e)}))}(i=i.map((function(e){return this.species[e]}),this)).forEach((function(t){e(t,t.pk)}),this)}eachSelectableSpecies(e,t){var i=!1;void 0!==t&&(i=this.groups[t].species),this._eachSpecies(e,(function(e){return(!i||-1!==i.indexOf(e.pk))&&!(s(e)||e.is_active)}))}eachGroup(e){for(var t in this.groups)e(this.groups[t],t)}getGroupForSpecies(e){for(var t in this.groups){var i=this.groups[t];if(-1!==i.species.indexOf(e.pk))return i}}selectSubjectForSpecies(e,t){var i;return this.getGroupForSpecies(t).subjects.forEach((function(t){-1!==e.indexOf(t)&&(i=t)})),i}hasSampleAttrs(){return!this.pinpoint_observation&&Object.keys(this.sample_attrs).length>0}eachSampleAttr(e){for(var t in this.sample_attrs)e(this.sample_attrs[t],t)}}var o=function(e){var t=this.protocol=new r(e.protocol),i=t.pinpoint_observation;this.samples=e.initial_data||[],i&&0===this.samples.length&&this.samples.push({observations:[]});try{this.samples.forEach((function(e){e.observations.forEach((function(e){e.species&&t.activateSpecies(e.species)}))}))}catch(e){throw new Error("Could not activate species for initial data. Make sure all species refered to in initial_data are present in protocol.species.")}function n(e){return[(e=L.latLng(e)).lat,e.lng]}this.updateAttribute=function(e,t,i){this.getSample(e).attributes[t]=i},this.getSample=function(e){return i?this.samples[0]:(this.samples.forEach((function(i){i.name==e&&(t=i)})),t);var t},this.getObservation=function(e,t,a){var s,n=this.getSample(e);return n.observations.forEach((function(r){if(i)r.name===e&&(s=r);else{var o=r.species==t&&r.subject==a;n.name==e&&o&&(s=r)}})),s},this.removeObservation=function(e,t,a){var s=this.getSample(e),n=this.getObservation(e,t,a),r=s.observations.indexOf(n);i?n.count=void 0:s.observations.splice(r,1)},this.updateCount=function(e,a,n,r){void 0!==r&&""!==r&&(r=Math.abs(+r));var o=t.species[a],c=this.getSample(e),l=this.getObservation(e,a,n);l&&L.extend(l,{species:a,subject:n,count:r}),!s(o)&&void 0===r||""===r?l&&this.removeObservation(e,a,n):l||i||c.observations.push({species:a,subject:n,count:r})},this.observedCount=function(e,t,i){var a=this.getObservation(e,t,i);return a?a.count:void 0},this.next_pin_name=function(){var e=0;return this.samples.forEach((function(t){i?t.observations.forEach((function(t){e=Math.max(e,+t.name)})):e=Math.max(e,+t.name)})),""+(e+1)},this.createPin=function(e){var t={name:this.next_pin_name(),delete_on_cancel:!0};i?this.getSample().observations.push(t):(L.extend(t,{observations:[],attributes:{}}),this.samples.push(t));return e&&(t.latlng=n(e)),t},this.createMarker=function(e){var t=Object(a.b)(e.latlng,e.name);return t.feature={properties:e},t},this.setLatLng=function(e,t){this.getPin(e).latlng=n(t)},this.getPin=function(e){return i?this.getObservation(e):this.getSample(e)},this.eachPin=function(e){var t=i?this.samples[0].observations:this.samples;for(var a in t)e(t[a],a)},this.hasObservations=function(e){var t=this.getPin(e);return void 0!==t&&(i?"species"in t:t.observations.length>0)},this.removePin=function(e){var t;i?t=this.getSample().observations:t=this.samples;for(var a in t)t[a].name==e&&t.splice(a,1)},this.tableData=function(){var e=[],a=[o("location"),o("species")];i?a.push(o("subject"),o("count")):t.eachSubjectName((function(e){a.push(e)})),e.push(a);var s=this;return this.samples.forEach((function(a){if(i)a.observations.forEach((function(i){var a=t.species[i.species],s=t.subjects[i.subject];e.push([i.name,a,s,i.count])}));else{if(a.observations.length<1){var n=[a.name,{name:o("no observations")}];return t.eachSubjectName((function(){n.push("")})),void e.push(n)}t.eachActiveSpecies((function(i){var n=[];t.eachSubjectName((function(e,r){var o=t.selectSubjectForSpecies(r,i);n.push(s.observedCount(a.name,i.pk,o))})),n.some((function(e){return void 0!==e}))&&e.push([a.name,i].concat(n))}))}})),e},this.serialize=function(){return JSON.stringify(this.samples,null,2)},this._=function(t,i){var a=t;return"messages"in e&&(a=e.messages[t]||t),i?a.charAt(0).toUpperCase()+a.substring(1):a};var o=this._};function c(e){var t,i,a,s;for(i=1,a=arguments.length;i<a;i++)for(t in s=arguments[i])e[t]=s[t];return e}var l=/\{ *([\w_-]+) *\}/g;function p(e,t){return e.replace(l,(function(e,i){var a=t[i];if(void 0===a)throw new Error("No value provided for variable "+e);return"function"==typeof a&&(a=a(t)),a}))}function u(e,t){var i=t||"";return s(e)&&(i+=" app-transect-species-primary"),p('<span class="{class}" title="{scientific_name}">{name}</span>',{class:i,scientific_name:e.scientific_name||"",name:e.name||"<em>"+e.scientific_name+"</em>"})}var h=class{constructor(e,t,i){this.form_data=e,this.options=t,this.selector=i}render(e){var t,i='<div class="leaflet-number-marker">{name}</div>&nbsp;&nbsp;<span data-pin-name="{name}" class="btn-group btn-group-xs"><span data-target="edit" class="btn btn-default"><i class="fa fa-edit"></i></span>'+(this.options.mapclick_create?'<span data-target="move-marker" class="btn btn-default"><i class="fa fa-map-marker"></i></span>':"")+'<span data-target="delete" class="btn btn-danger"><i class="fa fa-trash"></i></span></span>',a="<thead><tr>";e[0].forEach((function(e){a+="<th>"+e+"</th>"})),a+="</tr>",e.slice(1).forEach((function(e){var s=e[0];a+=void 0===t||t!=s?'<tr class="first"><td>'+p(i,{name:s}):"<tr><td>",a+="</td>",a+="<td>"+u(e[1])+"</td>",e.slice(2).forEach((function(e){a+="<td>"+(e=void 0===e?"":e)+"</td>"})),t=s})),a+="</tbody>",this.selector.html(a)}};function d(e){return function(t){return{original:t,id:void 0===t.id?t.pk:t.id,text:t.name||"<em>"+t.scientific_name+"</em>",is_primary:s(t),group:t.group||e.getGroupForSpecies(t)}}}var f=class{constructor(e,t,i){this.protocol=e,this.group=void 0,this.dropdownParent=t,this.placeholder=i}data(){var e=this.protocol,t=[];function i(e){t.push(e)}return e.pinpoint_observation&&e.eachActiveSpecies(i,this.group),e.eachSelectableSpecies(i,this.group),(t=t.map(d(e))).unshift({id:"",text:this.placeholder}),t}set_group(e){return this.group=e.pk,this}render(e,t){var i={dropdownParent:this.dropdownParent,escapeMarkup:function(e){return e},templateResult:function(e){return"is_primary"in e&&s(e)?'<span class="app-transect-species-primary">'+e.text+"</span>":e.text}};if(this.protocol.species_url){var a=d(this.protocol),n=this.group;if(i.placeholder=this.placeholder,i.ajax={url:this.protocol.species_url,dataType:"json",data:function(e){return{json:!0,group:n,search:e.term,page:e.page||1}},processResults:function(e){return e.results=e.results.map(a),e}},e.select2(i),t){var r=a(t),o=new Option(r.text,r.id,!0,!0);e.append(o),e.trigger({type:"select2:change",params:{data:r}})}}else{if(i.data=this.data(),1==i.data.length)return e.hide(),!1;e.select2(i),t&&e.val(t.pk).trigger("change")}return e}};function v(e){return e.charAt(0).toUpperCase()+e.slice(1)}function m(e){e=c({type:"text"},e);var t=[];for(var i in e)t.push(i+'="'+e[i]+'"');return"<input "+t.join(" ")+"/>"}var b=function(e,t){var i=e._,a=e.protocol;this.modal=function(s,n){var r=e.getPin(n);s.data("name",n),s.find(".pinpoint-name").html('<div class="leaflet-number-marker">'+n+"</div>"),s.find("form").html('<div class="modal-body"></div>');var o=s.find(".modal-header");if(o.find("label").remove(),t.enable_fix_location_checkbox){o.prepend('<label class="pull-right"><input type="checkbox" /> '+v(i("fix location",!0))+"</label>");var c="fix_location"in r&&!0===r.fix_location;o.find("input[type=checkbox]").prop("checked",c)}var l=s.find(".modal-body").html(""),p="";a.hasSampleAttrs()&&(p+="<h4>"+v(i("attributes",!0))+"</h4>",a.eachSampleAttr((function(e,t){var i='<label class="control-label col-sm-4">'+e.name+"</label>";i+='<div class="col-sm-6">';var a=r.attributes[t]||"";e.choices&&e.choices.length>0?(i+='<select data-sample-attr="'+t+'" class="form-control">',e.choices.forEach((function(e){var t=e[0]==a?'selected="selected"':"";i+='<option value="'+e[0]+'" '+t+">"+e[1]+"</option>"})),i+="</select>"):i+=m({type:-1!==["number","color","date","month","password","range","time","text"].indexOf(e.type)?e.type:"text",class:"form-control","data-sample-attr":t,value:a}),p+='<div class="form-group">'+(i+="</div>")+"</div>"})),l.append(p));var h=$(t.modal_selector).find(".modal-content"),d=new f(a,h,v(i("type the first 4 letters of the species name and select a species",!0)));if(a.pinpoint_observation){l.append('<div class="row"><div class="col-md-4"><select class="form-control species-selector"></select></div><div class="col-md-4"><select class="form-control subject-selector"><option disabled="disabled">'+v(i("select species first",!0))+'</option></select></div> <div class="col-md-4">'+m({class:"form-control number-input",min:0,name:"count",placeholder:v(i("count"))})+"</div></div>");var b=e.getObservation(n),_=void 0;if(b&&b.species||!a.species_url&&1==Object.keys(a.species).length){var g=b&&b.species?b.species:Object.keys(a.species)[0];_=a.species[g]}d.render(l.find(".species-selector"),_).on("change",(function(){var e=$(this).select2("data")[0];e&&e.original&&y(e.original)}));var k=l.find(".subject-selector"),y=function(e){a.activateSpecies(e.pk,e);var i=+k.val(),s=!1,n=[];a.eachSubject((function(e,t){n.push({id:t,text:e}),t==i&&(s=!0)}),e.group),k.empty().select2({dropdownParent:$(t.modal_selector).find(".modal-content"),data:n}),i&&s&&k.val(i).trigger("change")};_&&y(_),b&&b.subject&&b.count&&b.subject&&(k.val(b.subject).trigger("change"),l.find('[name="count"]').val(b.count))}else p='<br><table class="table app-transect-table">',a.eachGroup((function(t){p+="<tr><th>"+t.name+"</th>",a.eachSubject((function(e){p+="<td>"+e+"</td>"}),t.pk),p+="</tr>",a.eachActiveSpecies((function(i){p+=function(t,i,s){var n="<tr><td>"+u(i,"form-control-static text-right")+"</td>";return a.eachSubject((function(a,s){var r=e.observedCount(t,i.pk,s);void 0===r&&(r="");var o=m({class:"form-control app-transect-subject-input number-input center-block","data-species":i.pk,"data-subject":s,value:r});n+="<td>"+o+"</td>"}),s.pk),n+="</tr>"}(n,i,t)}),t.pk),p+=function(e){var t=0;return a.eachSubject((function(){t++}),e.pk),'<tr><td><select class="form-control species-selector" data-group="'+e.pk+'"></select></td><td colspan="'+t+'"></td></tr>'}(t)})),p+="</table>",l.append(p),a.eachGroup((function(e){d.set_group(e).render($('.species-selector[data-group="'+e.pk+'"]'))}));s.find("form").toggleClass("form-inline",a.pinpoint_observation).toggleClass("form-horizontal",!a.pinpoint_observation)}};var _=class{constructor(e,t,i){this.map=e,this.options=i=c({output_selector:"[name=samples]",modal_selector:"#pinpoint_form",table_selector:"#observations",mapclick_create:!0,create_button_selector:"",enable_fix_location_checkbox:!1,default_fix_location_state:!0,warn_for_unsaved_changes:!0},i),this.modal=$(i.modal_selector),this.table=$(i.table_selector);try{var a=this.form_data=new o(t)}catch(e){return void this.table.html("<h1>Error in protocol: <em>"+e+"</em></h1>")}this.renderer=new b(this.form_data,i),this._=this.form_data._,this.markers={},this.editing_state=!1,this.tableRenderer=new h(a,i,this.table);var s=this;i.mapclick_create&&e.on("click",(function(e){if(!s.editing_state){var t=a.createPin(e.latlng);i.enable_fix_location_checkbox&&(t.fix_location=i.default_fix_location_state),s.addMapMarker(a.createMarker(t)),s.showEditor(t.name)}})),i.create_button_selector&&$(i.create_button_selector).on("click",(function(){var e=a.createPin();s.showEditor(e.name)}));var n=L.latLngBounds();e.geojson_layer&&n.extend(e.geojson_layer.getBounds()),a.eachPin((function(e){if(e.latlng){var t=s.addMapMarker(a.createMarker(e));n.extend(t.getLatLng())}}),this),n.isValid()&&e.fitBounds(n.pad(.2)),this.update(),this.initModal(),this.table.on("click","[data-target]",(function(){var t=""+$(this).parent().data("pin-name");switch($(this).data("target")){case"move-marker":var i=s.markers[t];alert(a._("click on map to choose new location")),s.editing_state=!0,e.once("click",(function(e){L.DomEvent.preventDefault(e),a.setLatLng(t,e.latlng),i.setLatLng(e.latlng),s.update(),s.editing_state=!1,s.dirty=!0}));break;case"delete":s.dirty=!0,s.removePin(t);break;default:s.showEditor(t)}})),s.dirty=!1,i.warn_for_unsaved_changes&&(window.onbeforeunload=function(){if(s.dirty)return!0},$(i.output_selector).parents("form").find('input[type="submit"]').on("click",(function(){window.onbeforeunload=null})))}initModal(){var e=this.modal,t=this.form_data,i=t._,a=this.renderer,s=this,n=t.protocol.pinpoint_observation;e.on("shown.bs.modal",(function(){$(this).find("input").first().focus()})),e.on("hidden.bs.modal",(function(){s.update()})),n||e.on("select2:close",".species-selector",(function(){var i=e.data("name"),n=+$(this).val();if(""!=n){var r=$(this).select2("data")[0];e.find(".select2-hidden-accessible").select2("destroy"),s.saveEditorData(!0),t.protocol.activateSpecies(n,r.original),a.modal(e,i),e.find('input[data-species="'+n+'"]').first().focus()}}));var r=function(){if(n){var t=function(t){var i=$(e).find(t).val();return""!=i&&null!=i&&null!=i};if(!t(".species-selector"))return void alert(i("you must select a species",!0));if(!t(".subject-selector"))return void alert(i("you must select a subject",!0))}s.saveEditorData(),e.modal("hide")};e.on("click","[data-save]",r),e.on("keypress",(function(e){13==e.which&&(r(),e.preventDefault())})),e.on("click","[data-dismiss]",(function(){var i=t.getPin($(e).data("name"));"delete_on_cancel"in i&&s.removePin(i.name,!0),s.update(),e.modal("hide")}))}showEditor(e){this.form_data.protocol.sortActiveSpecies(),this.renderer.modal(this.modal,e),this.modal.modal({backdrop:"static",keyboard:!1})}addMapMarker(e){var t=this;return e.addTo(this.map),e.on("click",(function(e){t.showEditor(e.target.feature.properties.name),L.DomEvent.stopPropagation(e)})),this.markers[e.feature.properties.name]=e,e}removePin(e,t){var i=this.form_data._;return!(!t&&!confirm(i("are you sure you want to delete this observation?",!0)))&&(this.markers[e]&&this.markers[e].removeFrom(this.map),this.form_data.removePin(e),this.update(),!0)}saveEditorData(e){e=!0===e;var t=this.modal.data("name"),i=this.form_data,a=i.getPin(t),s=this.modal;i.protocol.pinpoint_observation?i.updateCount(t,+$(".species-selector").val(),+$(".subject-selector").val(),s.find("input.number-input").val()):(a.not_counted&&(a.not_counted=!1),s.find("[data-sample-attr]").each((function(){var e=$(this);i.updateAttribute(t,+e.data("sample-attr"),e.val())})),s.find("input.number-input").each((function(){var e=$(this);i.updateCount(t,+e.data("species"),+e.data("subject"),e.val())}))),this.options.enable_fix_location_checkbox&&(a.fix_location=s.find("input[type=checkbox]").prop("checked")),e||(delete a.delete_on_cancel,this.dirty=!0)}update(){$(this.options.output_selector).val(this.form_data.serialize()),this.form_data.protocol.sortActiveSpecies(),this.tableRenderer.render(this.form_data.tableData())}},g=(i(13),{Protocol:r,PinpointController:_,Pinpoint:o,PinpointModal:b,PinpointTable:h,is_primary:s})},,,,,,,function(e,t,i){}]);
//# sourceMappingURL=fieldwork.js.map