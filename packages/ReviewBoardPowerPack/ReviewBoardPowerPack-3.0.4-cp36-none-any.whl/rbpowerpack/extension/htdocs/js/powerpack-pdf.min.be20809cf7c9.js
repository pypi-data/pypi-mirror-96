(function(){window.PowerPack=window.PowerPack||{};PowerPack.Utils={spaceless:function(strings){var i;for(i=0;i<strings.length;i++){strings[i]=strings[i].trim()}return strings.join("")}};"use strict";PowerPack.PDF={};PowerPack.PDF.PDF=Backbone.Model.extend({defaults:{currentPage:null,numPages:null,outlineMap:null,pdfURL:"",pdfDocument:null},initialize:function initialize(){var _this=this;pdfjsLib.getDocument(this.get("pdfURL")).promise.then(function(pdfDocument){_this.set({currentPage:1,numPages:pdfDocument.numPages,pdfDocument:pdfDocument});_this._initializeNavigationMap(pdfDocument)})},getDocument:function getDocument(){var _this2=this;return new Promise(function(resolve,reject){var pdfDocument=_this2.get("pdfDocument");if(pdfDocument!==null){resolve(pdfDocument)}else{_this2.once("change:pdfDocument",function(model,pdfDocument){return resolve(pdfDocument)})}})},getPage:function getPage(pageNum){return this.getDocument().then(function(doc){return doc.getPage(pageNum)})},_initializeNavigationMap:function _initializeNavigationMap(pdf){var _this3=this;var numPages=pdf.numPages;var pagePromises=[];for(var i=1;i<=numPages;i++){pagePromises.push(pdf.getPage(i))}var allPagesPromise=Promise.all(pagePromises);allPagesPromise.then(function(pages){console.assert(pages.length===numPages);var pageMap={};for(var _i=0;_i<numPages;_i++){var ref=pages[_i].ref;pageMap[ref.gen+"@"+ref.num]=_i+1}_this3._pageMap=pageMap});var outlinePromise=pdf.getOutline();var destinationsPromise=pdf.getDestinations();Promise.all([allPagesPromise,destinationsPromise,outlinePromise]).then(function(p){var destinations=p[1];var outline=p[2];var buildOL=function buildOL(items){var values=[];for(var _i2=0;_i2<items.length;_i2++){var destID=items[_i2].dest;var destination=void 0;if(destID===undefined){console.warn("Could not find destination for outline item "+items[_i2].title);continue}else if(destinations[destID]!==undefined){destination=destinations[destID]}else if(destID instanceof Object){destination=destID}if(destination===undefined){console.warn("Could not find destination for outline item "+items[_i2].title);continue}var dest=destination[0];var ref=dest.gen+"@"+dest.num;values.push({title:items[_i2].title,page:_this3._pageMap[ref],children:buildOL(items[_i2].items)})}return values};_this3.set("outlineMap",outline&&buildOL(outline)||[])})}});"use strict";PowerPack.PDF.RegionCommentBlock=RB.RegionCommentBlock.extend({defaults:_.defaults({onDiffOrigFile:false,page:null,scale:null,thumbnailData:null},RB.RegionCommentBlock.prototype.defaults),serializedFields:RB.RegionCommentBlock.prototype.serializedFields.concat(["onDiffOrigFile","page","thumbnailData"]),parse:function parse(fields){fields=RB.RegionCommentBlock.prototype.parse.call(this,fields);fields.page=parseInt(fields.page,10)||undefined;return fields}});"use strict";PowerPack.PDF.Reviewable=RB.FileAttachmentReviewable.extend({defaults:_.defaults({commentBlockViews:[],diffAgainstPDF:null,diffAgainstPDFURL:"",diffData:[],diffURL:"",pdf:null,pdfURL:null,scale:1,scrollLock:false,workerURL:null},RB.FileAttachmentReviewable.prototype.defaults),commentBlockModel:PowerPack.PDF.RegionCommentBlock,initialize:function initialize(attributes,options){RB.FileAttachmentReviewable.prototype.initialize.call(this,attributes,options);pdfjsLib.workerSrc=attributes.workerURL;this.set("pdf",new PowerPack.PDF.PDF({pdfURL:attributes.pdfURL}));if(attributes.diffAgainstPDFURL){this.set("diffAgainstPDF",new PowerPack.PDF.PDF({pdfURL:attributes.diffAgainstPDFURL}))}}});"use strict";PowerPack.PDF.Sidebar=Backbone.Model.extend({defaults:function defaults(){return{availableModes:[PowerPack.PDF.Sidebar.MODE_THUMBNAILS],mode:PowerPack.PDF.Sidebar.MODE_THUMBNAILS,reviewable:null,visible:false}},initialize:function initialize(){var pdf=this.get("reviewable").get("pdf");this._modeIsDefault=true;this.on("change:mode",function(model,mode){this._modeIsDefault=false},this);this.listenTo(pdf,"change:outlineMap",this._onOutlineChanged);this._onOutlineChanged()},_onOutlineChanged:function _onOutlineChanged(){var modes=[PowerPack.PDF.Sidebar.MODE_THUMBNAILS];var outline=this.get("reviewable").get("pdf").get("outlineMap");if(outline){modes.push(PowerPack.PDF.Sidebar.MODE_OUTLINE);if(this._modeIsDefault){this.set("mode",PowerPack.PDF.Sidebar.MODE_OUTLINE)}}if(this.get("reviewable").get("diffAgainstPDF")){modes.push(PowerPack.PDF.Sidebar.MODE_DIFFS)}this.set("availableModes",modes)}},{MODE_COMMENTS:"comments",MODE_DIFFS:"diffs",MODE_OUTLINE:"outline",MODE_THUMBNAILS:"thumbnails"});"use strict";PowerPack.PDF.PageControlsView=Backbone.View.extend({className:"page-controls",events:{"change .pdf-page-curr":"_onChangePage","click .page-prev":"_onPrevPageClicked","click .page-next":"_onNextPageClicked"},template:_.template('<div class="pdf-page-info">\n <%- pageText %>:\n <input type="number" class="pdf-page-curr" min="1" />\n <%- ofText %>\n <span class="pdf-page-total"></span>\n</div>\n<span class="fa fa-arrow-circle-o-up page-prev"\n      title="<%- prevPageText %>"></span>\n<span class="fa fa-arrow-circle-o-down page-next"\n      title="<%- nextPageText %>"></span>'),initialize:function initialize(){this._$currentPage=null;this._$totalPages=null},render:function render(){var _this=this;this.$el.html(this.template({pageText:gettext("Page"),ofText:gettext("of"),prevPageText:gettext("Previous page"),nextPageText:gettext("Next page")}));var pdf=this.model.get("pdf");var diffAgainstPDF=this.model.get("diffAgainstPDF");this._$currentPage=this.$(".pdf-page-curr").bindProperty("value",pdf,"currentPage").bindProperty("max",pdf,"numPages");this._$totalPages=this.$(".pdf-page-total").bindProperty("text",pdf,"numPages");if(diffAgainstPDF){var $scrollLock=$('<input type="checkbox" id="pdf-scroll-lock">').appendTo(this.$el);$('<label for="pdf-scroll-lock">').text(gettext("Lock scroll")).appendTo(this.$el);$scrollLock.on("change",function(ev){_this.model.set("scrollLock",$scrollLock.is(":checked"))})}return this},_onChangePage:function _onChangePage(){var pdf=this.model.get("pdf");var page=this._$currentPage.val();if(page>0&&page<=pdf.get("numPages")){pdf.set("currentPage",page)}else{this._$currentPage.val(this.model.get("currentPage"))}},_onPrevPageClicked:function _onPrevPageClicked(){var pdf=this.model.get("pdf");var currentPage=pdf.get("currentPage");if(currentPage>1){pdf.set("currentPage",currentPage-1)}},_onNextPageClicked:function _onNextPageClicked(){var pdf=this.model.get("pdf");var currentPage=pdf.get("currentPage");if(currentPage<pdf.get("numPages")){pdf.set("currentPage",currentPage+1)}}});"use strict";PowerPack.PDF.PageRendererView=Backbone.View.extend({initialize:function initialize(options){this._renderBusy=false;this._scheduledRenders=[];this.pdf=options.pdf},scheduleRender:function scheduleRender(page,options){var renderInfo=_.defaults({page:page},options);if(renderInfo.highestPriority){if(page.inRenderQueue){for(var i=0;i<this._scheduledRenders.length;i++){if(this._scheduledRenders[i].page===page){this._scheduledRenders.splice(i,1);break}}}this._scheduledRenders.unshift(renderInfo)}else{if(!page.inRenderQueue){this._scheduledRenders.push(renderInfo)}}page.inRenderQueue=true;this._processNextRender()},_processNextRender:_.throttle(function(){var _this=this;if(this._renderBusy){return}_.defer(function(){if(_this._scheduledRenders.length===0){_this.trigger("renderQueueEmpty")}else{var renderInfo=_this._scheduledRenders.shift();_this._renderPage(renderInfo,{success:function success(){renderInfo.page.inRenderQueue=false;_this._processNextRender()}})}})},10),_renderPage:function _renderPage(renderInfo){var _this2=this;var options=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};var page=renderInfo.page;if(page.rendered){if(_.isFunction(options.success)){options.success()}return}this._renderBusy=true;this.pdf.getPage(page.pageNum).then(function(pdfPage){var pixelRatio=window.devicePixelRatio;var pageWidth=pdfPage.getViewport({scale:1}).width;var scale=(renderInfo.fitToWidth?page.$el.width()/pageWidth:_this2.model.get("scale"))*pixelRatio;var viewport=pdfPage.getViewport({scale:scale});var viewportSize={width:viewport.width,height:viewport.height};var elementSize={width:Math.round(viewport.width/pixelRatio)+"px",height:Math.round(viewport.height/pixelRatio)+"px"};page.resize(elementSize,viewportSize);page.rendered=true;var ctx=page.$canvas[0].getContext("2d");pdfPage.render({canvasContext:ctx,viewport:viewport}).promise.then(function(){if(!page.diffRegions){return}page.diffRegions.forEach(function(region){var color=void 0;if(region.op==="insert"){color="#dfffd7"}else if(region.op==="delete"){color="#ffe0e5"}else{return}var left=region.bbox[0]*viewport.scale;var width=(region.bbox[2]-region.bbox[0])*viewport.scale;var height=(region.bbox[3]-region.bbox[1])*viewport.scale;var top=viewport.height-region.bbox[1]*viewport.scale-height;ctx.save();ctx.globalCompositeOperation="multiply";ctx.fillStyle=color;ctx.fillRect(left,top,width,height);ctx.restore()})}).then(function(){_this2._renderBusy=false;if(_.isFunction(options.success)){options.success()}}).catch(function(error){console.warning("Error while rendering pdf: "+error);_this2._renderBusy=false;page.rendered=false;if(_.isFunction(options.error)){options.error(error)}})})}});"use strict";PowerPack.PDF.PagesView=Backbone.View.extend({className:"pdf-offset",events:{"mousedown .selection-container":"_onMouseDown",mouseup:"_onMouseUp",mousemove:"_onMouseMove",scroll:"_onScroll"},initialize:function initialize(options){this.origFile=options.origFile;this._pageRenderer=options.pageRenderer;this._pdf=options.pdf;this._defaultPageNum=this._pdf.get("currentPage");this._docReady=false;this._rendered=false;this._scrolling=false;this._diffRegions=[];this.pages=[];_.bindAll(this,"_resizeAllPages","_resizePagesBatch")},render:function render(){this.$el.empty();this._$pages=$('<div class="pdf-pages"/>').appendTo(this.$el);this.listenTo(this._pdf,"change:pdfDocument",this._renderDocument);this._renderDocument(this._pdf,this._pdf.get("pdfDocument"));this.listenTo(this._pdf,"change:currentPage",this._onCurrentPageChanged);this._onCurrentPageChanged();this.listenTo(this.model,"change:scale",this._onZoomChanged);return this},addDiffRegions:function addDiffRegions(regions){this._diffRegions=regions;if(this._rendered){this.pages.forEach(function(page){page.setDiffRegions(regions.filter(function(region){return region.page===page.pageNum-1}))});this._renderHighestPriorityPage()}},isCommentDialogVisible:function isCommentDialogVisible(){return this.commentDlg&&!this.commentDlg.$el.is(":hidden")},_renderDocument:function _renderDocument(pdf,pdfDocument){var _this=this;if(pdfDocument===null){return}var numPages=pdfDocument.numPages;var pixelRatio=window.devicePixelRatio;var scale=this.model.get("scale");var _loop=function _loop(i){var pageView=new PowerPack.PDF.PageView({diffRegions:_this._diffRegions.filter(function(region){return region.page===i}),pageNum:i+1,pagesView:_this});pageView.render().$el.appendTo(_this._$pages);_this.pages.push(pageView)};for(var i=0;i<numPages;i++){_loop(i)}pdf.getPage(1).then(function(pdfPage){var viewport=pdfPage.getViewport({scale:scale*pixelRatio});var viewportSize={width:viewport.width,height:viewport.height};var elementSize={width:Math.round(viewport.width/pixelRatio)+"px",height:Math.round(viewport.height/pixelRatio)+"px"};_this.pages.forEach(function(page){return page.resize(elementSize,viewportSize)});if(_this._defaultPageNum){pdf.set("currentPage",_this._defaultPageNum)}});this.model.get("commentBlockViews").forEach(function(view){if(view.model.get("onDiffOrigFile")===_this.origFile){_this.placeCommentBlockView(view.model.get("page"),view)}});this._renderHighestPriorityPage();this._rendered=true;return this},placeCommentBlockView:function placeCommentBlockView(pageNum,commentBlockView){console.assert(pageNum<=this.pages.length);this.pages[pageNum-1].placeCommentBlockView(commentBlockView)},_renderHighestPriorityPage:function _renderHighestPriorityPage(){var visible=this._getVisiblePages();var i=_.find(visible,function(item){return!item.page.rendered});var highestPriorityPageIx=undefined;if(i!==undefined){highestPriorityPageIx=i.index}if(highestPriorityPageIx===undefined&&visible.length>0){i=visible[0].index-1;if(i>=0&&!this.pages[i].rendered){highestPriorityPageIx=i}i=visible[visible.length-1].index+1;if(highestPriorityPageIx===undefined&&i<this.pages.length&&!this.pages[i].rendered){highestPriorityPageIx=visible[visible.length-1].index+1}}if(highestPriorityPageIx!==undefined){this.listenToOnce(this._pageRenderer,"renderQueueEmpty",this._renderHighestPriorityPage);this._pageRenderer.scheduleRender(this.pages[highestPriorityPageIx],{highestPriority:true})}},_getVisiblePages:function _getVisiblePages(){var scrollTop=this.el.scrollTop;var scrollBottom=scrollTop+this.el.clientHeight;var visible=[];for(var i=0;i<this.pages.length;i++){var page=this.pages[i];var boundsVisibility=page.getBoundsVisibility(scrollTop,scrollBottom);if(boundsVisibility.aboveBounds){continue}if(boundsVisibility.belowBounds){break}visible.push({page:page,index:i})}return visible},_getFirstVisiblePage:function _getFirstVisiblePage(){var scrollTop=this.el.scrollTop;for(var i=0;i<this.pages.length;i++){var page=this.pages[i];var pageEl=page.el;if(pageEl.offsetTop+pageEl.offsetHeight>=scrollTop){return page}}return null},_onMouseDown:function _onMouseDown(ev){var $target=$(ev.target);var $page=$target.parents(".pdf-page");if(ev.which===1&&!this.isCommentDialogVisible()&&!$target.hasClass("selection-flag")){var pageView=this.pages[$page.data("pageIx")];this._activeSelection=pageView.beginSelection(ev);return false}},_onMouseUp:function _onMouseUp(ev){if(!this._activeSelection){return true}if(!this.isCommentDialogVisible()&&this._activeSelection.isValid()){ev.stopPropagation();var commentData=this._activeSelection.finish(ev);this._activeSelection=null;if(commentData!==null){this.trigger("commentRegionCreated",commentData)}}},_onMouseMove:function _onMouseMove(ev){if(!this._activeSelection){return true}if(!this.isCommentDialogVisible()&&this._activeSelection.isValid()){this._activeSelection.update(ev);return false}},_onScroll:function _onScroll(ev){var scrollTop=this.el.scrollTop;var scrollBottom=scrollTop+this.el.clientHeight;var biggestPageIx=-1;var biggestPageSize=0;for(var i=0;i<this.pages.length;i++){var boundsVisibility=this.pages[i].getBoundsVisibility(scrollTop,scrollBottom);if(!boundsVisibility.aboveBounds&&!boundsVisibility.belowBounds&&boundsVisibility.overlapSize>biggestPageSize){biggestPageSize=boundsVisibility.overlapSize;biggestPageIx=i}}console.assert(biggestPageIx>=0);this._scrolling=true;this._pdf.set("currentPage",biggestPageIx+1);this._scrolling=false;this._renderHighestPriorityPage()},_onCurrentPageChanged:function _onCurrentPageChanged(){var pageNum=this._pdf.get("currentPage");if(this.pages.length===0||this._scrolling){return}console.assert(pageNum>=1);console.assert(pageNum<=this.pages.length);this.$el.scrollTop(this.pages[pageNum-1].$el.position().top)},_onZoomChanged:function _onZoomChanged(){var _this2=this;var commentViews=this.model.get("commentBlockViews");var scale=this.model.get("scale");var firstVisiblePage=this._getFirstVisiblePage();for(var i=0;i<commentViews.length;i++){commentViews[i].model.set("scale",scale)}var firstVisiblePDFPage=void 0;var offsetTopFromCanvas=void 0;var topLeft=void 0;this._pdf.getPage(firstVisiblePage.pageNum).then(function(pdfPage){var previousScale=_this2.model.previous("scale");var viewport=pdfPage.getViewport({scale:previousScale});var firstVisiblePagePos=firstVisiblePage.$canvas.position();offsetTopFromCanvas=_this2.el.scrollTop-firstVisiblePagePos.top;topLeft=viewport.convertToPdfPoint(_this2.el.scrollLeft-firstVisiblePagePos.left,offsetTopFromCanvas);topLeft=[Math.round(topLeft[0]),Math.round(topLeft[1])];firstVisiblePDFPage=pdfPage}).then(this._resizeAllPages).then(function(){var firstVisiblePagePos=firstVisiblePage.$canvas.position();var viewport=firstVisiblePDFPage.getViewport({scale:scale});var newTopLeft=viewport.convertToViewportPoint(topLeft[0],topLeft[1]);_this2.el.scrollLeft=firstVisiblePagePos.left+newTopLeft[0];_this2.el.scrollTop=firstVisiblePagePos.top+(offsetTopFromCanvas<0?offsetTopFromCanvas:newTopLeft[1]);_this2._renderHighestPriorityPage()})},_resizeAllPages:function _resizeAllPages(){var pageSizes={};for(var i=0;i<this.pages.length;i++){var page=this.pages[i];var key=page.$el.width()+"x"+page.$el.height();page.rendered=false;if(pageSizes[key]){pageSizes[key].push(page)}else{pageSizes[key]=[page]}}return Promise.all(_.map(pageSizes,this._resizePagesBatch))},_resizePagesBatch:function _resizePagesBatch(pagesBatch){var scale=this.model.get("scale");var pixelRatio=window.devicePixelRatio;return this._pdf.getPage(pagesBatch[0].pageNum).then(function(pdfPage){var viewport=pdfPage.getViewport({scale:scale*pixelRatio});var elementSize={width:Math.round(viewport.width/pixelRatio)+"px",height:Math.round(viewport.height/pixelRatio)+"px"};for(var i=0;i<pagesBatch.length;i++){pagesBatch[i].resize(elementSize)}})}});"use strict";PowerPack.PDF.RenderablePageView=Backbone.View.extend({initialize:function initialize(options){this.pageNum=options.pageNum;this.$canvas=null;this.inRenderQueue=false;this.rendered=false},render:function render(){this.$canvas=$("<canvas/>");return this},resize:function resize(elementSize,viewportSize){if(viewportSize){this.$canvas.attr(viewportSize)}this.$canvas.css(elementSize);this.$el.css(elementSize)}});"use strict";PowerPack.PDF.PageView=PowerPack.PDF.RenderablePageView.extend({className:"pdf-page",events:{"mousedown .selection-container":"_onMouseDown",mouseenter:"_onMouseEnter",mouseleave:"_onMouseLeave"},SELECTION_CLICK_EPSILON:5,initialize:function initialize(options){PowerPack.PDF.RenderablePageView.prototype.initialize.call(this,options);this.diffRegions=options.diffRegions;this.pagesView=options.pagesView;this._$selectionContainer=null;this._$selectionRect=null},setDiffRegions:function setDiffRegions(diffRegions){this.diffRegions=diffRegions;this.rendered=false},render:function render(){PowerPack.PDF.RenderablePageView.prototype.render.call(this);this.$el.empty().data("pageIx",this.pageNum-1).attr("id","pdf-page-"+this.pageNum);this._$selectionRect=$("<div/>").addClass("selection-rect").proxyTouchEvents().hide();this._$selectionContainer=$("<div/>").addClass("selection-container").proxyTouchEvents().hide().append(this._$selectionRect).appendTo(this.$el);this.$canvas.addClass("pdf-canvas").appendTo(this.$el);return this},resize:function resize(elementSize,viewportSize){PowerPack.PDF.RenderablePageView.prototype.resize.call(this,elementSize,viewportSize);this._$selectionContainer.css(elementSize)},getBoundsVisibility:function getBoundsVisibility(boundsTop,boundsBottom){var pageTop=this.el.offsetTop;var pageHeight=this.el.offsetHeight;var pageBottom=pageTop+pageHeight;var overlapTop=Math.max(pageTop,boundsTop);var overlapBottom=Math.min(pageBottom,boundsBottom);return{aboveBounds:pageBottom<boundsTop,belowBounds:pageTop>boundsBottom,overlapSize:overlapBottom-overlapTop}},placeCommentBlockView:function placeCommentBlockView(commentBlockView){this._$selectionContainer.append(commentBlockView.$el);if(commentBlockView.setSelectionRegionSizeFunc){commentBlockView.setSelectionRegionSizeFunc(this._getSelectionRegionSize.bind(this))}},beginSelection:function beginSelection(ev){var _this=this;var offset=this.$el.offset();var x=ev.pageX-Math.floor(offset.left)-1;var y=ev.pageY-Math.floor(offset.top)-1;this._$selectionRect.move(x,y).width(1).height(1).show();return{isValid:function isValid(){return _this._$selectionRect.is(":visible")},update:function update(ev){return _this._updateSelection(ev,x,y)},finish:this._finishSelection.bind(this)}},_updateSelection:function _updateSelection(ev,beginX,beginY){var $el=this.$el;var offset=$el.offset();var pageX=Math.floor(offset.left)-1;var pageY=Math.floor(offset.top)-1;var pageWidth=Math.floor($el.innerWidth());var pageHeight=Math.floor($el.innerHeight());var x=Math.min(Math.max(ev.pageX-pageX,0),pageWidth-2);var y=Math.min(Math.max(ev.pageY-pageY,0),pageHeight-2);this._$selectionRect.css(beginX<=x?{left:beginX,width:x-beginX}:{left:x,width:beginX-x}).css(beginY<=y?{top:beginY,height:y-beginY}:{top:y,height:beginY-y})},_finishSelection:function _finishSelection(){var $selectionRect=this._$selectionRect;var width=$selectionRect.width();var height=$selectionRect.height();var offset=$selectionRect.position();var pixelRatio=window.devicePixelRatio;$selectionRect.hide();if(width<=this.SELECTION_CLICK_EPSILON||height<=this.SELECTION_CLICK_EPSILON){return null}var scale=this.pagesView.model.get("scale");var context=this.$canvas[0].getContext("2d");var x=Math.floor(offset.left*pixelRatio);var y=Math.floor(offset.top*pixelRatio);var sourceWidth=Math.floor(width*pixelRatio);var sourceHeight=Math.floor(height*pixelRatio);var imageData=context.getImageData(x,y,sourceWidth,sourceHeight);var tempCanvas=$("<canvas>").attr({width:sourceWidth,height:sourceHeight})[0];tempCanvas.getContext("2d").putImageData(imageData,0,0);return{x:Math.floor(offset.left/scale),y:Math.floor(offset.top/scale),width:Math.round(width/scale),height:Math.round(height/scale),onDiffOrigFile:this.pagesView.origFile,page:this.pageNum,thumbnailData:tempCanvas.toDataURL()}},_getSelectionRegionSize:function _getSelectionRegionSize(){var $selectionContainer=this._$selectionContainer;var offset=$selectionContainer.position();offset.left+=$selectionContainer.getExtents("m","l");return{left:offset.left,top:offset.top,width:$selectionContainer.width(),height:$selectionContainer.height()}},_onMouseEnter:function _onMouseEnter(){this._$selectionContainer.show()},_onMouseLeave:function _onMouseLeave(){if(this._$selectionRect.is(":hidden")&&!this.pagesView.isCommentDialogVisible()){this._$selectionContainer.hide()}}});"use strict";PowerPack.PDF.SidebarModeView=Backbone.View.extend({setVisible:function setVisible(visible){this.$el.setVisible(visible)}});"use strict";(function(){var OutlineEntryModel=Backbone.Model.extend({defaults:_.defaults({children:null,text:"",page:null}),parse:function parse(data){return{text:data.title,page:data.page,children:new OutlineEntryCollection(data.children,{parse:true})}}});var OutlineEntryCollection=Backbone.Collection.extend({model:OutlineEntryModel,initialize:function initialize(models){models=models.map(function(item){return new OutlineEntryModel(item,{parse:true})});Backbone.Collection.prototype.initialize.call(this,models)}});var OutlineEntryView=Backbone.View.extend({tagName:"li",initialize:function initialize(){this._childViews=this.model.get("children").map(function(model){return new OutlineEntryView({model:model})})},render:function render(){var _this=this;this._$disclosure=$("<div/>").addClass("disclosure").appendTo(this.el).click(this._toggleDisclosure.bind(this));this._disclosed=false;$("<div/>").addClass("page-link").text(this.model.get("text")).data("page",this.model.get("page")).appendTo(this.el);if(this._childViews.length){this._$ul=$("<ul/>").appendTo(this.el);this._childViews.forEach(function(view){return _this._$ul.append(view.render().el)});this._$disclosure.css("visibility","visible");this._toggleDisclosure()}return this},_toggleDisclosure:function _toggleDisclosure(){if(this._$disclosure!==undefined){if(this._disclosed){this._disclosed=false;this._$disclosure.text("▶");this._$ul.hide()}else{this._disclosed=true;this._$disclosure.text("▼");this._$ul.show()}}}});PowerPack.PDF.SidebarModeOutlineView=PowerPack.PDF.SidebarModeView.extend({tagName:"ul",events:{"click .page-link":"_onItemClicked"},initialize:function initialize(){this._collection=null;this._childViews=[]},render:function render(){var reviewable=this.model.get("reviewable");var pdf=reviewable.get("pdf");this.stopListening(pdf);this.listenTo(pdf,"change:outlineMap",this._buildOutlineViews);this._buildOutlineViews();return this},_buildOutlineViews:function _buildOutlineViews(){var _this2=this;var reviewable=this.model.get("reviewable");var pdf=reviewable.get("pdf");this._childViews.forEach(function(view){return view.remove()});this._collection=new OutlineEntryCollection(pdf.get("outlineMap")||[],{parse:true});this._childViews=[];this._collection.each(function(model){var childView=new OutlineEntryView({model:model});_this2.$el.append(childView.render().el);_this2._childViews.push(childView)})},_onItemClicked:function _onItemClicked(ev){var pageNum=$(ev.target).data("page");if(pageNum!==null){var reviewable=this.model.get("reviewable");var pdf=reviewable.get("pdf");pdf.set("currentPage",pageNum)}}})})();"use strict";PowerPack.PDF.SidebarControlsView=Backbone.View.extend({className:"pdf-controls-sidebar",events:{"click .toggle-sidebar":"_onToggleSidebarClicked"},initialize:function initialize(){this._$modes=null;this._$toggleSidebar=null},render:function render(){this.stopListening(this.model);this.$el.empty();this._$toggleSidebar=$('<span class="fa fa-bars toggle-sidebar">').attr("title",gettext("Toggle the page navigation sidebar")).appendTo(this.$el);this._$modes=$('<div class="pdf-controls-sidebar-modes">').appendTo(this.$el);this.listenTo(this.model,"change:availableModes",this._onAvailableModesChanged);this._onAvailableModesChanged();this.listenTo(this.model,"change:visible",this._onSidebarVisibleChanged);this.listenTo(this.model,"change:mode",this._onModeChanged);return this},_addSidebarMode:function _addSidebarMode(mode){var _this=this;var modeIcons={};modeIcons[PowerPack.PDF.Sidebar.MODE_DIFFS]="fa-columns";modeIcons[PowerPack.PDF.Sidebar.MODE_OUTLINE]="fa-list";modeIcons[PowerPack.PDF.Sidebar.MODE_THUMBNAILS]="fa-file-o";$('<span class="sidebar-mode-'+mode+" fa "+modeIcons[mode]+'">').on("click",function(){return _this.model.set("mode",mode)}).appendTo(this._$modes)},_onToggleSidebarClicked:function _onToggleSidebarClicked(){this.model.set("visible",!this.model.get("visible"))},_onAvailableModesChanged:function _onAvailableModesChanged(){this._$modes.empty();_.each(this.model.get("availableModes"),this._addSidebarMode,this)},_onSidebarVisibleChanged:function _onSidebarVisibleChanged(){var open=this.model.get("visible");this._$toggleSidebar.toggleClass("active",open);this._$modes.toggleClass("sidebar-open",open)},_onModeChanged:function _onModeChanged(){var oldMode=this.model.previous("mode");var newMode=this.model.get("mode");this.$(".sidebar-mode-"+oldMode).removeClass("active");this.$(".sidebar-mode-"+newMode).addClass("active")}});"use strict";PowerPack.PDF.SidebarDiffsView=PowerPack.PDF.SidebarModeView.extend({tagName:"ul",events:{"click .page-link":"_onItemClicked"},initialize:function initialize(){this._rendered=false},render:function render(){var _this=this;var reviewable=this.model.get("reviewable");var diffData=reviewable.get("diffData")||[];this.$el.empty();diffData.forEach(function(data){if(data.content){var isInsert=data.op==="insert";var page=data.page+1;var syncPage=data.syncPage+1;var $li=$('<li class="page-link">').addClass("pdf-nav-diffs-"+data.op).data({leftPage:isInsert?syncPage:page,rightPage:isInsert?page:syncPage}).appendTo(_this.$el);var $diff=$('<div class="pdf-nav-diffs-diff">');var movedMarkerText=void 0;if(data.movedWithinPage!==undefined){movedMarkerText=interpolate(gettext("Moved within page %s"),[data.movedWithinPage+1])}else if(data.movedToPage!==undefined){movedMarkerText=interpolate(gettext("Moved to page %s"),[data.movedToPage+1])}else if(data.movedFromPage!==undefined){movedMarkerText=interpolate(gettext("Moved from page %s"),[data.movedFromPage+1])}if(movedMarkerText){$('<div class="pdf-nav-diffs-moved-marker">').text(movedMarkerText).appendTo($li);$diff.addClass("moved")}$("<strong>").text(page+" ").appendTo($diff);$("<span>").text(data.content).appendTo($diff);$diff.appendTo($li)}});if(!this._rendered){this.listenTo(reviewable,"change:diffData",this.render);this._rendered=true}return this},_onItemClicked:function _onItemClicked(ev){var $target=$(ev.currentTarget);var leftPage=$target.data("leftPage");var rightPage=$target.data("rightPage");var reviewable=this.model.get("reviewable");reviewable.get("diffAgainstPDF").set("currentPage",leftPage);reviewable.get("pdf").set("currentPage",rightPage)}});"use strict";PowerPack.PDF.SidebarView=Backbone.View.extend({initialize:function initialize(options){this._pageRenderer=options.pageRenderer;this._currentView=null;this._outlineView=null;this._thumbnailsView=null},render:function render(){var reviewable=this.model.get("reviewable");var pdf=reviewable.get("pdf");var outline=pdf.get("outlineMap");this._outlineSidebarView=this._createSidebarModeView(PowerPack.PDF.SidebarModeOutlineView,this.$(".pdf-nav-outline"));this._thumbnailsSidebarView=this._createSidebarModeView(PowerPack.PDF.SidebarModeThumbnailsView,this.$(".pdf-nav-pages"),{pageRenderer:this._pageRenderer,scrollContainer:this.el});this._sidebarDiffsView=this._createSidebarModeView(PowerPack.PDF.SidebarDiffsView,this.$(".pdf-nav-diffs"));this.listenTo(this.model,"change:mode",this._onModeChanged);this._onModeChanged();return this},_createSidebarModeView:function _createSidebarModeView(ViewType,$parent){var viewOptions=arguments.length>2&&arguments[2]!==undefined?arguments[2]:{};var view=new ViewType(_.defaults({model:this.model},viewOptions));view.render().$el.hide().appendTo($parent);return view},_onModeChanged:function _onModeChanged(){var mode=this.model.get("mode");if(this._currentSidebarView){this.stopListening(this._currentSidebarView,"sidebarItemSelected");this._currentSidebarView.setVisible(false)}if(mode===PowerPack.PDF.Sidebar.MODE_OUTLINE){this._currentSidebarView=this._outlineSidebarView}else if(mode===PowerPack.PDF.Sidebar.MODE_THUMBNAILS){this._currentSidebarView=this._thumbnailsSidebarView}else if(mode===PowerPack.PDF.Sidebar.MODE_DIFFS){this._currentSidebarView=this._sidebarDiffsView}this.listenTo(this._currentSidebarView,"sidebarItemSelected",this._onSidebarItemSelected);this._currentSidebarView.setVisible(true)}});"use strict";(function(){var ThumbnailView=PowerPack.PDF.RenderablePageView.extend({className:"item page-thumb",events:{"click canvas":"_onCanvasClicked"},setSelected:function setSelected(selected){this.$el.toggleClass("selected",selected)},render:function render(pageRenderer){PowerPack.PDF.RenderablePageView.prototype.render.call(this);this.$el.data("page",this.pageNum).append(this.$canvas);pageRenderer.scheduleRender(this,{fitToWidth:true});return this},_onCanvasClicked:function _onCanvasClicked(e){e.preventDefault();e.stopPropagation();this.$el.trigger("click")}});PowerPack.PDF.SidebarModeThumbnailsView=PowerPack.PDF.SidebarModeView.extend({className:"page-thumbs",events:{"click .item":"_onItemClicked"},initialize:function initialize(options){this.pageRenderer=options.pageRenderer;this.scrollContainer=options.scrollContainer;this._thumbnailViews=[];this._selectedThumbnailView=null},setVisible:function setVisible(visible){PowerPack.PDF.SidebarModeView.prototype.setVisible.call(this,visible);if(visible&&this._selectedThumbnailView){this._scrollToSelectedThumbnail(false)}},render:function render(){var reviewable=this.model.get("reviewable");var pdf=reviewable.get("pdf");this.listenTo(pdf,"change:currentPage",this._onPageNumChanged);this._onPageNumChanged();this.listenTo(pdf,"change:numPages",this._renderThumbnails);this._renderThumbnails();return this},_renderThumbnails:function _renderThumbnails(){var reviewable=this.model.get("reviewable");var pdf=reviewable.get("pdf");for(var i=0;i<this._thumbnailViews.length;i++){this._thumbnailViews[i].remove()}this._thumbnailViews=[];this._selectedThumbnailView=null;for(var _i=1;_i<=pdf.get("numPages");_i++){var thumbnailView=new ThumbnailView({pageNum:_i});thumbnailView.render(this.pageRenderer).$el.appendTo(this.$el);this._thumbnailViews.push(thumbnailView)}},_scrollToSelectedThumbnail:function _scrollToSelectedThumbnail(animate){var $thumbnail=this._selectedThumbnailView.$el;var thumbnailHeight=$thumbnail.outerHeight(true);var thumbnailPos=$thumbnail.position();var scrollTop=this.scrollContainer.scrollTop;var visibleHeight=this.scrollContainer.offsetHeight;var newScrollTop=null;if(thumbnailPos.top<0){newScrollTop=scrollTop+thumbnailPos.top}else if(thumbnailPos.top+thumbnailHeight>=visibleHeight){newScrollTop=scrollTop+thumbnailPos.top-visibleHeight+thumbnailHeight}if(newScrollTop!==null){if(animate!==false){$(this.scrollContainer).stop(true).animate({scrollTop:newScrollTop})}else{this.scrollContainer.scrollTop=newScrollTop}}},_onItemClicked:function _onItemClicked(e){var pageNum=$(e.target).data("page");if(pageNum){var reviewable=this.model.get("reviewable");var pdf=reviewable.get("pdf");pdf.set("currentPage",pageNum)}},_onPageNumChanged:function _onPageNumChanged(){var reviewable=this.model.get("reviewable");var pdf=reviewable.get("pdf");var pageNum=pdf.get("currentPage");if(pageNum===null||this._thumbnailViews.length===0){return}var thumbnailView=this._thumbnailViews[pageNum-1];if(this._selectedThumbnailView){this._selectedThumbnailView.setSelected(false)}thumbnailView.setSelected(true);this._selectedThumbnailView=thumbnailView;this._scrollToSelectedThumbnail()}})})();"use strict";PowerPack.PDF.RegionCommentBlockView=RB.RegionCommentBlockView.extend({initialize:function initialize(){RB.RegionCommentBlockView.prototype.initialize.call(this);this.model.on("change:scale",this._updateDimensions,this)},_updateDimensions:function _updateDimensions(){var model=this.model;var scale=model.get("scale");this.$el.move(model.get("x")*scale,model.get("y")*scale,"absolute").width(model.get("width")*scale).height(model.get("height")*scale)}});"use strict";PowerPack.PDF.ReviewableView=RB.FileAttachmentReviewableView.extend({className:"pdf-review-ui",commentBlockView:PowerPack.PDF.RegionCommentBlockView,template:'<div class="pdf-controls review-ui-header">\n <div class="pdf-controls-sidebar"></div>\n <div class="pdf-controls-center-outer">\n  <div class="pdf-controls-center-inner">\n   <div class="pdf-controls-page"></div>\n  </div>\n </div>\n <div class="pdf-controls-zoom"></div>\n <div class="pdf-controls-revision"></div>\n</div>\n<div class="pdf-lower">\n <div class="pdf-nav">\n  <div class="pdf-nav-outline"></div>\n  <div class="pdf-nav-pages"></div>\n  <div class="pdf-nav-diffs"></div>\n </div>\n</div>',spinnerTemplate:_.template('<div class="pdf-controls-diff-loading">\n <span class="fa fa-spinner fa-pulse"></span>\n <%- spinnerText %>\n</div>'),initialize:function initialize(options){var _this=this;RB.AbstractReviewableView.prototype.initialize.call(this,options);var pdf=this.model.get("pdf");var diffAgainstPDF=this.model.get("diffAgainstPDF");this._activeSelection=null;this._bottomSpacing=null;this._sidebarView=null;this._pageControlsView=null;this._sidebarControlsView=null;this._zoomControlsView=null;this._pagesView=null;this._sidebar=new PowerPack.PDF.Sidebar({reviewable:this.model});this._pageRenderer=new PowerPack.PDF.PageRendererView({model:this.model,pdf:pdf});this._scrollLock=true;this._blockScrollHandler=false;if(diffAgainstPDF){this._diffPageRenderer=new PowerPack.PDF.PageRendererView({model:this.model,pdf:diffAgainstPDF})}this._$lower=null;this._$window=$(window);this._$window.resize(_.bind(this._onWindowResize,this));if(location.hash&&location.hash.slice(0,6)==="#page-"){pdf.set("currentPage",parseInt(location.hash.slice(6),10))}this.on("commentBlockViewAdded",function(commentBlockView){var pagesView=commentBlockView.model.get("onDiffOrigFile")?_this._diffAgainstPagesView:_this._pagesView;if(pagesView&&pagesView.pages.length>0){pagesView.placeCommentBlockView(commentBlockView.model.get("page"),commentBlockView)}commentBlockView.model.set("scale",_this.model.get("scale"));_this.model.get("commentBlockViews").push(commentBlockView);commentBlockView.on("remove",function(){var viewsList=_this.model.get("commentBlockViews");viewsList=_.without(viewsList,commentBlockView);_this.model.set("commentBlockViews",viewsList)})})},renderContent:function renderContent(){var _this2=this;this.$el.html(this.template);this._$lower=this.$(".pdf-lower");this._sidebarView=new PowerPack.PDF.SidebarView({el:this.$(".pdf-nav"),model:this._sidebar,pageRenderer:this._pageRenderer});this._sidebarView.render();this.listenTo(this._sidebarView,"selectPage",this._jumpToPage);this._sidebarControlsView=new PowerPack.PDF.SidebarControlsView({el:this.$(".pdf-controls-sidebar"),model:this._sidebar});this._sidebarControlsView.render();this._pageControlsView=new PowerPack.PDF.PageControlsView({el:this.$(".pdf-controls-page"),model:this.model});this._pageControlsView.render();this._zoomControlsView=new PowerPack.PDF.ZoomControlsView({el:this.$(".pdf-controls-zoom"),model:this.model});this._zoomControlsView.render();if(this.model.get("numRevisions")>1){var $revisionControls=this.$(".pdf-controls-revision");var $revisionLabel=$('<div id="revision_label">').appendTo($revisionControls);this._revisionLabelView=new RB.FileAttachmentRevisionLabelView({el:$revisionLabel,model:this.model});this._revisionLabelView.render();var $revisionSelector=$('<div id="attachment_revision_selector">').appendTo($revisionControls);this._revisionSelectorView=new RB.FileAttachmentRevisionSelectorView({el:$revisionSelector,model:this.model});this._revisionSelectorView.render();this.listenTo(this._revisionLabelView,"revisionSelected",this._onRevisionSelected);this.listenTo(this._revisionSelectorView,"revisionSelected",this._onRevisionSelected)}var isDiff=this._diffPageRenderer!==undefined;if(isDiff){var $diffOffset=$('<div class="pdf-offset diff">').appendTo(this._$lower);this._diffAgainstPagesView=new PowerPack.PDF.PagesView({el:$diffOffset,model:this.model,origFile:true,pageRenderer:this._diffPageRenderer,pdf:this.model.get("diffAgainstPDF")});this.listenTo(this._diffAgainstPagesView,"commentRegionCreated",this.createAndEditCommentBlock);this._diffAgainstPagesView.render()}var $offset=$('<div class="pdf-offset">').toggleClass("diff",isDiff).toggleClass("diff-right",isDiff).appendTo(this._$lower);this._pagesView=new PowerPack.PDF.PagesView({el:$offset,model:this.model,origFile:false,pageRenderer:this._pageRenderer,pdf:this.model.get("pdf")});this.listenTo(this._pagesView,"commentRegionCreated",this.createAndEditCommentBlock);this._pagesView.render();if(isDiff){var diffData=this.model.get("diffData");if(diffData){this._applyDiffData(diffData)}else{_.defer(this._loadDiffData.bind(this))}this._diffAgainstPagesView.$el.on("scroll",function(){_this2._lockScroll(_this2._diffAgainstPagesView,_this2._pagesView)});this._pagesView.$el.on("scroll",function(){_this2._lockScroll(_this2._pagesView,_this2._diffAgainstPagesView)});this.listenTo(this.model,"change:scrollLock",function(){_this2._lockScroll(_this2._diffAgainstPagesView,_this2._pagesView)})}this.listenTo(this._sidebar,"change:visible",this._onSidebarToggled);_.defer(this._onWindowResize.bind(this));return this},_loadDiffData:function _loadDiffData(){var _this3=this;var $shimmer=$('<div class="pdf-shimmer">').appendTo(this._$lower);var $spinner=$(this.spinnerTemplate({spinnerText:gettext("Loading diffs...")})).appendTo(this.$(".pdf-controls-revision"));function showError(error){alert("Failed to generate PDF diffs: "+error);$spinner.remove();$shimmer.remove()}$.ajax(this.model.get("diffURL")).done(function(data){if(data.result==="success"){$shimmer.remove();$spinner.remove();_this3.model.set("diffData",data.data);_this3._applyDiffData(data.data)}else{showError(data.error)}}).fail(function(xhr,textStatus){var responseText=xhr.responseText;var rsp=null;try{rsp=JSON.parse(responseText)}catch(e){}if(rsp&&rsp.error){responseText=rsp.error}showError(responseText)})},_applyDiffData:function _applyDiffData(diffData){this._diffAgainstPagesView.addDiffRegions(diffData.filter(function(data){return data.op==="delete"}));this._pagesView.addDiffRegions(diffData.filter(function(data){return data.op==="insert"}))},_lockScroll:function _lockScroll(scroller,scrollee){if(this.model.get("scrollLock")&&!this._blockScrollHandler){this._blockScrollHandler=true;scrollee.$el.scrollTop(scroller.el.scrollTop);this._blockScrollHandler=false}},_onRevisionSelected:function _onRevisionSelected(revisions){var revisionIDs=this.model.get("attachmentRevisionIDs");var base=revisions[0];var tip=revisions[1];if(tip===0){return}var revisionTip=revisionIDs[tip-1];var redirectURL=void 0;if(base===0){redirectURL="../"+revisionTip+"/"}else{var revisionBase=revisionIDs[base-1];redirectURL="../"+revisionBase+"-"+revisionTip+"/"}window.location.replace(redirectURL)},_onWindowResize:function _onWindowResize(){if(!this.el.parentElement){return}this._$lower.height(this._$window.height()-this._$lower.offset().top-this._getBottomSpacing()-1)},_getBottomSpacing:function _getBottomSpacing(){var _this4=this;if(this._bottomSpacing===null){this._bottomSpacing=0;_.each(this.$el.parents(),function(parentEl){_this4._bottomSpacing+=$(parentEl).getExtents("bmp","b")})}return this._bottomSpacing},_onSidebarToggled:function _onSidebarToggled(){var sidebarVisible=this._sidebar.get("visible");this._sidebarView.$el.toggleClass("sidebar-open",sidebarVisible);this._pagesView.$el.toggleClass("sidebar-open",sidebarVisible);if(this._diffAgainstPagesView){this._diffAgainstPagesView.$el.toggleClass("sidebar-open",sidebarVisible)}this._onWindowResize()}});"use strict";PowerPack.PDF.ZoomControlsView=Backbone.View.extend({className:"pdf-controls-zoom",events:{"click .zoom-out":"_onZoomOut","click .zoom-in":"_onZoomIn"},template:_.template('<div class="fa fa-search-minus zoom-out"\n     title="<%- zoomOutText %>"></div>\n<div class="fa fa-search-plus zoom-in"\n     title="<%- zoomInText %>"></div>'),render:function render(){this.$el.html(this.template({zoomOutText:gettext("Zoom out"),zoomInText:gettext("Zoom in")}));return this},_onZoomOut:function _onZoomOut(){this.model.set("scale",Math.floor(this.model.get("scale")*(3/4)*10)/10)},_onZoomIn:function _onZoomIn(){this.model.set("scale",Math.ceil(this.model.get("scale")*(4/3)*10)/10)}})}).call(this);
