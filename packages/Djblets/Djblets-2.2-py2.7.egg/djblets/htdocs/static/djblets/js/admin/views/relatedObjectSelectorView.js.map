{"version":3,"sources":["relatedObjectSelectorView.es6.js"],"names":[],"mappings":"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","file":"relatedObjectSelectorView.js","sourcesContent":["/**\n * A widget to select related objects using search and autocomplete.\n *\n * This is particularly useful for models where there can be a ton of rows in\n * the database. The built-in admin widgets provide a pretty poor\n * experience--either populating the list with the entire contents of the\n * table, which is super slow, or just listing PKs, which isn't usable.\n */\nDjblets.RelatedObjectSelectorView = Backbone.View.extend({\n    className: 'related-object-selector',\n\n    /**\n     * The search placeholder text.\n     *\n     * Subclasses should override this.\n     */\n    searchPlaceholderText: '',\n\n    /**\n     * The element template.\n     *\n     * Subclasses may override this to change rendering.\n     */\n    template: _.template(dedent`\n        <select placeholder=\"<%- searchPlaceholderText %>\"\n                class=\"related-object-options\"></select>\n        <% if (multivalued) { %>\n        <ul class=\"related-object-selected\"></ul>\n        <% } %>\n    `),\n\n    /**\n     * Initialize the view.\n     *\n     * Args:\n     *     options (object):\n     *         Options for the view.\n     *\n     * Option Args:\n     *     $input (jQuery):\n     *         The ``<input>`` element which should be populated with the list\n     *         of selected item PKs.\n     *\n     *     initialOptions (Array of object):\n     *         The initially selected options.\n     *\n     *     multivalued (boolean):\n     *         Whether or not the widget should allow selecting multiple\n     *         values.\n     *\n     *     selectizeOptions (object):\n     *          Additional options to pass in to $.selectize.\n     */\n    initialize(options) {\n        this.options = options;\n        this._$input = options.$input;\n        this._selectizeOptions = options.selectizeOptions;\n        this._selectedIDs = new Map();\n\n        _.bindAll(this, 'renderOption');\n    },\n\n    /**\n     * Render the view.\n     *\n     * Returns:\n     *     RB.RelatedObjectSelectorView:\n     *     This object, for chaining.\n     */\n    render() {\n        const self = this;\n\n        this.$el.html(this.template({\n            searchPlaceholderText: this.searchPlaceholderText,\n            multivalued: this.options.multivalued,\n        }));\n\n        this._$selected = this.$('.related-object-selected');\n\n        const renderItem = this.options.multivalued\n                           ? () => ''\n                           : this.renderOption;\n\n        const selectizeOptions = _.defaults(this._selectizeOptions, {\n            copyClassesToDropdown: true,\n            dropdownParent: 'body',\n            preload: 'focus',\n            render: {\n                item: renderItem,\n                option: this.renderOption,\n            },\n            load(query, callback) {\n                self.loadOptions(\n                    query,\n                    data => callback(data.filter(\n                        item => !self._selectedIDs.has(item.id)\n                    ))\n                );\n            },\n            onChange(selected) {\n                if (selected) {\n                    self._onItemSelected(this.options[selected], true);\n\n                    if (self.options.multivalued) {\n                        this.removeOption(selected);\n                    }\n                }\n\n                if (self.options.multivalued) {\n                    this.clear();\n                }\n            },\n        });\n\n        if (!this.options.multivalued && this.options.initialOptions.length) {\n            const item = this.options.initialOptions[0];\n            selectizeOptions.options = this.options.initialOptions;\n            selectizeOptions.items = [item[selectizeOptions.valueField]];\n        }\n\n        this.$('select').selectize(selectizeOptions);\n\n        if (this.options.multivalued) {\n            this.options.initialOptions.forEach(\n                item => this._onItemSelected(item, false)\n            );\n        }\n\n        this._$input.after(this.$el);\n        return this;\n    },\n\n    /**\n     * Update the \"official\" ``<input>`` element.\n     *\n     * This copies the list of selected item IDs into the form field which will\n     * be submitted.\n     */\n    _updateInput() {\n        this._$input.val(Array.from(this._selectedIDs.keys()).join(','));\n    },\n\n    /**\n     * Callback for when an item is selected.\n     *\n     * Args:\n     *     item (object):\n     *         The newly-selected item.\n     *\n     *     addToInput (boolean):\n     *         Whether the ID of the item should be added to the ``<input>``\n     *         field.\n     *\n     *         This will be ``false`` when populating the visible list from the\n     *         value of the form field when the page is initially loaded, and\n     *         ``true`` when adding items interactively.\n     */\n    _onItemSelected(item, addToInput) {\n        if (this.options.multivalued) {\n            const $li = $('<li>').html(this.renderOption(item));\n            const $items = this._$selected.children();\n            const text = $li.text();\n\n            $('<span class=\"remove-item fa fa-close\">')\n                .click(() => this._onItemRemoved($li, item))\n                .appendTo($li);\n\n            let attached = false;\n\n            for (let i = 0; i < $items.length; i++) {\n                const $item = $items.eq(i);\n\n                if ($item.text().localeCompare(text) > 0) {\n                    $item.before($li);\n                    attached = true;\n                    break;\n                }\n            }\n\n            if (!attached) {\n                $li.appendTo(this._$selected);\n            }\n\n            this._selectedIDs.set(item.id, item);\n\n            if (addToInput) {\n                this._updateInput();\n            }\n        } else {\n            this._selectedIDs = new Map([[item.id, item]]);\n            this._updateInput();\n        }\n    },\n\n    /**\n     * Callback for when an item is removed from the list.\n     *\n     * Args:\n     *     $li (jQuery):\n     *         The element representing the item in the selected list.\n     *\n     *     item (object):\n     *         The item being removed.\n     */\n    _onItemRemoved($li, item) {\n        $li.remove();\n        this._selectedIDs.delete(item.id);\n        this._updateInput();\n    },\n\n    /**\n     * Render an option in the drop-down menu.\n     *\n     * This should be overridden in order to render type-specific data.\n     *\n     * Args:\n     *     item (object):\n     *         The item to render.\n     *\n     * Returns:\n     *     string:\n     *     HTML to insert into the drop-down menu.\n     */\n    renderOption(/* item */) {\n        return '';\n    },\n\n    /**\n     * Load options from the server.\n     *\n     * This should be overridden in order to make necessary API requests.\n     *\n     * Args:\n     *     query (string):\n     *         The string typed in by the user.\n     *\n     *     callback (function):\n     *         A callback to be called once data has been loaded. This should\n     *         be passed an array of objects, each representing an option in\n     *         the drop-down.\n     */\n    loadOptions(query, callback) {\n        callback();\n    },\n});\n"]}