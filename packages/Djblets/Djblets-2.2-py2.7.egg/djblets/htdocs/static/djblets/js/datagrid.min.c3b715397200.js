(function(){(function($){$.fn.datagrid=function(){var $grid=this,gridId=this.attr("id"),$menu=$("#"+gridId+"-menu"),$gridMain=$grid.children(".datagrid-main"),$gridContainer=$gridMain.children(".datagrid"),$bodyContainer=$gridContainer.children(".datagrid-body-container"),$headTable=$gridContainer.children(".datagrid-head"),$bodyTable=$bodyContainer.children(".datagrid-body"),$bodyTableHead=$bodyTable.children("thead"),$paginator=$gridContainer.children(".paginator"),$window=$(window),editButtonSel="#"+gridId+"-edit",$editButton,storedColWidths=[],activeColumns=[],menuOpen=false,inMobileMode=null,columnMidpoints=[],dragColumn=null,dragColumnsChanged=false,dragColumnWidth=0,dragIndex=0,dragLastX=0,$savedTBody,$savedTHead,lastWindowWidth;this.reload=function(){loadFromServer(null,true)};this.resizeToFit=function(){var newHeight;roundGridPixels();newHeight=Math.ceil($grid.innerHeight()-$bodyContainer.position().top-$gridMain.position().top-$gridMain.getExtents("b","tb")-($paginator.outerHeight()||0));$bodyContainer.height(newHeight);$menu.outerHeight(newHeight);syncColumnSizes();if(menuOpen){updateMenuPosition()}};function setupHeader(){var $origHeader=$bodyTable.children("thead"),$thead;activeColumns=[];$bodyTable.find("colgroup col").each(function(i,colEl){storedColWidths.push(colEl.width);if(colEl.className!=="datagrid-customize"){activeColumns.push(colEl.className)}});$thead=$origHeader.clone().show();$headTable.children("thead").remove().end().append($thead).show();$origHeader.hide();$headTable.find("th").disableSelection().not(".edit-columns").draggable({appendTo:"body",axis:"x",containment:$thead,cursor:"move",helper:function(){var $el=$(this);return $("<div/>").addClass("datagrid-header-drag datagrid-header").width($el.width()).height($el.height()).css("top",$el.offset().top).css("line-height",$el.height()+"px").html($el.html())},start:startColumnDrag,stop:endColumnDrag,drag:onColumnDrag});$headTable.find(".datagrid-header-checkbox").change(function(){var $checkbox=$(this),colName=$checkbox.data("checkbox-name");$bodyTable.find('tbody input[data-checkbox-name="'+colName+'"]').prop("checked",$checkbox.prop("checked")).change()});$editButton=$(editButtonSel)}function syncColumnSizes(){var origHeaderCells=$bodyTableHead[0].rows[0].cells,$fixedCols=$headTable.find("colgroup col"),$origCols=$bodyTable.find("colgroup col"),hasEditColumns=$fixedCols.filter(".datagrid-customize").length>0,numCols=origHeaderCells.length,lastColIndex=numCols-(hasEditColumns?2:1),bodyWidths=[],headWidths=[],bodyContainerWidth,width,i;for(i=0;i<numCols;i++){$origCols[i].width=storedColWidths[i]}$bodyTableHead.show();bodyContainerWidth=$bodyContainer.outerWidth();$headTable.width(bodyContainerWidth);extraWidth=bodyContainerWidth-$bodyTable.width();for(i=0;i<numCols;i++){width=$(origHeaderCells[i]).outerWidth();bodyWidths.push(width);headWidths.push(width)}$bodyTableHead.hide();headWidths[lastColIndex]=bodyWidths[lastColIndex]+extraWidth;for(i=0;i<numCols;i++){$origCols[i].width=bodyWidths[i];$fixedCols[i].width=headWidths[i]}}function onResize(){var windowWidth=$window.width(),newMobileMode;if(windowWidth!==lastWindowWidth){lastWindowWidth=windowWidth;roundGridPixels();newMobileMode=$bodyTable.css("display")==="block";if(newMobileMode!==inMobileMode){if(newMobileMode){enableMobileMode()}else{disableMobileMode()}inMobileMode=newMobileMode}$editButton=$(editButtonSel);syncColumnSizes();if(menuOpen){updateMenuPosition()}}}function roundGridPixels(){var width;$gridMain.css("max-width","");width=Math.ceil($gridMain.width());if(width>0){$gridMain.css("max-width",width)}}function enableMobileMode(){var table=$bodyTable[0],rows=table.tBodies[0].rows,rowsLen=rows.length,columnsLen=activeColumns.length,standaloneColumns={},hasStandaloneColumns=false,labels=[],$newTBody=$("<tbody/>"),$newRow,$newCell,$prevRow,$toDelete,$cell,deleteCell,row,i,j;$bodyTableHead.find("th").each(function(i,cell){var $cell=$(cell);if($cell.hasClass("has-label")){standaloneColumns[i]=true;labels.push($cell.text().strip());hasStandaloneColumns=true}else{labels.push(null)}});if(!hasStandaloneColumns){return}for(i=0;i<rowsLen;i++){$toDelete=$();row=rows[i];$newRow=$(row).clone();$newTBody.append($newRow);$prevRow=$newRow;for(j=0;j<columnsLen;j++){deleteCell=false;$cell=$($newRow[0].cells[j]);if(standaloneColumns[j]){$newCell=$cell.clone().attr("colspan",columnsLen);deleteCell=true;$prevRow.addClass("datagrid-row-continues");$prevRow=$('<tr class="mobile-only-row"/>').addClass(row.className).append($("<th/>").text(labels[j])).append($newCell).appendTo($newTBody)}else if(!$cell.html().strip()){deleteCell=true}else{$cell.attr("colspan","")}if(deleteCell){$toDelete=$toDelete.add($cell);$newRow.append("<td/>")}}if(columnsLen-$toDelete.length===0){$newRow.remove()}else{$toDelete.remove();$newRow.prepend("<th/>")}}$savedTHead=$headTable.find("thead").clone();$headTable.find("thead th").not(".edit-columns").text("");$savedTBody=$(table.tBodies[0]);$(table.tBodies[0]).replaceWith($newTBody);$grid.attr("data-datagrid-display-mode","mobile").trigger("datagridDisplayModeChanged",{mode:"mobile"})}function disableMobileMode(){if($savedTBody){$($bodyTable[0].tBodies[0]).replaceWith($savedTBody);$headTable.find("thead").replaceWith($savedTHead)}$grid.attr("data-datagrid-display-mode","desktop").trigger("datagridDisplayModeChanged",{mode:"desktop"})}function loadFromServer(params,reloadGrid){var search=window.location.search||"?",url=window.location.pathname+search+"&gridonly=1&datagrid-id="+gridId;if(params){url+="&"+params}$.get(url,function(html){if(reloadGrid){$grid.replaceWith(html);$grid=$("#"+gridId).datagrid()}else{setupHeader()}$grid.trigger("reloaded")})}function hideColumnsMenu(){$menu.animate({right:-$menu.outerWidth()},{complete:function(){$menu.hide();menuOpen=false}})}function toggleColumnsMenu(){if(!$menu.is(":animated")){if($menu.is(":visible")){hideColumnsMenu()}else{updateMenuPosition()}}}function updateMenuPosition(){$menu.css({top:$editButton.position().top+$editButton.innerHeight(),right:-$menu.outerWidth()}).show().animate({right:0},{complete:function(){menuOpen=true}})}function saveColumns(columnsStr,reloadGrid){loadFromServer("columns="+columnsStr,reloadGrid)}function toggleColumn(columnId){saveColumns(serializeColumns(columnId),true)}function serializeColumns(addedColumn){var columnsStr="";$(activeColumns).each(function(i){var curColumn=activeColumns[i];if(curColumn===addedColumn){addedColumn=null}else{columnsStr+=curColumn;if(i<activeColumns.length-1){columnsStr+=","}}});if(addedColumn){columnsStr+=","+addedColumn}return columnsStr}function startColumnDrag(evt,ui){dragColumn=this;dragColumnsChanged=false;dragColumnWidth=ui.helper.width();dragIndex=0;dragLastX=0;buildColumnInfo();$(dragColumn).css("visibility","hidden")}function endColumnDrag(){var $column=$(this);$column.css("visibility","visible");columnMidpoints=[];if(dragColumnsChanged){saveColumns(serializeColumns())}}function onColumnDrag(e,ui){var x=e.originalEvent.pageX,hitX=-1,index=-1;if(x===dragLastX){return}if(x<dragLastX){index=dragIndex-1;hitX=ui.offset.left}else{index=dragIndex+1;hitX=ui.offset.left+ui.helper.width()}if(index>=0&&index<columnMidpoints.length){if(x<dragLastX&&hitX<=columnMidpoints[index]){swapColumnBefore(dragIndex,index)}else if(x>dragLastX&&hitX>=columnMidpoints[index]){swapColumnBefore(index,dragIndex)}}dragLastX=x}function buildColumnInfo(){columnMidpoints=[];$headTable.find("th").not(".edit-columns").each(function(i,column){var $column=$(column),offset=$column.offset();if(column===dragColumn){dragIndex=i;width=dragColumnWidth}else{width=$column.width()}columnMidpoints.push(Math.round(offset.left+width/2))})}function swapColumnBefore(index,beforeIndex){var temp;temp=activeColumns[index];activeColumns[index]=activeColumns[beforeIndex];activeColumns[beforeIndex]=temp;swapColumns($bodyTable[0],beforeIndex,index);swapColumns($headTable[0],beforeIndex,index);temp=storedColWidths[index];storedColWidths[index]=storedColWidths[beforeIndex];storedColWidths[beforeIndex]=temp;dragColumnsChanged=true;buildColumnInfo()}function swapColumns(table,beforeIndex,index){var beforeCell,tempColSpan,colTags=$(table).find("colgroup col"),row,cell,rowsLen,i;colTags.eq(index).insertBefore(colTags.eq(beforeIndex));for(i=0,rowsLen=table.rows.length;i<rowsLen;i++){row=table.rows[i];cell=row.cells[index];beforeCell=row.cells[beforeIndex];row.insertBefore(cell,beforeCell);tempColSpan=cell.colSpan;cell.colSpan=beforeCell.colSpan;beforeCell.colSpan=tempColSpan}}$grid.data("datagrid",this).on("click",editButtonSel,function(e){e.stopPropagation();toggleColumnsMenu()});setupHeader();$menu.find("tr").each(function(i,row){var className=row.className;$(row).find(".datagrid-menu-checkbox, .datagrid-menu-label a").click(function(){toggleColumn(className);return false})});$bodyContainer.find("tr").on("click",function(e){var $target=$(e.target),url;if(!$target.is("input")&&$target.parents(".has-link").length===0){url=$(this).data("url");if(url){window.location=url}}});$(document).on("click",hideColumnsMenu).on("click",".datagrid-body input",function(e){e.stopPropagation()});$window.resize(onResize);onResize();return $grid};$(document).ready(function(){$("div.datagrid-wrapper").datagrid()})})(jQuery)}).call(this);
