{"version":3,"sources":["fileUploadSettingsFormView.es6.js"],"names":[],"mappings":"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","file":"fileUploadSettingsFormView.js","sourcesContent":["(function() {\n\n\nconst allowedMimeTypes = [\n    'image/png', 'image/jpeg', 'image/gif'\n];\n\n\nconst ParentView = Djblets.Avatars.ServiceSettingsFormView;\n\n\n/**\n * A file upload avatar settings form.\n *\n * This form provides a preview of the uploaded avatar.\n */\nDjblets.Avatars.FileUploadSettingsFormView = ParentView.extend({\n    events: {\n        'change #id_file-upload-avatar_upload': '_onFileChanged',\n        'click .avatar-file-upload-browse': '_onBrowseClicked',\n        'click .avatar-preview': '_onBrowseClicked',\n        'dragenter .avatar-file-upload-config': '_onDragEnter',\n        'dragover .avatar-file-upload-config': '_onDragOver',\n        'dragleave .avatar-file-upload-config': '_onDragLeave',\n        'drop .avatar-file-upload-config': '_onDrop',\n    },\n\n    /**\n     * Validate the form.\n     *\n     * If a file is selected, ensure it is has the correct MIME type.\n     */\n    validate() {\n        const file = this._$fileInput[0].files[0];\n\n        if (!file) {\n            alert(_`You must choose a file.`);\n            return false;\n        }\n\n        if (!allowedMimeTypes.some(el => (el === file.type))) {\n            alert(_`\n                This wasn't a valid image file format. Please provide a PNG,\n                JPEG, or GIF file.\n            `);\n            return false;\n        }\n\n        return true;\n    },\n\n    /**\n     * Render the form.\n     *\n     * Returns:\n     *     Djblets.Avatars.FileUploadSettingsFormView:\n     *     This view (for chaining).\n     */\n    render() {\n        this._$box = this.$('.avatar-file-upload-config');\n        this._$preview = this.$('.avatar-preview');\n        this._$fileInput = this.$('#id_file-upload-avatar_upload');\n\n        return this;\n    },\n\n    /**\n     * Handler for a click event on the \"browse\" instruction text.\n     *\n     * This will trigger opening the hidden file input.\n     *\n     * Args:\n     *     e (jQuery.Event):\n     *         The click event.\n     */\n    _onBrowseClicked(e) {\n        e.preventDefault();\n        e.stopPropagation();\n\n        /*\n         * Clicking on the file input itself is not reliable. There are ways\n         * to make it work, but the browser actively avoids letting you do it if\n         * it seems to be hidden. However, it works just fine universally to\n         * click on the label.\n         */\n        this.$('#avatar-file-upload-browse-label').click();\n    },\n\n    /**\n     * Handler for a drag enter event.\n     *\n     * If the configuration box is being hovered over, this will enable the\n     * hover state, giving users an indication that they can drop the image\n     * there.\n     *\n     * Args:\n     *     e (jQuery.Event):\n     *         The drag over event.\n     */\n    _onDragEnter(e) {\n        e.preventDefault();\n        e.stopPropagation();\n\n        if (e.target === this._$box[0]) {\n            this._$box\n                .width(this._$box.width())\n                .addClass('drag-hover');\n        }\n    },\n\n    /**\n     * Handler for a drag over event.\n     *\n     * If the configuration box is being hovered over, this will set the drop\n     * effect.\n     *\n     * Args:\n     *     e (jQuery.Event):\n     *         The drag over event.\n     */\n    _onDragOver(e) {\n        e.preventDefault();\n        e.stopPropagation();\n\n        if (e.target === this._$box[0]) {\n            const dt = e.originalEvent.dataTransfer;\n\n            if (dt) {\n                dt.dropEffect = 'copy';\n            }\n        }\n    },\n\n    /**\n     * Handler for a drag leave event.\n     *\n     * If the configuration box is being left, this will remove the hover state\n     * and reset the drop effect.\n     *\n     * Args:\n     *     e (jQuery.Event):\n     *         The drag leave event.\n     */\n    _onDragLeave(e) {\n        e.preventDefault();\n        e.stopPropagation();\n\n        if (e.target === this._$box[0]) {\n            this._$box\n                .removeClass('drag-hover')\n                .width('auto');\n\n            const dt = e.originalEvent.dataTransfer;\n\n            if (dt) {\n                dt.dropEffect = 'none';\n            }\n        }\n    },\n\n    /**\n     * Handler for a drop operation.\n     *\n     * This will remove the hover state and attempt to set the list of files\n     * on the file input. If this fails (which will be the case on some browsers\n     * with older behavior), the user will receive an alert telling them it\n     * failed and to try browsing instead.\n     *\n     * If all goes well, the avatar will be ready for upload and the preview\n     * image will be updated.\n     *\n     * Args:\n     *     e (jQuery.Event):\n     *         The drop event.\n     */\n    _onDrop(e) {\n        e.preventDefault();\n        e.stopPropagation();\n\n        this._$box.removeClass('drag-hover');\n\n        const dt = e.originalEvent.dataTransfer;\n        const files = dt && dt.files;\n\n        if (!files || files.length === 0) {\n            return;\n        }\n\n        if (files.length > 1) {\n            alert(_`\n                You can only set one file as your avatar. Please drag and\n                drop a single file.\n            `);\n            return;\n        }\n\n        const fileType = files[0].type;\n\n        if (fileType !== 'image/png' && fileType !== 'image/jpeg' &&\n            fileType !== 'image/gif') {\n            alert(_`\n                This doesn't appear to be a compatible image file for avatars.\n                Please upload a PNG, JPEG, or GIF file.\n            `);\n            return;\n        }\n\n        try {\n            this._$fileInput[0].files = files;\n        } catch (exc) {\n            /*\n             * While most modern browsers allow setting the `files` property of\n             * an input field to the rest of a drag-and-drop operation, not all\n             * do (I'm looking at you, IE/Edge). Older browsers will also\n             * complain. So instead of outright failing, tell the user that this\n             * won't work and suggest a workaround.\n             */\n            alert(_`\n                Looks like dragging to upload a file isn't going to work with\n                your browser. Try browsing for a file instead.\n            `);\n            return;\n        }\n\n        this._setAvatarFromFile(files[0]);\n    },\n\n    /**\n     * Handler for when the file input has changed.\n     *\n     * This will update the preview image.\n     *\n     * Args:\n     *     e (jQuery.Event):\n     *         The change event.\n     */\n    _onFileChanged(e) {\n        const file = e.target.files[0];\n\n        if (file) {\n            this._setAvatarFromFile(file);\n        }\n    },\n\n    /**\n     * Set the avatar from the provided file upload.\n     *\n     * Args:\n     *     file (File):\n     *         The file that was uploaded.\n     */\n    _setAvatarFromFile(file) {\n        const reader = new FileReader();\n\n        reader.addEventListener('load', () => {\n            this._$preview\n                .empty()\n                .removeClass('avatar-preview-unset')\n                .append($('<img />').attr({\n                     src: reader.result,\n                     alt: _`Your new avatar`,\n                 }));\n        });\n\n        reader.readAsDataURL(file);\n    },\n});\n\n\n})();\n"]}