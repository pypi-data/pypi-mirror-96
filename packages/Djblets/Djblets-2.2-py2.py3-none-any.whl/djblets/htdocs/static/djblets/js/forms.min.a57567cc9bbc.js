(function(){window.Djblets=window.Djblets||{};Djblets.Forms={};"use strict";Djblets.Forms.ConditionChoice=Backbone.Model.extend({defaults:{name:null,valueField:null},initialize:function initialize(attributes){this.operators=new Backbone.Collection(attributes.operators,{model:Djblets.Forms.ConditionOperator,parse:true})},createValueField:function createValueField(fieldName){var valueField=this.get("valueField");return new valueField.viewClass(_.defaults({model:new valueField.modelClass(_.defaults({fieldName:fieldName},valueField.modelData))},valueField.viewData))},parse:function parse(data){return{id:data.id,name:data.name,valueField:Djblets.Forms.ConditionChoice.parseValueFieldData(data.valueField)}}},{parseValueFieldData:function parseValueFieldData(data){var valueField=null;if(data!==undefined){var fieldModelInfo=data.model;var fieldViewInfo=data.view;valueField={modelClass:Djblets.getObjectByName(fieldModelInfo.className),modelData:fieldModelInfo.data,viewClass:Djblets.getObjectByName(fieldViewInfo.className),viewData:fieldViewInfo.data}}return valueField}});"use strict";Djblets.Forms.Condition=Backbone.Model.extend({defaults:{choice:null,error:null,operator:null,valid:true,value:null},initialize:function initialize(){var _this=this;this.on("change",function(){var choice=_this.get("choice");if(choice!==_this.previous("choice")){_this.set("operator",choice.operators.first());_this.unset("value")}})},destroy:function destroy(options){this.stopListening();this.trigger("destroy",this,this.collection,options)}});"use strict";Djblets.Forms.ConditionOperator=Backbone.Model.extend({defaults:{name:null,useValue:false,valueField:null},createValueField:function createValueField(fieldName){var valueField=this.get("valueField");console.assert(valueField,"This operator does not have a custom valueField.");return new valueField.viewClass(_.defaults({model:new valueField.modelClass(_.defaults({fieldName:fieldName},valueField.modelData))},valueField.viewData))},parse:function parse(data){return{id:data.id,name:data.name,useValue:data.useValue,valueField:Djblets.Forms.ConditionChoice.parseValueFieldData(data.valueField)}}});"use strict";Djblets.Forms.ConditionSet=Backbone.Model.extend({defaults:{fieldName:null,lastID:null},initialize:function initialize(attributes){var _this=this;this.choices=new Backbone.Collection(attributes.choicesData,{model:Djblets.Forms.ConditionChoice,parse:true});this.conditions=new Backbone.Collection(attributes.conditionsData,{model:function model(attrs,options){var choice=attrs.choice||_this.choices.get(attrs.choiceID);var operator=attrs.operator||(choice?choice.operators.get(attrs.operatorID):null);var lastID=_this.get("lastID");var conditionID=lastID===null?0:lastID+1;_this.set("lastID",conditionID);return new Djblets.Forms.Condition({id:conditionID,choice:choice,operator:operator,value:attrs.value,valid:attrs.valid,error:attrs.error},options)}})},addNewCondition:function addNewCondition(){var choice=this.choices.first();this.conditions.add({choice:choice,operator:choice.operators.first()})},parse:function parse(data){return{fieldName:data.fieldName}}});"use strict";Djblets.Forms.ConditionValueField=Backbone.Model.extend({defaults:{fieldHTML:null}});"use strict";Djblets.Forms.BaseConditionValueFieldView=Backbone.View.extend({tagName:"span",render:function render(){this.$el.html(this.model.get("fieldHTML"));return this},setValue:function setValue(value){console.assert(false,"setValue() must be implemented by this subclass.")},getValue:function getValue(){console.assert(false,"getValue() must be implemented by this subclass.")}});"use strict";(function(){var BaseConditionRowView=Backbone.View.extend({tagName:"li",className:"conditions-field-row",events:{"click .conditions-field-row-delete":"_onDeleteClicked"},initialize:function initialize(options){var _this=this;this.listenTo(this.model,"destroy",function(){_this.$el.slideUp(options.rowAnimationSpeedMS,_this.remove.bind(_this))})},_onDeleteClicked:function _onDeleteClicked(e){e.stopPropagation();e.preventDefault();this.model.destroy()}});var ConditionRowView=BaseConditionRowView.extend({template:_.template(['<span class="conditions-field-action conditions-field-row-delete">\n',' <span class="fa fa-minus-circle"></span>\n',"</span>\n",'<span class="conditions-field-row-options">\n'," <% if (error) { %>",'  <ul class="error-list"><li><%- error %></li></ul>\n'," <% } %>",' <span class="conditions-field-choice"></span>\n',' <span class="conditions-field-operator"></span>\n',' <span class="conditions-field-value"></span>\n',"</span>"].join("")),events:_.extend({"change .conditions-field-choice select":"_onSelectChoiceChanged","change .conditions-field-operator select":"_onSelectOperatorChanged"},BaseConditionRowView.prototype.events),initialize:function initialize(options){BaseConditionRowView.prototype.initialize.call(this,options);this.conditionSet=options.conditionSet;this._$choice=null;this._$operator=null;this._$valueWrapper=null;this._$newValue=null;this._defaultValueField=null;this._valueField=null},render:function render(){var _this2=this;this.$el.html(this.template(this.model.attributes));var $rowOptions=this.$el.children(".conditions-field-row-options");var fieldName=this.conditionSet.get("fieldName");var rowNum=this.model.get("id");this._$choice=$("<select/>").attr("name",fieldName+"_choice["+rowNum+"]");this.conditionSet.choices.each(function(choice){_this2._$choice.append($("<option/>").val(choice.id).text(choice.get("name")))});this._$choice.appendTo($rowOptions.children(".conditions-field-choice"));this._$operator=$("<select/>").attr("name",fieldName+"_operator["+rowNum+"]").appendTo($rowOptions.children(".conditions-field-operator"));this._$valueWrapper=$rowOptions.children(".conditions-field-value");this.listenTo(this.model,"change:choice",this._onChoiceChanged);this.listenTo(this.model,"change:operator",this._onOperatorChanged);this.listenTo(this.model,"change:value",this._onValueChanged);this._onChoiceChanged();this._onOperatorChanged();this._onValueChanged();return this},_onChoiceChanged:function _onChoiceChanged(){var _this3=this;var choice=this.model.get("choice");var fieldName=this.conditionSet.get("fieldName");var rowNum=this.model.get("id");this._$choice.val(choice.id);this._defaultValueField=choice.createValueField(fieldName+"_value["+rowNum+"]");this._$operator.empty();choice.operators.each(function(operator){_this3._$operator.append($("<option/>").val(operator.id).text(operator.get("name")))});this._$operator.val(this.model.get("operator").id)},_onOperatorChanged:function _onOperatorChanged(){var operator=this.model.get("operator");var newValueField=void 0;this._$operator.val(operator.id);this._$valueWrapper.setVisible(operator.get("useValue"));if(operator.get("valueField")!==null){var fieldName=this.conditionSet.get("fieldName");var rowNum=this.model.get("id");newValueField=operator.createValueField(fieldName+"_value["+rowNum+"]")}else{newValueField=this._defaultValueField}if(newValueField!==this._valueField){if(this._$newValue!==null&&newValueField!==this._valueField){this._$newValue.remove();this._$newValue=null}this._valueField=newValueField;this._$newValue=this._valueField.render().$el.appendTo(this._$valueWrapper)}},_onValueChanged:function _onValueChanged(){this._valueField.setValue(this.model.get("value"))},_onSelectChoiceChanged:function _onSelectChoiceChanged(){this.model.set("choice",this.conditionSet.choices.get(this._$choice.val()))},_onSelectOperatorChanged:function _onSelectOperatorChanged(){var choice=this.model.get("choice");this.model.set("operator",choice.operators.get(this._$operator.val()))}});var DisabledConditionRowView=BaseConditionRowView.extend({render:function render(){var value=this.model.get("value");if(value!==null){this.$(".conditions-field-value").text(value)}return this}});Djblets.Forms.ConditionSetView=Backbone.View.extend({DEFAULT_ROW_ANIMATION_SPEED_MS:300,events:{"click .conditions-field-add-condition":"_onAddRowClicked","change #conditions_mode input":"_onConditionModeChanged"},initialize:function initialize(options){this._rowAnimationSpeedMS=options.rowAnimationSpeedMS||this.DEFAULT_ROW_ANIMATION_SPEED_MS;this._$lastID=null;this._$rows=null},render:function render(){var _this4=this;var fieldName=this.model.get("fieldName");var conditions=this.model.conditions;this._$lastID=this.$el.children("input[name="+fieldName+"_last_id]").bindProperty("value",this.model,"lastID");this._$mode=this.$("#conditions_mode input");this._$rowsContainer=this.$(".conditions-field-rows-container");this._$rows=this._$rowsContainer.children(".conditions-field-rows");var $rowItems=this._$rows.children();conditions.each(function(condition,i){_this4._addConditionRow(condition,$rowItems[i])});this.listenTo(conditions,"add",function(condition){return _this4._addConditionRow(condition)});this._onConditionModeChanged();return this},_addConditionRow:function _addConditionRow(condition,$rowEl){var RowViewCls=condition.get("valid")?ConditionRowView:DisabledConditionRowView;var rowView=new RowViewCls({conditionSet:this.model,el:$rowEl,model:condition,rowAnimationSpeedMS:this._rowAnimationSpeedMS});rowView.render();if($rowEl===undefined){rowView.$el.hide().appendTo(this._$rows).slideDown(this._rowAnimationSpeedMS)}},_onAddRowClicked:function _onAddRowClicked(e){e.stopPropagation();e.preventDefault();this.model.addNewCondition()},_onConditionModeChanged:function _onConditionModeChanged(){var mode=this._$mode.filter(":checked").val();this._$rowsContainer.setVisible(mode!=="always")}})})();"use strict";(function(){var ParentView=Djblets.Forms.BaseConditionValueFieldView;Djblets.Forms.ConditionValueFormFieldView=ParentView.extend({render:function render(){ParentView.prototype.render.call(this);this.$input=this.$el.children().attr("name",this.model.get("fieldName"));return this},setValue:function setValue(value){this.$input.val(value)},getValue:function getValue(value){return this.$input.val()}})})();"use strict";(function(){var entryTemplate=_.template('<li class="djblets-c-list-edit-widget__entry"\n    data-list-index="<%- index %>">\n <input type="text"<%= inputAttrs %>>\n <a href="#" class="djblets-c-list-edit-widget__remove-item"\n    role="button" title="<%- removeText %>">\n   <span class="fa fa-times"></span>\n </a>\n</li>');Djblets.Forms.ListEditView=Backbone.View.extend({events:{"click .djblets-c-list-edit-widget__add-item":"_addItem","click .djblets-c-list-edit-widget__remove-item":"_removeItem","blur .djblets-c-list-edit-widget__input":"_onBlur"},initialize:function initialize(options){this._inputAttrs=options.inputAttrs;this._removeText=options.removeText;this._sep=options.sep;this._values=[]},render:function render(){var _this=this;this.$el.data("djblets-list-edit-view",this);this._$list=this.$el.children(".djblets-c-list-edit-widget__entries");this._$list.find(".djblets-c-list-edit-widget__input").each(function(idx,el){return _this._values.push($(el).val())});this._$addBtn=this.$el.children(".djblets-c-list-edit-widget__add-item");this._$hidden=this.$el.children(".djblets-c-list-edit-widget__value");return this},_addItem:function _addItem(e){var _this2=this;e.preventDefault();e.stopPropagation();var $entry=$(entryTemplate({index:this._values.length,inputAttrs:this._inputAttrs,removeText:this._removeText})).insertBefore(this._$addBtn);$entry.find(".djblets-c-list-edit-widget__add-item").on("click",function(e){return _this2._addItem(e)}).end().find(".djblets-c-list-edit-widget__input").on("change",function(e){return _this2._onBlur(e)}).end();this._values.push("")},_removeItem:function _removeItem(e){e.preventDefault();e.stopPropagation();var $target=$(e.target);var $entry=$target.closest(".djblets-c-list-edit-widget__entry");var index=$entry.attr("data-list-index");if(this._values.length>1){$entry.remove();this._values.splice(index,1);this._$list.find(".djblets-c-list-edit-widget__entry").each(function(idx,el){return $(el).attr("data-list-index",idx)})}else{this._values[index]="";$target.siblings(".djblets-c-list-edit-widget__input").val("")}this._$hidden.val(this._values.filter(function(v){return v.length>0}).join(this._sep))},_onBlur:function _onBlur(e){var $target=$(e.target);var index=$target.closest(".djblets-c-list-edit-widget__entry").attr("data-list-index");this._values[index]=$target.val();this._$hidden.val(this._values.filter(function(v){return v.length>0}).join(this._sep))}})})();"use strict";Djblets.Forms.PrivacyConsentFieldView=Backbone.View.extend({events:{"change input":"_onConsentChanged"},initialize:function initialize(options){this.options=options;var $choices=this.$(".privacy-consent-field-choices");var $allowChoice=$choices.find(".privacy-consent-field-choice-allow");var $blockChoice=$choices.find(".privacy-consent-field-choice-block");this._$allowInput=$allowChoice.children("input");this._$allowLabel=$allowChoice.children("label");this._$blockInput=$blockChoice.children("input");this._$blockLabel=$blockChoice.children("label")},render:function render(){this._onConsentChanged();return this},_onConsentChanged:function _onConsentChanged(){var allowed=this._$allowInput.is(":checked");var blocked=this._$blockInput.is(":checked");this.$el.toggleClass("privacy-consent-field-allow",allowed);this.$el.toggleClass("privacy-consent-field-block",blocked);this._$allowLabel.text(allowed?this.options.allowedText:this.options.allowText);this._$blockLabel.text(blocked?this.options.blockedText:this.options.blockText)}})}).call(this);
